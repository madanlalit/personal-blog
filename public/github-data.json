{
  "lastUpdated": 1770496547951,
  "events": [
    {
      "id": "6395740399",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1103643573,
        "name": "openai/skills",
        "url": "https://api.github.com/repos/openai/skills"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-07T18:25:39Z",
      "org": {
        "id": 14957082,
        "login": "openai",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/openai",
        "avatar_url": "https://avatars.githubusercontent.com/u/14957082?"
      }
    },
    {
      "id": "6390326539",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3766686127,
          "node_id": "PRR_kwDOMMa-Ps7ggxGv",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "submitted_at": "2026-02-07T08:16:28Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766686127",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766686127"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-02-07T08:16:28Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-02-07T08:16:29Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6390326334",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777251772",
          "pull_request_review_id": 3766686127,
          "id": 2777251772,
          "node_id": "PRRC_kwDOMMa-Ps6liX-8",
          "diff_hunk": "@@ -438,6 +440,7 @@ class ModelRequestNode(AgentNode[DepsT, NodeRunEndT]):\n     \"\"\"The node that makes a request to the model using the last message in state.message_history.\"\"\"\n \n     request: _messages.ModelRequest\n+    reuse_history_request: bool = False",
          "path": "pydantic_ai_slim/pydantic_ai/_agent_graph.py",
          "commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "original_commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "I added that flag to detect if we reusing  message_history instead of a new prompt.\r\nIn that case the new_message would start after the processed history i.e at ModelRequest which is len(message_history).\r\nBut I removed it and made it simpler since it was a public field and added reused_history_request in _prepare_request to do the same.",
          "created_at": "2026-02-07T08:16:27Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777251772",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777251772"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777251772"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777251772/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2776415054,
          "original_position": 29,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-02-07T08:16:27Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6390078138",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3766570186,
          "node_id": "PRR_kwDOMMa-Ps7ggUzK",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "submitted_at": "2026-02-07T07:41:46Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766570186",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766570186"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-02-07T07:41:46Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-02-07T07:41:49Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6390077886",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777223286",
          "pull_request_review_id": 3766570186,
          "id": 2777223286,
          "node_id": "PRRC_kwDOMMa-Ps6liRB2",
          "diff_hunk": "@@ -216,7 +220,7 @@ def process_previous_answers(messages: list[ModelMessage]) -> list[ModelMessage]\n             ),\n         ]\n     )\n-    assert result.new_messages() == result.all_messages()[-2:]\n+    assert result.new_messages() == result.all_messages()",
          "path": "tests/test_history_processor.py",
          "commit_id": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
          "original_commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "Flow for test_history_processor_streaming_replaces_message_history\r\n\r\nInitial message_history (from previous runs):\r\n[Q1, A1, Q2, A2]\r\n\r\nCurrent run adds user prompt:\r\nQ3\r\n\r\nHistory processor output (messages[-1:] + ProcessedAnswer):\r\n[Q3, ProcessedAnswer]\r\n(old history is intentionally replaced)\r\n\r\nWhat is sent to the model (received_messages):\r\nmerged request containing Q3 + ProcessedAnswer\r\n\r\nFinal run result (all_messages()):\r\n[Q3, ProcessedAnswer, hello]\r\n\r\nExpected new_messages():\r\n[Q3, ProcessedAnswer, hello] (same as all_messages())\r\n\r\nWhy: after processing, the new_messages starts at current-run messages, so Q3 is also new.\r\nUsing all_messages()[-2:] would wrongly drop Q3.",
          "created_at": "2026-02-07T07:41:46Z",
          "updated_at": "2026-02-07T07:41:47Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777223286",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777223286"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777223286"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777223286/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2776433084,
          "original_position": 39,
          "position": 39,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-02-07T07:41:46Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "8220895566",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30515841425,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
        "before": "e068779950e0e9d335b316df3b6d6504c5162a39"
      },
      "public": true,
      "created_at": "2026-02-07T06:57:36Z"
    },
    {
      "id": "6389685132",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3766489202,
          "node_id": "PRR_kwDOMMa-Ps7ggBBy",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "submitted_at": "2026-02-07T06:56:59Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766489202",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766489202"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-02-07T06:56:59Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-02-07T06:57:00Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389684870",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777186273",
          "pull_request_review_id": 3766489202,
          "id": 2777186273,
          "node_id": "PRRC_kwDOMMa-Ps6liH_h",
          "diff_hunk": "@@ -1402,6 +1411,14 @@ async def _process_message_history(\n     return messages\n \n \n+def _first_run_id_index(messages: list[_messages.ModelMessage], run_id: str) -> int:\n+    \"\"\"Return the index of the first message for the current run, or len(messages) if none are found.\"\"\"\n+    for index, message in enumerate(messages):\n+        if getattr(message, 'run_id', None) == run_id:",
          "path": "pydantic_ai_slim/pydantic_ai/_agent_graph.py",
          "commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "original_commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "made the changes",
          "created_at": "2026-02-07T06:56:59Z",
          "updated_at": "2026-02-07T06:57:00Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777186273",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777186273"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777186273"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777186273/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2776415414,
          "original_position": 58,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-02-07T06:56:59Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389654423",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777179836",
          "pull_request_review_id": 3766480094,
          "id": 2777179836,
          "node_id": "PRRC_kwDOMMa-Ps6liGa8",
          "diff_hunk": "@@ -216,7 +220,7 @@ def process_previous_answers(messages: list[ModelMessage]) -> list[ModelMessage]\n             ),\n         ]\n     )\n-    assert result.new_messages() == result.all_messages()[-2:]\n+    assert result.new_messages() == result.all_messages()",
          "path": "tests/test_history_processor.py",
          "commit_id": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
          "original_commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "Keeping this assertion intentionally. In this scenario, after history processing, the processed history is all current-run messages, so `new_messages()` should equal `all_messages()`. Using `all_messages()[-2:]` would incorrectly drop current-run request messages.",
          "created_at": "2026-02-07T06:53:22Z",
          "updated_at": "2026-02-07T06:53:22Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777179836",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777179836"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777179836"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777179836/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2776433084,
          "original_position": 39,
          "position": 39,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-02-07T06:53:22Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389654398",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3766480094,
          "node_id": "PRR_kwDOMMa-Ps7gf-ze",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "e068779950e0e9d335b316df3b6d6504c5162a39",
          "submitted_at": "2026-02-07T06:53:22Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766480094",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766480094"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-02-07T06:53:22Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-02-07T06:53:23Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389651931",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777179174",
          "pull_request_review_id": 3766478828,
          "id": 2777179174,
          "node_id": "PRRC_kwDOMMa-Ps6liGQm",
          "diff_hunk": "@@ -879,3 +890,378 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    \"\"\"\n+    Test flow:\n+    1. Start with [UserPrompt('start')] (Length 1)\n+    2. Model calls tool -> History: [UserPrompt('start'), ModelResponse(ToolCall), ModelRequest(ToolReturn)] (Length 3)\n+    3. Pruning (keep_last_2) removes UserPrompt('start') -> History: [ModelResponse(ToolCall), ModelRequest(ToolReturn)]\n+    4. Model returns 'done' -> Final: [ModelResponse(ToolCall), ModelRequest(ToolReturn), ModelResponse('done')]\n+    \"\"\"\n+\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    call_count = 0\n+\n+    def model_function(messages: list[ModelMessage], _info: AgentInfo) -> ModelResponse:\n+        nonlocal call_count\n+        call_count += 1\n+        if call_count == 1:\n+            return ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id='tool_call_1')],\n+            )\n+        return ModelResponse(parts=[TextPart(content='done')])\n+\n+    agent = Agent(model=FunctionModel(model_function, model_name='test'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    with capture_run_messages() as captured_messages:\n+        async with agent.iter('start') as run:\n+            async for _ in run:\n+                idx = run.ctx.deps.new_message_index\n+                assert idx >= 0, (\n+                    f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+                )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id=IsStr())],\n+                usage=RequestUsage(input_tokens=51, output_tokens=2),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    ToolReturnPart(\n+                        tool_name='my_tool',\n+                        content='tool executed',\n+                        tool_call_id=IsStr(),\n+                        timestamp=IsDatetime(),\n+                    )\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='done')],\n+                usage=RequestUsage(input_tokens=52, output_tokens=3),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+    assert result.new_messages() == result.all_messages()\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning_and_history():\n+    \"\"\"\n+    Test flow with history:\n+    1. Start with [OldMsg1, OldResp1, UserPrompt('start')] (Length 3)\n+    2. Pruning (keep_last_2) removes OldMsg1 -> History: [OldResp1, UserPrompt('start')]\n+    3. Model calls tool -> History: [OldResp1, UserPrompt('start'), ModelResponse(ToolCall), ModelRequest(ToolReturn)] (Length 4)\n+    4. Pruning removes OldResp1 and UserPrompt('start') -> History: [ModelResponse(ToolCall), ModelRequest(ToolReturn)]\n+    5. Model returns 'done' -> Final: [ModelResponse(ToolCall), ModelRequest(ToolReturn), ModelResponse('done')]\n+    \"\"\"\n+\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    call_count = 0\n+\n+    def model_function(messages: list[ModelMessage], _info: AgentInfo) -> ModelResponse:\n+        nonlocal call_count\n+        call_count += 1\n+        if call_count == 1:\n+            return ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id='tool_call_1')],\n+            )\n+        return ModelResponse(parts=[TextPart(content='done')])\n+\n+    agent = Agent(model=FunctionModel(model_function, model_name='test'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old message 1')]),\n+        ModelResponse(parts=[TextPart(content='Old response 1')]),\n+    ]\n+\n+    with capture_run_messages() as captured_messages:\n+        async with agent.iter('start', message_history=history) as run:\n+            async for _ in run:\n+                idx = run.ctx.deps.new_message_index\n+                assert idx >= 0, (\n+                    f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+                )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id=IsStr())],\n+                usage=RequestUsage(input_tokens=51, output_tokens=5),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    ToolReturnPart(\n+                        tool_name='my_tool',\n+                        content='tool executed',\n+                        tool_call_id=IsStr(),\n+                        timestamp=IsDatetime(),\n+                    )\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='done')],\n+                usage=RequestUsage(input_tokens=52, output_tokens=3),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+    assert result.new_messages() == result.all_messages()\n+\n+\n+async def test_history_processor_reorder_old_new(function_model: FunctionModel, received_messages: list[ModelMessage]):\n+    \"\"\"\n+    Test flow:\n+    1. Start with history: [ModelRequest('Old question')]\n+    2. User adds: 'New question' -> Internal history: [ModelRequest('Old'), ModelRequest('New')]\n+    3. Processor `swap_last_two` swaps them -> Internal history: [ModelRequest('New'), ModelRequest('Old')]\n+    4. Model generates response -> Final history: [ModelRequest('New'), ModelRequest('Old'), ModelResponse('Provider response')]\n+    5. `new_messages()` should only return messages from this run: [ModelRequest('New'), ModelRequest('Old'), ModelResponse('Provider response')]\n+    \"\"\"\n+\n+    def swap_last_two(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        if len(messages) >= 2:\n+            return messages[:-2] + [messages[-1], messages[-2]]\n+        return messages\n+\n+    assert swap_last_two([]) == []\n+\n+    agent = Agent(function_model, history_processors=[swap_last_two])\n+\n+    message_history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old question')]),\n+    ]\n+\n+    with capture_run_messages() as captured_messages:\n+        result = await agent.run('New question', message_history=message_history)\n+\n+    assert received_messages == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+            )\n+        ]\n+    )\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='Provider response')],\n+                usage=RequestUsage(input_tokens=54, output_tokens=2),\n+                model_name='function:capture_model_function:capture_model_stream_function',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+\n+    new_msgs = result.new_messages()\n+\n+    assert new_msgs == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='Provider response')],\n+                usage=RequestUsage(input_tokens=54, output_tokens=2),\n+                model_name='function:capture_model_function:capture_model_stream_function',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )",
          "path": "tests/test_history_processor.py",
          "commit_id": "e068779950e0e9d335b316df3b6d6504c5162a39",
          "original_commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "Simplified as suggested: the redundant `new_msgs` snapshots are replaced with direct comparisons (`new_msgs == result.all_messages()` and suffix check via `result.all_messages()[1:]`).",
          "created_at": "2026-02-07T06:53:07Z",
          "updated_at": "2026-02-07T06:53:08Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777179174",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777179174"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777179174"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777179174/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2776416556,
          "original_position": 350,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-02-07T06:53:07Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389651930",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3766478828,
          "node_id": "PRR_kwDOMMa-Ps7gf-fs",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "e068779950e0e9d335b316df3b6d6504c5162a39",
          "submitted_at": "2026-02-07T06:53:08Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766478828",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766478828"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-02-07T06:53:08Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-02-07T06:53:08Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389645239",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777177443",
          "pull_request_review_id": 3766475948,
          "id": 2777177443,
          "node_id": "PRRC_kwDOMMa-Ps6liF1j",
          "diff_hunk": "@@ -879,3 +890,378 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    \"\"\"\n+    Test flow:\n+    1. Start with [UserPrompt('start')] (Length 1)\n+    2. Model calls tool -> History: [UserPrompt('start'), ModelResponse(ToolCall), ModelRequest(ToolReturn)] (Length 3)\n+    3. Pruning (keep_last_2) removes UserPrompt('start') -> History: [ModelResponse(ToolCall), ModelRequest(ToolReturn)]\n+    4. Model returns 'done' -> Final: [ModelResponse(ToolCall), ModelRequest(ToolReturn), ModelResponse('done')]\n+    \"\"\"\n+\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    call_count = 0\n+\n+    def model_function(messages: list[ModelMessage], _info: AgentInfo) -> ModelResponse:\n+        nonlocal call_count\n+        call_count += 1\n+        if call_count == 1:\n+            return ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id='tool_call_1')],\n+            )\n+        return ModelResponse(parts=[TextPart(content='done')])\n+\n+    agent = Agent(model=FunctionModel(model_function, model_name='test'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    with capture_run_messages() as captured_messages:\n+        async with agent.iter('start') as run:\n+            async for _ in run:\n+                idx = run.ctx.deps.new_message_index\n+                assert idx >= 0, (\n+                    f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+                )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id=IsStr())],\n+                usage=RequestUsage(input_tokens=51, output_tokens=2),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    ToolReturnPart(\n+                        tool_name='my_tool',\n+                        content='tool executed',\n+                        tool_call_id=IsStr(),\n+                        timestamp=IsDatetime(),\n+                    )\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='done')],\n+                usage=RequestUsage(input_tokens=52, output_tokens=3),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+    assert result.new_messages() == result.all_messages()\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning_and_history():\n+    \"\"\"\n+    Test flow with history:\n+    1. Start with [OldMsg1, OldResp1, UserPrompt('start')] (Length 3)\n+    2. Pruning (keep_last_2) removes OldMsg1 -> History: [OldResp1, UserPrompt('start')]\n+    3. Model calls tool -> History: [OldResp1, UserPrompt('start'), ModelResponse(ToolCall), ModelRequest(ToolReturn)] (Length 4)\n+    4. Pruning removes OldResp1 and UserPrompt('start') -> History: [ModelResponse(ToolCall), ModelRequest(ToolReturn)]\n+    5. Model returns 'done' -> Final: [ModelResponse(ToolCall), ModelRequest(ToolReturn), ModelResponse('done')]\n+    \"\"\"\n+\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    call_count = 0\n+\n+    def model_function(messages: list[ModelMessage], _info: AgentInfo) -> ModelResponse:\n+        nonlocal call_count\n+        call_count += 1\n+        if call_count == 1:\n+            return ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id='tool_call_1')],\n+            )\n+        return ModelResponse(parts=[TextPart(content='done')])\n+\n+    agent = Agent(model=FunctionModel(model_function, model_name='test'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old message 1')]),\n+        ModelResponse(parts=[TextPart(content='Old response 1')]),\n+    ]\n+\n+    with capture_run_messages() as captured_messages:\n+        async with agent.iter('start', message_history=history) as run:\n+            async for _ in run:\n+                idx = run.ctx.deps.new_message_index\n+                assert idx >= 0, (\n+                    f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+                )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelResponse(\n+                parts=[ToolCallPart(tool_name='my_tool', args={}, tool_call_id=IsStr())],\n+                usage=RequestUsage(input_tokens=51, output_tokens=5),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    ToolReturnPart(\n+                        tool_name='my_tool',\n+                        content='tool executed',\n+                        tool_call_id=IsStr(),\n+                        timestamp=IsDatetime(),\n+                    )\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='done')],\n+                usage=RequestUsage(input_tokens=52, output_tokens=3),\n+                model_name='test',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+    assert result.new_messages() == result.all_messages()\n+\n+\n+async def test_history_processor_reorder_old_new(function_model: FunctionModel, received_messages: list[ModelMessage]):\n+    \"\"\"\n+    Test flow:\n+    1. Start with history: [ModelRequest('Old question')]\n+    2. User adds: 'New question' -> Internal history: [ModelRequest('Old'), ModelRequest('New')]\n+    3. Processor `swap_last_two` swaps them -> Internal history: [ModelRequest('New'), ModelRequest('Old')]\n+    4. Model generates response -> Final history: [ModelRequest('New'), ModelRequest('Old'), ModelResponse('Provider response')]\n+    5. `new_messages()` should only return messages from this run: [ModelRequest('New'), ModelRequest('Old'), ModelResponse('Provider response')]\n+    \"\"\"\n+\n+    def swap_last_two(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        if len(messages) >= 2:\n+            return messages[:-2] + [messages[-1], messages[-2]]\n+        return messages\n+\n+    assert swap_last_two([]) == []\n+\n+    agent = Agent(function_model, history_processors=[swap_last_two])\n+\n+    message_history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old question')]),\n+    ]\n+\n+    with capture_run_messages() as captured_messages:\n+        result = await agent.run('New question', message_history=message_history)\n+\n+    assert received_messages == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+            )\n+        ]\n+    )\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='Provider response')],\n+                usage=RequestUsage(input_tokens=54, output_tokens=2),\n+                model_name='function:capture_model_function:capture_model_stream_function',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+\n+    new_msgs = result.new_messages()\n+\n+    assert new_msgs == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='Provider response')],\n+                usage=RequestUsage(input_tokens=54, output_tokens=2),\n+                model_name='function:capture_model_function:capture_model_stream_function',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+\n+\n+async def test_history_processor_injects_into_new_stream(\n+    function_model: FunctionModel, received_messages: list[ModelMessage]\n+):\n+    \"\"\"\n+    Test flow:\n+    1. Start with history: [ModelRequest('Old')]\n+    2. User adds: 'New question' -> Internal history: [ModelRequest('Old'), ModelRequest('New')]\n+    3. Processor `inject_middle` inserts 'Inserted' before the last message(which is the first message of current run) -> Internal history: [ModelRequest('Old'), ModelRequest('Inserted'), ModelRequest('New')]\n+    4. Model generates response -> Final history: [ModelRequest('Old'), ModelRequest('Inserted'), ModelRequest('New'), ModelResponse('Provider response')]\n+    5. `new_messages()` should return messages from this run. [ModelRequest('Inserted'), ModelRequest('New'), ModelResponse('Provider response')]\n+    \"\"\"\n+\n+    def inject_middle(ctx: RunContext[Any], messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return (\n+            messages[:-1]\n+            + [ModelRequest(parts=[UserPromptPart(content='Inserted')], run_id=ctx.run_id)]\n+            + messages[-1:]\n+        )\n+\n+    agent = Agent(function_model, history_processors=[inject_middle])\n+\n+    message_history = [ModelRequest(parts=[UserPromptPart(content='Old')])]\n+\n+    with capture_run_messages() as captured_messages:\n+        result = await agent.run('New question', message_history=message_history)\n+\n+    assert received_messages == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Old', timestamp=IsDatetime()),\n+                    UserPromptPart(content='Inserted', timestamp=IsDatetime()),\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+            )\n+        ]\n+    )\n+\n+    assert captured_messages == result.all_messages()\n+    assert result.all_messages() == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Old', timestamp=IsDatetime()),\n+                ]\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Inserted', timestamp=IsDatetime()),\n+                ],\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='Provider response')],\n+                usage=RequestUsage(input_tokens=54, output_tokens=2),\n+                model_name='function:capture_model_function:capture_model_stream_function',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+\n+    new_msgs = result.new_messages()\n+    # Expected behavior: Messages injected by history processor before the first message of the current run should always have a run_id\n+    # 'Inserted' was injected by the processor, 'New question' is from this run\n+    assert new_msgs == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='Inserted', timestamp=IsDatetime()),\n+                ],\n+                run_id=IsStr(),\n+            ),\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+            ModelResponse(\n+                parts=[TextPart(content='Provider response')],\n+                usage=RequestUsage(input_tokens=54, output_tokens=2),\n+                model_name='function:capture_model_function:capture_model_stream_function',\n+                timestamp=IsDatetime(),\n+                run_id=IsStr(),\n+            ),\n+        ]\n+    )\n+\n+\n+async def test_history_processor_overrides_run_id_uses_response_as_new_messages(function_model: FunctionModel):\n+    \"\"\"\n+    If a history processor overwrites all run_id values, `_first_run_id_index` should fall back to `len(messages)`,\n+    meaning `new_messages()` only includes messages appended after processing (the model response).\n+    \"\"\"\n+\n+    def override_run_id(ctx: RunContext[Any], messages: list[ModelMessage]) -> list[ModelMessage]:\n+        override = f'{ctx.run_id}-override'\n+        for message in messages:\n+            message.run_id = override\n+        return messages\n+\n+    agent = Agent(function_model, history_processors=[override_run_id])\n+\n+    message_history = [ModelRequest(parts=[UserPromptPart(content='Old')])]\n+\n+    with capture_run_messages() as captured_messages:\n+        result = await agent.run('New question', message_history=message_history)\n+\n+    assert captured_messages == result.all_messages()\n+\n+    response_run_id = result.all_messages()[-1].run_id\n+    assert response_run_id is not None\n+    assert all(getattr(message, 'run_id', None) != response_run_id for message in result.all_messages()[:-1])",
          "path": "tests/test_history_processor.py",
          "commit_id": "e068779950e0e9d335b316df3b6d6504c5162a39",
          "original_commit_id": "8bd574bea9c495a725ddb9a760319a8198addfda",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "updated to direct attribute access (`message.run_id`) here, so we no longer use `getattr`.",
          "created_at": "2026-02-07T06:52:25Z",
          "updated_at": "2026-02-07T06:52:58Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777177443",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777177443"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2777177443"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2777177443/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2776416262,
          "original_position": 475,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-02-07T06:52:25Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6389645233",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3766475948,
          "node_id": "PRR_kwDOMMa-Ps7gf9ys",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "e068779950e0e9d335b316df3b6d6504c5162a39",
          "submitted_at": "2026-02-07T06:52:25Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766475948",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3766475948"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-02-07T06:52:25Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-02-07T06:52:26Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "8220656040",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30515600958,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "e068779950e0e9d335b316df3b6d6504c5162a39",
        "before": "8bd574bea9c495a725ddb9a760319a8198addfda"
      },
      "public": true,
      "created_at": "2026-02-07T06:38:28Z"
    },
    {
      "id": "6383005654",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132942317,
        "name": "madanlalit/agentskills",
        "url": "https://api.github.com/repos/madanlalit/agentskills"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-06T20:44:42Z"
    },
    {
      "id": "6383003817",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-06T20:44:37Z"
    },
    {
      "id": "6383002236",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-06T20:44:32Z"
    },
    {
      "id": "8211616498",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1115612558,
        "name": "madanlalit/personal-blog",
        "url": "https://api.github.com/repos/madanlalit/personal-blog"
      },
      "payload": {
        "repository_id": 1115612558,
        "push_id": 30506544715,
        "ref": "refs/heads/main",
        "head": "b4556accdfb7db93fd48eb1e51f2b7c15d305726",
        "before": "4c643e4bbf078280cee94e8e4a21ba639ce32c42"
      },
      "public": true,
      "created_at": "2026-02-06T20:41:44Z"
    },
    {
      "id": "8211512457",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1115612558,
        "name": "madanlalit/personal-blog",
        "url": "https://api.github.com/repos/madanlalit/personal-blog"
      },
      "payload": {
        "repository_id": 1115612558,
        "push_id": 30506440572,
        "ref": "refs/heads/main",
        "head": "389e44ff6f933e52dae1d76793e2032ae886e07c",
        "before": "90f6e37db0a4dc9ecce4a8dadb8bf65f2ba4ac0a"
      },
      "public": true,
      "created_at": "2026-02-06T20:37:08Z"
    },
    {
      "id": "6375759386",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1147094660,
        "name": "HKUDS/nanobot",
        "url": "https://api.github.com/repos/HKUDS/nanobot"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-06T15:28:36Z",
      "org": {
        "id": 118165258,
        "login": "HKUDS",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/HKUDS",
        "avatar_url": "https://avatars.githubusercontent.com/u/118165258?"
      }
    },
    {
      "id": "6362399714",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 646426100,
        "name": "pydantic/monty",
        "url": "https://api.github.com/repos/pydantic/monty"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-06T06:27:44Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "8177000732",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "repository_id": 1146778009,
        "push_id": 30471878891,
        "ref": "refs/heads/main",
        "head": "0acd78415c480faa30f8a30e10789cec2338f825",
        "before": "32f49f8c2ce7f9800d158ad7912af244178a0b5e"
      },
      "public": true,
      "created_at": "2026-02-05T20:47:30Z"
    },
    {
      "id": "8176723941",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "repository_id": 1146778009,
        "push_id": 30471634009,
        "ref": "refs/heads/main",
        "head": "32f49f8c2ce7f9800d158ad7912af244178a0b5e",
        "before": "31de7bd1daa948e4a64dc9d87a262d3e6c902289"
      },
      "public": true,
      "created_at": "2026-02-05T20:38:02Z"
    },
    {
      "id": "8176168553",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "repository_id": 1146778009,
        "push_id": 30469773971,
        "ref": "refs/heads/main",
        "head": "31de7bd1daa948e4a64dc9d87a262d3e6c902289",
        "before": "e683667e108ac483e518c2d57a35f6c77133d222"
      },
      "public": true,
      "created_at": "2026-02-05T19:28:22Z"
    },
    {
      "id": "8174225512",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "repository_id": 1146778009,
        "push_id": 30469470800,
        "ref": "refs/heads/main",
        "head": "e683667e108ac483e518c2d57a35f6c77133d222",
        "before": "8ff71ac8de7d93ef6abf59f4c34c8cfe1e9c2dac"
      },
      "public": true,
      "created_at": "2026-02-05T19:16:50Z"
    },
    {
      "id": "6342401106",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3854037451",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3854037451",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3854037451,
          "node_id": "IC_kwDOMMa-Ps7lt_HL",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-02-05T14:27:58Z",
          "updated_at": "2026-02-05T14:27:58Z",
          "body": "@DouweM Please review the changes and tests.\r\nIve updated the assertions for two test cases, as I believe the new_messages were returning the incorrect messages.\r\nI've updated the PR description too.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3854037451/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-02-05T14:27:58Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6329055676",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 839037098,
        "name": "mastra-ai/mastra",
        "url": "https://api.github.com/repos/mastra-ai/mastra"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-05T05:54:32Z",
      "org": {
        "id": 149120496,
        "login": "mastra-ai",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/mastra-ai",
        "avatar_url": "https://avatars.githubusercontent.com/u/149120496?"
      }
    },
    {
      "id": "8139343192",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30434224716,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "8bd574bea9c495a725ddb9a760319a8198addfda",
        "before": "577d008633047bcbc86f22995308965d25eb7089"
      },
      "public": true,
      "created_at": "2026-02-04T20:13:59Z"
    },
    {
      "id": "8138756315",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30433636211,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "577d008633047bcbc86f22995308965d25eb7089",
        "before": "897be0b95643a792b9e58aea087483a4f2d5cb45"
      },
      "public": true,
      "created_at": "2026-02-04T19:51:45Z"
    },
    {
      "id": "8136513571",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30431389766,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "897be0b95643a792b9e58aea087483a4f2d5cb45",
        "before": "fe4399dc995c252a4abe2062457226700bb5c3cc"
      },
      "public": true,
      "created_at": "2026-02-04T18:29:25Z"
    },
    {
      "id": "8136134513",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30431009847,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "fe4399dc995c252a4abe2062457226700bb5c3cc",
        "before": "0a232763b2b11ba5fb23b46fe6aa4229df263ca5"
      },
      "public": true,
      "created_at": "2026-02-04T18:15:32Z"
    },
    {
      "id": "8135816965",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30430690742,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "0a232763b2b11ba5fb23b46fe6aa4229df263ca5",
        "before": "22d94733cef0474a024825a5659bc6d355dd8cc7"
      },
      "public": true,
      "created_at": "2026-02-04T18:03:59Z"
    },
    {
      "id": "8134638153",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30429518505,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "22d94733cef0474a024825a5659bc6d355dd8cc7",
        "before": "260030777e29e752a0ebb7650761385d46458477"
      },
      "public": true,
      "created_at": "2026-02-04T17:23:00Z"
    },
    {
      "id": "8132994636",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30427893126,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "260030777e29e752a0ebb7650761385d46458477",
        "before": "b139a6cacae6624f61ca69a7d18ed086029b4a17"
      },
      "public": true,
      "created_at": "2026-02-04T16:29:37Z"
    },
    {
      "id": "6283167917",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1000945946,
        "name": "cnoe-io/ai-platform-engineering",
        "url": "https://api.github.com/repos/cnoe-io/ai-platform-engineering"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-03T18:06:06Z",
      "org": {
        "id": 119980131,
        "login": "cnoe-io",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/cnoe-io",
        "avatar_url": "https://avatars.githubusercontent.com/u/119980131?"
      }
    },
    {
      "id": "8085978154",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30380848161,
        "ref": "refs/heads/main",
        "head": "d0d24ec44ddbefa68bc228d48d788797c1b23376",
        "before": "5ab6940f7f0231dc1fc62ab16dea35de018ceebc"
      },
      "public": true,
      "created_at": "2026-02-03T11:54:47Z"
    },
    {
      "id": "6240079445",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 798597319,
        "name": "togethercomputer/together-typescript",
        "url": "https://api.github.com/repos/togethercomputer/together-typescript"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-02T11:26:06Z",
      "org": {
        "id": 109101822,
        "login": "togethercomputer",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/togethercomputer",
        "avatar_url": "https://avatars.githubusercontent.com/u/109101822?"
      }
    },
    {
      "id": "6240064453",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1143261428,
        "name": "cloudflare/moltworker",
        "url": "https://api.github.com/repos/cloudflare/moltworker"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-02T11:25:30Z",
      "org": {
        "id": 314135,
        "login": "cloudflare",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/cloudflare",
        "avatar_url": "https://avatars.githubusercontent.com/u/314135?"
      }
    },
    {
      "id": "6240063726",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1140828898,
        "name": "anthropics/knowledge-work-plugins",
        "url": "https://api.github.com/repos/anthropics/knowledge-work-plugins"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-02-02T11:25:27Z",
      "org": {
        "id": 76263028,
        "login": "anthropics",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/anthropics",
        "avatar_url": "https://avatars.githubusercontent.com/u/76263028?"
      }
    },
    {
      "id": "6224710852",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3831718645",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3831718645",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3831718645,
          "node_id": "IC_kwDOMMa-Ps7kY2L1",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-02-01T18:30:00Z",
          "updated_at": "2026-02-01T18:31:43Z",
          "body": "@DouweM \r\nI had few questions to clarify\r\n- are messages modified / inserted by history processor should be included in new_messages in the current run ? even if they are trying to inject messages from message_history from previous run? Example : Taking message_history as input summarizing it and then injecting it before the first prompt ? In this case even though it came from message history since it was injected in this run should we include it in new_messages?\r\n- My assumption is new_messages should be any message generated during the current run (is the expectation correct ?)",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3831718645/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-02-01T18:30:00Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "8027380450",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30322226067,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "b139a6cacae6624f61ca69a7d18ed086029b4a17",
        "before": "8ba16a18b55edc59726d591cd54319e13d489cc8"
      },
      "public": true,
      "created_at": "2026-02-01T17:13:29Z"
    },
    {
      "id": "8027375997",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30322221584,
        "ref": "refs/heads/main",
        "head": "5ab6940f7f0231dc1fc62ab16dea35de018ceebc",
        "before": "94a47b111e1e694dae90f429b1cd5443cccf646a"
      },
      "public": true,
      "created_at": "2026-02-01T17:13:12Z"
    },
    {
      "id": "8009383314",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "repository_id": 1146778009,
        "push_id": 30304146874,
        "ref": "refs/heads/main",
        "head": "8ff71ac8de7d93ef6abf59f4c34c8cfe1e9c2dac",
        "before": "cb3e53d088cd4fc97ebd25d9d8042e221430a5a1"
      },
      "public": true,
      "created_at": "2026-01-31T19:31:17Z"
    },
    {
      "id": "8008913046",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "repository_id": 1146778009,
        "push_id": 30303673757,
        "ref": "refs/heads/main",
        "head": "cb3e53d088cd4fc97ebd25d9d8042e221430a5a1",
        "before": "50b8bef8288c3ba9fb84a23601d6aec205642c21"
      },
      "public": true,
      "created_at": "2026-01-31T18:59:13Z"
    },
    {
      "id": "8007190239",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1146778009,
        "name": "madanlalit/odin",
        "url": "https://api.github.com/repos/madanlalit/odin"
      },
      "payload": {
        "ref": "main",
        "ref_type": "branch",
        "full_ref": "refs/heads/main",
        "master_branch": "main",
        "description": "Odin is an AI Agent that can see your screen and click, type, and scroll to help do computer tasks for you.",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-31T17:05:25Z"
    },
    {
      "id": "6210181105",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 21961171,
        "name": "asweigart/pyautogui",
        "url": "https://api.github.com/repos/asweigart/pyautogui"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-31T14:51:19Z"
    },
    {
      "id": "6209610576",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3828551632",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3828551632",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3828551632,
          "node_id": "IC_kwDOMMa-Ps7kMw_Q",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-31T13:44:08Z",
          "updated_at": "2026-01-31T13:44:08Z",
          "body": "@adtyavrdhn Do you want to discuss the implementation?",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3828551632/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-31T13:44:08Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7996912654",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30291622673,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "8ba16a18b55edc59726d591cd54319e13d489cc8",
        "before": "6f734a97612d5b809c3adae3d8b5df27bd697cfb"
      },
      "public": true,
      "created_at": "2026-01-31T05:12:27Z"
    },
    {
      "id": "6205353975",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3827521992",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3827521992",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3827521992,
          "node_id": "IC_kwDOMMa-Ps7kI1nI",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-31T05:11:21Z",
          "updated_at": "2026-01-31T05:14:30Z",
          "body": "> @madanlalit Nope the newly added tests should pass? I am not sure I understand why would they fail? If any of those are negative tests then you can add xfailed but otherwise it should pass.\r\n\r\nwill add xfailed to the failing tests ",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3827521992/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-31T05:11:21Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6204881580",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3827417182",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3827417182",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3827417182,
          "node_id": "IC_kwDOMMa-Ps7kIcBe",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-31T04:07:09Z",
          "updated_at": "2026-01-31T04:07:09Z",
          "body": "@DouweM \r\nThe CI is failing because of the newly added tests. Isn't that expected?",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3827417182/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-31T04:07:09Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6202691110",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974",
          "id": 3798319157,
          "node_id": "PR_kwDOMMa-Ps68ZvWM",
          "number": 3974,
          "title": "feat(ui): Add `html_source` parameter to customize Chat UI source",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547185,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/feature",
              "name": "feature",
              "color": "a2eeef",
              "default": false,
              "description": "New feature request, or PR implementing a feature (enhancement)"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9953318447,
              "node_id": "LA_kwDOMMa-Ps8AAAACUUOWLw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/uiadapter",
              "name": "uiadapter",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "closed",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 5,
          "created_at": "2026-01-09T20:51:39Z",
          "updated_at": "2026-01-31T00:22:26Z",
          "closed_at": "2026-01-31T00:20:30Z",
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/3974.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/3974.patch",
            "merged_at": "2026-01-31T00:20:30Z"
          },
          "body": "## Description\n\nAdds a `custom_cdn_url` parameter to the Web Chat UI to allow users to override the default CDN URL. This supports:\n1.  **Custom CDNs**: For enterprise environments where the default CDN is blocked.\n2.  **Static URLs**: For pre-deployed versions of the UI.\n3.  **Local File Paths**: For working offline or with local development builds of the UI.\n\nFixes #3953\n\n## Changes\n\n- Modified `pydantic_ai/ui/_web/app.py` to accept `custom_cdn_url` and handle local file paths.\n- Updated `pydantic_ai/agent/__init__.py` to expose the parameter in `Agent.to_web()`.\n- Updated `pydantic_ai/_cli/web.py` and `pydantic_ai/_cli/__init__.py` to add the `--custom-cdn-url` CLI argument.\n- Added comprehensive tests in `tests/test_ui_web.py` covering all new scenarios.\n- Updated documentation in `docs/web.md` and `docs/cli.md`.\n\n## Checklist\n\n- [x] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\n- [x] No **breaking changes** (parameter is optional and defaults to `None`).\n- [x] **Linting and type checking** pass.\n- [x] **PR title** is fit for the release changelog.\n- [x] New **tests** added, maintaining 100% coverage.\n- [x] Updated **documentation** for new features.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3826679956",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#issuecomment-3826679956",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974",
          "id": 3826679956,
          "node_id": "IC_kwDOMMa-Ps7kFoCU",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-31T00:22:26Z",
          "updated_at": "2026-01-31T00:22:26Z",
          "body": "@DouweM Thanks for merging this!\r\nOn to the next one.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3826679956/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-31T00:22:26Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6202659555",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "merged",
        "number": 3974,
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-31T00:20:30Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7992516677",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30287209676,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "2ef712f3a9d585597af3480182a36febee968b08",
        "before": "5f91ef6c4b8f5d9cc1399346b397aef5f08b8b27"
      },
      "public": true,
      "created_at": "2026-01-30T23:54:13Z"
    },
    {
      "id": "7992508257",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30287201276,
        "ref": "refs/heads/main",
        "head": "94a47b111e1e694dae90f429b1cd5443cccf646a",
        "before": "9760d1346783410fbc9027867dad7538f444d42c"
      },
      "public": true,
      "created_at": "2026-01-30T23:53:36Z"
    },
    {
      "id": "7992345506",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30287038140,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "5f91ef6c4b8f5d9cc1399346b397aef5f08b8b27",
        "before": "67e8034d87067a826e54c236523c8b8ef4d85201"
      },
      "public": true,
      "created_at": "2026-01-30T23:42:38Z"
    },
    {
      "id": "6201350744",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3730841481,
          "node_id": "PRR_kwDOMMa-Ps7eYB-J",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "ebfa6aad5e11657f379d90d30b6b4192ff58afb0",
          "submitted_at": "2026-01-30T23:01:50Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3730841481",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3730841481"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-30T23:01:50Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-30T23:01:51Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6201350317",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2748313572",
          "pull_request_review_id": 3730841481,
          "id": 2748313572,
          "node_id": "PRRC_kwDOMMa-Ps6jz-_k",
          "diff_hunk": "@@ -188,6 +188,7 @@ clai web --agent my_module:my_agent -i 'Always respond in Spanish'\n | `--instructions`, `-i` | System instructions. When `--agent` is specified, these are additional to the agent's existing instructions. |\n | `--host` | Host to bind server (default: 127.0.0.1) |\n | `--port` | Port to bind server (default: 7932) |\n+| `--html-path` | URL or file path for the chat UI HTML. |",
          "path": "docs/cli.md",
          "commit_id": "67e8034d87067a826e54c236523c8b8ef4d85201",
          "original_commit_id": "ebfa6aad5e11657f379d90d30b6b4192ff58afb0",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "@DouweM \r\nno worries \r\nhappy to help here ",
          "created_at": "2026-01-30T23:01:50Z",
          "updated_at": "2026-01-30T23:01:50Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2748313572",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2748313572"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2748313572"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2748313572/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2744011384,
          "original_position": 4,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-30T23:01:50Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6194372250",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "merged",
        "number": 26,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-30T17:12:16Z"
    },
    {
      "id": "6194372047",
      "type": "IssuesEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "closed",
        "issue": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/6",
          "repository_url": "https://api.github.com/repos/madanlalit/heimdall",
          "labels_url": "https://api.github.com/repos/madanlalit/heimdall/issues/6/labels{/name}",
          "comments_url": "https://api.github.com/repos/madanlalit/heimdall/issues/6/comments",
          "events_url": "https://api.github.com/repos/madanlalit/heimdall/issues/6/events",
          "html_url": "https://github.com/madanlalit/heimdall/issues/6",
          "id": 3764452462,
          "node_id": "I_kwDOQuIaMM7gYPxu",
          "number": 6,
          "title": "Add Groq LLM Provider Support",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [],
          "state": "closed",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 0,
          "created_at": "2025-12-27T06:13:55Z",
          "updated_at": "2026-01-30T17:12:17Z",
          "closed_at": "2026-01-30T17:12:17Z",
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "Add support for Groq as an LLM provider.\n\n**Location:** `src/heimdall/agent/llm/`\n\n**Tasks:**\n- Create `groq.py` with `GroqClient`\n- Register in provider registry",
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/6/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/madanlalit/heimdall/issues/6/timeline",
          "performed_via_github_app": null,
          "state_reason": "completed"
        }
      },
      "public": true,
      "created_at": "2026-01-30T17:12:18Z"
    },
    {
      "id": "7983521116",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30278210068,
        "ref": "refs/heads/main",
        "head": "8fec661d0517bf6cfc868e58595d0cb9ad923d88",
        "before": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a"
      },
      "public": true,
      "created_at": "2026-01-30T17:12:17Z"
    },
    {
      "id": "7964098777",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30258792958,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "67e8034d87067a826e54c236523c8b8ef4d85201",
        "before": "ebfa6aad5e11657f379d90d30b6b4192ff58afb0"
      },
      "public": true,
      "created_at": "2026-01-30T04:58:50Z"
    },
    {
      "id": "6177770776",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3726284733,
          "node_id": "PRR_kwDOMMa-Ps7eGpe9",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "badc867b085a752b4590eb562b7fcf1c9ae49bb3",
          "submitted_at": "2026-01-30T04:37:32Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3726284733",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3726284733"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-30T04:37:32Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-30T04:37:34Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6177770432",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2744570119",
          "pull_request_review_id": 3726284733,
          "id": 2744570119,
          "node_id": "PRRC_kwDOMMa-Ps6jltEH",
          "diff_hunk": "@@ -47,27 +47,63 @@ def _get_cache_dir() -> Path:\n     return cache_dir\n \n \n-def _sanitize_version(version: str) -> str:\n-    \"\"\"Sanitize version string for use as filename.\"\"\"\n-    return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n+async def _get_ui_html(html_path: str | Path | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from the specified source or default CDN.\n \n+    When html_path is provided, it is used directly.\n+    When html_path is None, fetches from the default CDN.\n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n-    cache_dir = _get_cache_dir()\n-    cache_file = cache_dir / f'{_sanitize_version(version)}.html'\n+    Args:\n+        html_path: Path or URL for the chat UI HTML. Can be:\n+            - None: Uses the default CDN (cached locally)\n+            - A Path instance: Reads from the local file\n+            - A URL (http:// or https://): Fetches from the URL\n+            - A file path string: Reads from the local file\n+    \"\"\"\n+    # Use default CDN with caching\n+    if html_path is None:\n+        cache_dir = _get_cache_dir()\n+        cache_file = cache_dir / f'{CHAT_UI_VERSION}.html'\n+\n+        if cache_file.exists():\n+            return cache_file.read_bytes()\n+\n+        async with httpx.AsyncClient() as client:\n+            response = await client.get(DEFAULT_HTML_URL)\n+            response.raise_for_status()\n+            content = response.content\n+\n+        cache_file.write_bytes(content)\n+        return content\n \n-    if cache_file.exists():\n-        return cache_file.read_bytes()\n+    # Handle Path instances\n+    if isinstance(html_path, Path):\n+        if html_path.is_file():\n+            return html_path.read_bytes()\n+        raise FileNotFoundError(f'Local UI file not found: {html_path}')",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "67e8034d87067a826e54c236523c8b8ef4d85201",
          "original_commit_id": "ebfa6aad5e11657f379d90d30b6b4192ff58afb0",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "will add this ",
          "created_at": "2026-01-30T04:37:32Z",
          "updated_at": "2026-01-30T04:37:32Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2744570119",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2744570119"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2744570119"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2744570119/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2743986728,
          "original_position": 66,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-30T04:37:32Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169656944",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "assigned",
        "number": 26,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "assignee": {
          "login": "madanlalit",
          "id": 116655920,
          "node_id": "U_kgDOBvQHMA",
          "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/madanlalit",
          "html_url": "https://github.com/madanlalit",
          "followers_url": "https://api.github.com/users/madanlalit/followers",
          "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
          "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
          "organizations_url": "https://api.github.com/users/madanlalit/orgs",
          "repos_url": "https://api.github.com/users/madanlalit/repos",
          "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
          "received_events_url": "https://api.github.com/users/madanlalit/received_events",
          "type": "User",
          "user_view_type": "public",
          "site_admin": false
        },
        "assignees": [
          {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          }
        ]
      },
      "public": true,
      "created_at": "2026-01-29T18:07:05Z"
    },
    {
      "id": "7953469601",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30248178520,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "8b1c74d845031fc1f45fe486d16596933fd46b2b",
        "before": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b"
      },
      "public": true,
      "created_at": "2026-01-29T20:10:54Z"
    },
    {
      "id": "6169507377",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3724774998,
          "node_id": "PRR_kwDOMMa-Ps7eA45W",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "submitted_at": "2026-01-29T20:07:13Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724774998",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724774998"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T20:07:13Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T20:07:14Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169507089",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743320294",
          "pull_request_review_id": 3724774998,
          "id": 2743320294,
          "node_id": "PRRC_kwDOMMa-Ps6jg77m",
          "diff_hunk": "@@ -188,6 +188,7 @@ clai web --agent my_module:my_agent -i 'Always respond in Spanish'\n | `--instructions`, `-i` | System instructions. When `--agent` is specified, these are additional to the agent's existing instructions. |\n | `--host` | Host to bind server (default: 127.0.0.1) |\n | `--port` | Port to bind server (default: 7932) |\n+| `--ui-source` | URL or file path for the chat UI HTML. |",
          "path": "docs/cli.md",
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "original_commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sorry my bad missed this",
          "created_at": "2026-01-29T20:07:13Z",
          "updated_at": "2026-01-29T20:07:14Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743320294",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743320294"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743320294"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743320294/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2743250122,
          "original_position": 4,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T20:07:13Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169504032",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3724774306,
          "node_id": "PRR_kwDOMMa-Ps7eA4ui",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "submitted_at": "2026-01-29T20:07:03Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724774306",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724774306"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T20:07:03Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T20:07:05Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169503247",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743319605",
          "pull_request_review_id": 3724774306,
          "id": 2743319605,
          "node_id": "PRRC_kwDOMMa-Ps6jg7w1",
          "diff_hunk": "@@ -101,3 +100,37 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom HTML Path\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide `html_path` to override this for offline usage or enterprise environments.\n+\n+For offline usage, download the CHAT UI HTML file once while you have internet access:",
          "path": "docs/web.md",
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "original_commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "will change this ",
          "created_at": "2026-01-29T20:07:03Z",
          "updated_at": "2026-01-29T20:07:04Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743319605",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743319605"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743319605"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743319605/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2743254251,
          "original_position": 17,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T20:07:03Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169500609",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3724773661,
          "node_id": "PRR_kwDOMMa-Ps7eA4kd",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "submitted_at": "2026-01-29T20:06:55Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724773661",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724773661"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T20:06:55Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T20:06:56Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169500283",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743319143",
          "pull_request_review_id": 3724773661,
          "id": 2743319143,
          "node_id": "PRRC_kwDOMMa-Ps6jg7pn",
          "diff_hunk": "@@ -101,3 +100,37 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom HTML Path\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide `html_path` to override this for offline usage or enterprise environments.\n+\n+For offline usage, download the CHAT UI HTML file once while you have internet access:\n+\n+```python\n+from pydantic_ai.ui import CHAT_UI_URL_TEMPLATE, CHAT_UI_VERSION\n+\n+chat_ui_url = CHAT_UI_URL_TEMPLATE.format(version=CHAT_UI_VERSION)\n+\n+print(chat_ui_url)  # Use this URL to download the UI HTML file\n+#> https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+",
          "path": "docs/web.md",
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "original_commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "will remove the line",
          "created_at": "2026-01-29T20:06:55Z",
          "updated_at": "2026-01-29T20:06:55Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743319143",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743319143"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743319143"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743319143/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2743255957,
          "original_position": 26,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T20:06:55Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169499050",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3724773284,
          "node_id": "PRR_kwDOMMa-Ps7eA4ek",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "submitted_at": "2026-01-29T20:06:49Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724773284",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3724773284"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T20:06:49Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T20:06:52Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6169498299",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743318811",
          "pull_request_review_id": 3724773284,
          "id": 2743318811,
          "node_id": "PRRC_kwDOMMa-Ps6jg7kb",
          "diff_hunk": "@@ -101,3 +100,37 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom HTML Path\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide `html_path` to override this for offline usage or enterprise environments.\n+\n+For offline usage, download the CHAT UI HTML file once while you have internet access:\n+\n+```python\n+from pydantic_ai.ui import CHAT_UI_URL_TEMPLATE, CHAT_UI_VERSION\n+\n+chat_ui_url = CHAT_UI_URL_TEMPLATE.format(version=CHAT_UI_VERSION)\n+\n+print(chat_ui_url)  # Use this URL to download the UI HTML file\n+#> https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+\n+```\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html <chat_ui_url>\n+```",
          "path": "docs/web.md",
          "commit_id": "2ef712f3a9d585597af3480182a36febee968b08",
          "original_commit_id": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure will add a text",
          "created_at": "2026-01-29T20:06:49Z",
          "updated_at": "2026-01-29T20:06:49Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743318811",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743318811"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2743318811"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2743318811/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2743257624,
          "original_position": 31,
          "position": 30,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T20:06:49Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6166933784",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "review": {
          "id": 3724322585,
          "node_id": "PRR_kwDOQuIaMM7d_KcZ",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "46acc5afbea724d1e7f2cd200c18732995053e51",
          "submitted_at": "2026-01-29T18:19:10Z",
          "state": "commented",
          "html_url": "https://github.com/madanlalit/heimdall/pull/26#pullrequestreview-3724322585",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "_links": {
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/26#pullrequestreview-3724322585"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/26"
            }
          },
          "updated_at": "2026-01-29T18:19:10Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T18:19:12Z"
    },
    {
      "id": "6166933322",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2742937439",
          "pull_request_review_id": 3724322585,
          "id": 2742937439,
          "node_id": "PRRC_kwDOQuIaMM6jfedf",
          "diff_hunk": "@@ -0,0 +1,83 @@\n+\"\"\"\n+Groq LLM Client - Groq API integration for Heimdall.\n+\n+Groq provides high-speed inference using their LPU hardware.\n+Uses OpenAI-compatible API.\n+\"\"\"\n+\n+import logging\n+from typing import Any\n+\n+from heimdall.agent.llm.base import BaseLLM\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+class GroqLLM(BaseLLM):\n+    \"\"\"Groq API client for chat completions with tool calling.\"\"\"\n+\n+    def __init__(\n+        self,\n+        api_key: str | None = None,\n+        model: str = \"llama-3.3-70b-versatile\",\n+        temperature: float = 0.0,\n+        max_tokens: int = 4096,\n+    ):\n+        import os\n+\n+        from groq import AsyncGroq\n+\n+        self._client = AsyncGroq(\n+            api_key=api_key or os.getenv(\"GROQ_API_KEY\"),\n+        )\n+        self._model = model\n+        self._temperature = temperature\n+        self._max_tokens = max_tokens\n+\n+    async def chat_completion(\n+        self,\n+        messages: list[dict],\n+        tools: list[dict] | None = None,\n+        tool_choice: str = \"auto\",\n+        **kwargs,\n+    ) -> dict:\n+        \"\"\"Generate chat completion with optional tool calling.\"\"\"\n+        params: dict[str, Any] = {\n+            \"model\": self._model,\n+            \"messages\": messages,\n+            \"temperature\": self._temperature,\n+            \"max_tokens\": self._max_tokens,\n+        }\n+\n+        if tools:\n+            params[\"tools\"] = tools\n+            params[\"tool_choice\"] = tool_choice\n+\n+        params.update(kwargs)\n+\n+        response = await self._client.chat.completions.create(**params)\n+\n+        message = response.choices[0].message",
          "path": "src/heimdall/agent/llm/groq.py",
          "commit_id": "88b41f9aff22be56a52ad042a65d3d8950c95407",
          "original_commit_id": "46acc5afbea724d1e7f2cd200c18732995053e51",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "@paragon-run",
          "created_at": "2026-01-29T18:19:10Z",
          "updated_at": "2026-01-29T18:19:11Z",
          "html_url": "https://github.com/madanlalit/heimdall/pull/26#discussion_r2742937439",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2742937439"
            },
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/26#discussion_r2742937439"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/26"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2742937439/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2742902242,
          "original_position": 60,
          "position": 60,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T18:19:10Z"
    },
    {
      "id": "6166932754",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "review": {
          "id": 3724322382,
          "node_id": "PRR_kwDOQuIaMM7d_KZO",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "46acc5afbea724d1e7f2cd200c18732995053e51",
          "submitted_at": "2026-01-29T18:19:07Z",
          "state": "commented",
          "html_url": "https://github.com/madanlalit/heimdall/pull/26#pullrequestreview-3724322382",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "_links": {
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/26#pullrequestreview-3724322382"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/26"
            }
          },
          "updated_at": "2026-01-29T18:19:07Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T18:19:09Z"
    },
    {
      "id": "6166932190",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2742937229",
          "pull_request_review_id": 3724322382,
          "id": 2742937229,
          "node_id": "PRRC_kwDOQuIaMM6jfeaN",
          "diff_hunk": "@@ -0,0 +1,83 @@\n+\"\"\"\n+Groq LLM Client - Groq API integration for Heimdall.\n+\n+Groq provides high-speed inference using their LPU hardware.\n+Uses OpenAI-compatible API.\n+\"\"\"\n+\n+import logging\n+from typing import Any\n+\n+from heimdall.agent.llm.base import BaseLLM\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+class GroqLLM(BaseLLM):\n+    \"\"\"Groq API client for chat completions with tool calling.\"\"\"\n+\n+    def __init__(\n+        self,\n+        api_key: str | None = None,\n+        model: str = \"llama-3.3-70b-versatile\",\n+        temperature: float = 0.0,\n+        max_tokens: int = 4096,\n+    ):\n+        import os\n+\n+        from groq import AsyncGroq\n+\n+        self._client = AsyncGroq(\n+            api_key=api_key or os.getenv(\"GROQ_API_KEY\"),\n+        )\n+        self._model = model\n+        self._temperature = temperature\n+        self._max_tokens = max_tokens\n+\n+    async def chat_completion(\n+        self,\n+        messages: list[dict],\n+        tools: list[dict] | None = None,\n+        tool_choice: str = \"auto\",\n+        **kwargs,\n+    ) -> dict:\n+        \"\"\"Generate chat completion with optional tool calling.\"\"\"\n+        params: dict[str, Any] = {\n+            \"model\": self._model,\n+            \"messages\": messages,\n+            \"temperature\": self._temperature,\n+            \"max_tokens\": self._max_tokens,\n+        }\n+\n+        if tools:\n+            params[\"tools\"] = tools\n+            params[\"tool_choice\"] = tool_choice\n+\n+        params.update(kwargs)\n+\n+        response = await self._client.chat.completions.create(**params)\n+\n+        message = response.choices[0].message\n+\n+        result: dict[str, Any] = {\n+            \"content\": message.content or \"\",\n+        }\n+\n+        if message.tool_calls:\n+            result[\"tool_calls\"] = [\n+                {\n+                    \"id\": tc.id,\n+                    \"type\": tc.type,\n+                    \"function\": {\n+                        \"name\": tc.function.name,\n+                        \"arguments\": tc.function.arguments,",
          "path": "src/heimdall/agent/llm/groq.py",
          "commit_id": "88b41f9aff22be56a52ad042a65d3d8950c95407",
          "original_commit_id": "46acc5afbea724d1e7f2cd200c18732995053e51",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "@paragon-run",
          "created_at": "2026-01-29T18:19:07Z",
          "updated_at": "2026-01-29T18:19:08Z",
          "html_url": "https://github.com/madanlalit/heimdall/pull/26#discussion_r2742937229",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2742937229"
            },
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/26#discussion_r2742937229"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/26"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2742937229/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2742902246,
          "original_position": 73,
          "position": 73,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T18:19:07Z"
    },
    {
      "id": "7950478871",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30245190369,
        "ref": "refs/heads/feat/add-groq-support",
        "head": "88b41f9aff22be56a52ad042a65d3d8950c95407",
        "before": "f9976cb00db66fb85d65fad303f228b1cba82b2d"
      },
      "public": true,
      "created_at": "2026-01-29T18:18:07Z"
    },
    {
      "id": "7950395640",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30245107496,
        "ref": "refs/heads/feat/add-groq-support",
        "head": "f9976cb00db66fb85d65fad303f228b1cba82b2d",
        "before": "46acc5afbea724d1e7f2cd200c18732995053e51"
      },
      "public": true,
      "created_at": "2026-01-29T18:15:00Z"
    },
    {
      "id": "6166644825",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "opened",
        "number": 26,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/26",
          "id": 3224548109,
          "number": 26,
          "head": {
            "ref": "feat/add-groq-support",
            "sha": "88b41f9aff22be56a52ad042a65d3d8950c95407",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T18:07:05Z"
    },
    {
      "id": "7950170013",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "ref": "feat/add-groq-support",
        "ref_type": "branch",
        "full_ref": "refs/heads/feat/add-groq-support",
        "master_branch": "main",
        "description": "The all-seeing agent for web automation.",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-29T18:06:37Z"
    },
    {
      "id": "7950036429",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30244748426,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "ef6e405434a5bf38b481574dd94ee6a2fc075f6b",
        "before": "1a7b1354b4236029c2bf2380174836b09407f6a1"
      },
      "public": true,
      "created_at": "2026-01-29T18:01:52Z"
    },
    {
      "id": "7949605497",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30244318546,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "1a7b1354b4236029c2bf2380174836b09407f6a1",
        "before": "8ac84ac781fe19db71ac18612e3afea6db843e0a"
      },
      "public": true,
      "created_at": "2026-01-29T17:47:23Z"
    },
    {
      "id": "6164555023",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3723876102,
          "node_id": "PRR_kwDOMMa-Ps7d9dcG",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "submitted_at": "2026-01-29T16:45:57Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723876102",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723876102"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T16:45:57Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T16:46:00Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6164554049",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742576278",
          "pull_request_review_id": 3723876102,
          "id": 2742576278,
          "node_id": "PRRC_kwDOMMa-Ps6jeGSW",
          "diff_hunk": "@@ -110,16 +146,18 @@ def create_web_app(\n \n     async def index(request: Request) -> Response:\n         \"\"\"Serve the chat UI from filesystem cache or CDN.\"\"\"\n-        version = request.query_params.get('version')\n-        ui_version = version or DEFAULT_UI_VERSION\n-\n         try:\n-            content = await _get_ui_html(ui_version)\n+            content = await _get_ui_html(ui_source)\n         except httpx.HTTPStatusError as e:\n             return HTMLResponse(\n-                content=f'Failed to fetch UI version \"{ui_version}\": {e.response.status_code}',\n+                content=f'Failed to fetch UI: {e.response.status_code}',\n                 status_code=502,\n             )\n+        except FileNotFoundError as e:\n+            return HTMLResponse(\n+                content=str(e),\n+                status_code=404,\n+            )",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "will let the error propagate",
          "created_at": "2026-01-29T16:45:57Z",
          "updated_at": "2026-01-29T16:46:12Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742576278",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742576278"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742576278"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742576278/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2742149928,
          "original_position": 129,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T16:45:57Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6164547214",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3723874362,
          "node_id": "PRR_kwDOMMa-Ps7d9dA6",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "submitted_at": "2026-01-29T16:45:40Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723874362",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723874362"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T16:45:40Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T16:45:43Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6164546365",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742575061",
          "pull_request_review_id": 3723874362,
          "id": 2742575061,
          "node_id": "PRRC_kwDOMMa-Ps6jeF_V",
          "diff_hunk": "@@ -1618,12 +1619,13 @@ def to_web(\n         deps: AgentDepsT = None,\n         model_settings: ModelSettings | None = None,\n         instructions: str | None = None,\n+        ui_source: str | Path | None = None,",
          "path": "pydantic_ai_slim/pydantic_ai/agent/__init__.py",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure will change it",
          "created_at": "2026-01-29T16:45:40Z",
          "updated_at": "2026-01-29T16:45:40Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742575061",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742575061"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742575061"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742575061/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2742175551,
          "original_position": 12,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T16:45:40Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6164540530",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3723873058,
          "node_id": "PRR_kwDOMMa-Ps7d9csi",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "submitted_at": "2026-01-29T16:45:27Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723873058",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723873058"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T16:45:27Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T16:45:29Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6164539870",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742574232",
          "pull_request_review_id": 3723873058,
          "id": 2742574232,
          "node_id": "PRRC_kwDOMMa-Ps6jeFyY",
          "diff_hunk": "@@ -110,16 +146,18 @@ def create_web_app(\n \n     async def index(request: Request) -> Response:\n         \"\"\"Serve the chat UI from filesystem cache or CDN.\"\"\"\n-        version = request.query_params.get('version')\n-        ui_version = version or DEFAULT_UI_VERSION\n-\n         try:\n-            content = await _get_ui_html(ui_version)\n+            content = await _get_ui_html(ui_source)",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "will cache the url in filesystem",
          "created_at": "2026-01-29T16:45:27Z",
          "updated_at": "2026-01-29T16:45:27Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742574232",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742574232"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742574232"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742574232/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2742154274,
          "original_position": 118,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T16:45:27Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6163035647",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3723587717,
          "node_id": "PRR_kwDOMMa-Ps7d8XCF",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "submitted_at": "2026-01-29T15:55:46Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723587717",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3723587717"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-29T15:55:46Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-29T15:55:47Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6163035219",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742353039",
          "pull_request_review_id": 3723587717,
          "id": 2742353039,
          "node_id": "PRRC_kwDOMMa-Ps6jdPyP",
          "diff_hunk": "@@ -101,3 +101,27 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this for offline usage or enterprise environments.\n+\n+For offline usage, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html",
          "path": "docs/web.md",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "got it \nthe only issue with that is we would need to make expose 2 public constants \nand the naming is not that end user friendly. Otherwise its fine ",
          "created_at": "2026-01-29T15:55:46Z",
          "updated_at": "2026-01-29T15:55:46Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742353039",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742353039"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2742353039"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2742353039/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2734106372,
          "original_position": 12,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-29T15:55:46Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6140239548",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1125494026,
        "name": "mcollina/githuman",
        "url": "https://api.github.com/repos/mcollina/githuman"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-28T22:05:59Z"
    },
    {
      "id": "6131064690",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1137489544,
        "name": "lucasgelfond/zerobrew",
        "url": "https://api.github.com/repos/lucasgelfond/zerobrew"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-28T16:13:03Z"
    },
    {
      "id": "7908076892",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30202877497,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
        "before": "38688c367dbaa373ffe27165cadf0868d1fc100c"
      },
      "public": true,
      "created_at": "2026-01-28T15:31:18Z"
    },
    {
      "id": "7907900470",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30202697509,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "38688c367dbaa373ffe27165cadf0868d1fc100c",
        "before": "5462cd5529069b1c5644f4b3abeda825167ce4b8"
      },
      "public": true,
      "created_at": "2026-01-28T15:25:45Z"
    },
    {
      "id": "6129401481",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3717293477,
          "node_id": "PRR_kwDOMMa-Ps7dkWWl",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "submitted_at": "2026-01-28T15:18:57Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3717293477",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3717293477"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-28T15:18:57Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-28T15:18:59Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6129400520",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2737140476",
          "pull_request_review_id": 3717293477,
          "id": 2737140476,
          "node_id": "PRRC_kwDOMMa-Ps6jJXL8",
          "diff_hunk": "@@ -509,3 +473,150 @@ async def test_instructions_passed_to_dispatch(monkeypatch: pytest.MonkeyPatch):\n     mock_dispatch.assert_called_once()\n     call_kwargs = mock_dispatch.call_args.kwargs\n     assert call_kwargs['instructions'] == 'Always respond in Spanish'\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_custom_url(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html fetches from custom URL when provided.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    monkeypatch.setattr(app_module, '_get_cache_dir', lambda: tmp_path)\n+\n+    test_content = b'<html>Custom CDN UI</html>'\n+    captured_url: list[str] = []\n+\n+    class MockResponse:\n+        content = test_content\n+\n+        def raise_for_status(self) -> None:\n+            pass\n+\n+    class MockAsyncClient:\n+        async def __aenter__(self) -> MockAsyncClient:\n+            return self\n+\n+        async def __aexit__(self, *args: Any) -> None:\n+            pass\n+\n+        async def get(self, url: str) -> MockResponse:\n+            captured_url.append(url)\n+            return MockResponse()\n+\n+    monkeypatch.setattr(app_module.httpx, 'AsyncClient', MockAsyncClient)\n+\n+    from pydantic_ai.ui._web.app import _get_ui_html  # pyright: ignore[reportPrivateUsage]\n+\n+    # URL is used directly, no version templating\n+    custom_url = 'https://my-internal-cdn.example.com/ui/index.html'\n+    result = await _get_ui_html(ui_source=custom_url)\n+\n+    assert result == test_content\n+    assert len(captured_url) == 1\n+    assert captured_url[0] == custom_url\n+\n+\n+def test_agent_to_web_with_ui_source():\n+    \"\"\"Test that Agent.to_web() accepts ui_source parameter.\"\"\"\n+    agent = Agent('test')\n+    app = agent.to_web(ui_source='https://custom-cdn.example.com/ui/index.html')\n+\n+    assert isinstance(app, Starlette)\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_local_file_path_string(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html supports local file paths as strings.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    # Create a test HTML file\n+    test_html = b'<html><body>Local UI Content</body></html>'\n+    local_file = tmp_path / 'custom-ui.html'\n+    local_file.write_bytes(test_html)\n+\n+    result = await app_module._get_ui_html(ui_source=str(local_file))  # pyright: ignore[reportPrivateUsage]\n+\n+    assert result == test_html\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_local_file_path_instance(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html supports Path instances.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    # Create a test HTML file\n+    test_html = b'<html><body>Path Instance UI</body></html>'\n+    local_file = tmp_path / 'path-ui.html'\n+    local_file.write_bytes(test_html)\n+\n+    result = await app_module._get_ui_html(ui_source=local_file)  # pyright: ignore[reportPrivateUsage]\n+\n+    assert result == test_html\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_local_file_not_found(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html raises FileNotFoundError for missing local file paths.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    # Try to use a non-existent local file path\n+    nonexistent_path = str(tmp_path / 'nonexistent-ui.html')\n+\n+    with pytest.raises(FileNotFoundError, match='Local UI file not found'):\n+        await app_module._get_ui_html(ui_source=nonexistent_path)  # pyright: ignore[reportPrivateUsage]\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_path_instance_not_found(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html raises FileNotFoundError for missing Path instances.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    # Try to use a non-existent Path instance\n+    nonexistent_path = tmp_path / 'nonexistent-ui.html'\n+\n+    with pytest.raises(FileNotFoundError, match='Local UI file not found'):\n+        await app_module._get_ui_html(ui_source=nonexistent_path)  # pyright: ignore[reportPrivateUsage]\n+\n+\n+def test_chat_app_index_file_not_found(tmp_path: Path):\n+    \"\"\"Test that index endpoint returns 404 for non-existent ui_source file.\"\"\"\n+    agent = Agent('test')\n+    nonexistent_file = tmp_path / 'nonexistent-ui.html'\n+    app = create_web_app(agent, ui_source=str(nonexistent_file))\n+\n+    with TestClient(app) as client:\n+        response = client.get('/')\n+        assert response.status_code == 404\n+        assert 'Local UI file not found' in response.text\n+\n+\n+def test_chat_app_index_http_error(monkeypatch: pytest.MonkeyPatch):\n+    \"\"\"Test that index endpoint returns 502 when CDN fetch fails with HTTPStatusError.\"\"\"\n+    import httpx\n+\n+    import pydantic_ai.ui._web.app as app_module",
          "path": "tests/test_ui_web.py",
          "commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "original_commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "will move all the imports at the top for the complete file if thats okay",
          "created_at": "2026-01-28T15:18:57Z",
          "updated_at": "2026-01-28T15:18:57Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2737140476",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2737140476"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2737140476"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2737140476/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2734110553,
          "original_position": 192,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-28T15:18:57Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6129170804",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3717245984,
          "node_id": "PRR_kwDOMMa-Ps7dkKwg",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "submitted_at": "2026-01-28T15:12:00Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3717245984",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3717245984"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-28T15:12:00Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-28T15:12:01Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6129170150",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2737103250",
          "pull_request_review_id": 3717245984,
          "id": 2737103250,
          "node_id": "PRRC_kwDOMMa-Ps6jJOGS",
          "diff_hunk": "@@ -101,3 +101,27 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this for offline usage or enterprise environments.\n+\n+For offline usage, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html",
          "path": "docs/web.md",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "can i expose a method which would return the default web chat ui html url ? This way they can just call the method which would return a string and that can be used to download the html file ? ",
          "created_at": "2026-01-28T15:12:00Z",
          "updated_at": "2026-01-28T15:12:00Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2737103250",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2737103250"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2737103250"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2737103250/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2734106372,
          "original_position": 12,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-28T15:12:00Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6126731907",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3716805604,
          "node_id": "PRR_kwDOMMa-Ps7difPk",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "submitted_at": "2026-01-28T13:48:40Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3716805604",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3716805604"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-28T13:48:40Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-28T13:48:41Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6126731228",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2736726848",
          "pull_request_review_id": 3716805604,
          "id": 2736726848,
          "node_id": "PRRC_kwDOMMa-Ps6jHyNA",
          "diff_hunk": "@@ -1644,6 +1646,12 @@ def to_web(\n             deps: Optional dependencies to use for all requests.\n             model_settings: Optional settings to use for all model requests.\n             instructions: Optional extra instructions to pass to each agent run.\n+            ui_source: Source for the chat UI HTML. Can be:\n+                - None (default): Fetches from CDN and caches locally\n+                - A Path instance: Reads from the local file\n+                - A string starting with '<': Treated as raw HTML content",
          "path": "pydantic_ai_slim/pydantic_ai/agent/__init__.py",
          "commit_id": "38688c367dbaa373ffe27165cadf0868d1fc100c",
          "original_commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "missed this \nwill remove it ",
          "created_at": "2026-01-28T13:48:39Z",
          "updated_at": "2026-01-28T13:48:40Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2736726848",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2736726848"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2736726848"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2736726848/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2690087725,
          "original_position": 31,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-28T13:48:39Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6126642081",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3716788858,
          "node_id": "PRR_kwDOMMa-Ps7dibJ6",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "submitted_at": "2026-01-28T13:45:34Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3716788858",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3716788858"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-28T13:45:34Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-28T13:45:36Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6126641355",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2736713320",
          "pull_request_review_id": 3716788858,
          "id": 2736713320,
          "node_id": "PRRC_kwDOMMa-Ps6jHu5o",
          "diff_hunk": "@@ -101,3 +101,27 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this for offline usage or enterprise environments.\n+\n+For offline usage, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html",
          "path": "docs/web.md",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "5462cd5529069b1c5644f4b3abeda825167ce4b8",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure",
          "created_at": "2026-01-28T13:45:34Z",
          "updated_at": "2026-01-28T13:45:35Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2736713320",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2736713320"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2736713320"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2736713320/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2734106372,
          "original_position": 12,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-28T13:45:34Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6107165327",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3807557475",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3807557475",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3807557475,
          "node_id": "IC_kwDOMMa-Ps7i8rdj",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-27T21:12:18Z",
          "updated_at": "2026-01-27T21:12:18Z",
          "body": "@DouweM \r\nI've addressed all the comments and made the necessary changes wherever applicable.\r\nPlease let me know if I've missed any tests or if you have additional ones in mind. \r\nI've also added the test flow as a docstring to make it easier to understand and avoid any confusion about test expectation\r\nI'll get started on the fix once the tests are qualified.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3807557475/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-27T21:12:18Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7880120176",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30174962543,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "6f734a97612d5b809c3adae3d8b5df27bd697cfb",
        "before": "611dba045c043d1762ee154f2b4501429335cff9"
      },
      "public": true,
      "created_at": "2026-01-27T21:07:26Z"
    },
    {
      "id": "6107014709",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3713454864,
          "node_id": "PRR_kwDOMMa-Ps7dVtMQ",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "611dba045c043d1762ee154f2b4501429335cff9",
          "submitted_at": "2026-01-27T21:05:31Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3713454864",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3713454864"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-01-27T21:05:31Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-27T21:05:34Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6107013839",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733824454",
          "pull_request_review_id": 3713454864,
          "id": 2733824454,
          "node_id": "PRRC_kwDOMMa-Ps6i8tnG",
          "diff_hunk": "@@ -879,3 +880,133 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    async with agent.iter('start') as run:\n+        async for node in run:\n+            idx = run.ctx.deps.new_message_index\n+            assert idx >= 0, (\n+                f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+            )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()\n+\n+    assert len(new_msgs) == len(all_msgs), (\n+        f'Fresh run: new_messages ({len(new_msgs)}) should equal all_messages ({len(all_msgs)}). '\n+        f'This failure indicates the negative index bug is present.'\n+    )\n+\n+\n+async def test_history_processor_reorder_old_new(function_model: FunctionModel, received_messages: list[ModelMessage]):\n+    def swap_last_two(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        if len(messages) >= 2:\n+            return messages[:-2] + [messages[-1], messages[-2]]\n+        return messages\n+\n+    agent = Agent(function_model, history_processors=[swap_last_two])\n+\n+    message_history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old question')]),\n+    ]\n+\n+    result = await agent.run('New question', message_history=message_history)\n+    assert received_messages == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+            )\n+        ]\n+    )\n+    new_msgs = result.new_messages()\n+    # Expected behavior: Only messages from THIS run should be in new_messages()\n+    # The 'New question' request and response are from this run\n+    # 'Old question' was reordered by the processor but is from a previous run\n+    assert new_msgs == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),",
          "path": "tests/test_history_processor.py",
          "commit_id": "e068779950e0e9d335b316df3b6d6504c5162a39",
          "original_commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "ideally yes the expectation comment was wrong changed it and update the test",
          "created_at": "2026-01-27T21:05:31Z",
          "updated_at": "2026-01-27T21:05:31Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733824454",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733824454"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733824454"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733824454/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2729160527,
          "original_position": 75,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-27T21:05:31Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6103951586",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3712909517,
          "node_id": "PRR_kwDOMMa-Ps7dToDN",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "submitted_at": "2026-01-27T18:50:29Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3712909517",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3712909517"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-01-27T18:50:29Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-27T18:50:31Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6103950939",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733382527",
          "pull_request_review_id": 3712909517,
          "id": 2733382527,
          "node_id": "PRRC_kwDOMMa-Ps6i7Bt_",
          "diff_hunk": "@@ -879,3 +880,133 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    async with agent.iter('start') as run:\n+        async for node in run:\n+            idx = run.ctx.deps.new_message_index\n+            assert idx >= 0, (\n+                f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+            )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()\n+\n+    assert len(new_msgs) == len(all_msgs), (\n+        f'Fresh run: new_messages ({len(new_msgs)}) should equal all_messages ({len(all_msgs)}). '\n+        f'This failure indicates the negative index bug is present.'\n+    )\n+\n+\n+async def test_history_processor_reorder_old_new(function_model: FunctionModel, received_messages: list[ModelMessage]):\n+    def swap_last_two(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        if len(messages) >= 2:\n+            return messages[:-2] + [messages[-1], messages[-2]]\n+        return messages\n+\n+    agent = Agent(function_model, history_processors=[swap_last_two])\n+\n+    message_history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old question')]),\n+    ]\n+\n+    result = await agent.run('New question', message_history=message_history)\n+    assert received_messages == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+            )\n+        ]\n+    )\n+    new_msgs = result.new_messages()",
          "path": "tests/test_history_processor.py",
          "commit_id": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
          "original_commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure",
          "created_at": "2026-01-27T18:50:29Z",
          "updated_at": "2026-01-27T18:50:29Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733382527",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733382527"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733382527"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733382527/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2729156360,
          "original_position": 67,
          "position": 324,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-27T18:50:29Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6103948907",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3712909087,
          "node_id": "PRR_kwDOMMa-Ps7dTn8f",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "submitted_at": "2026-01-27T18:50:24Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3712909087",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3712909087"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-01-27T18:50:24Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-27T18:50:25Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6103948454",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733382190",
          "pull_request_review_id": 3712909087,
          "id": 2733382190,
          "node_id": "PRRC_kwDOMMa-Ps6i7Bou",
          "diff_hunk": "@@ -879,3 +880,133 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    async with agent.iter('start') as run:\n+        async for node in run:\n+            idx = run.ctx.deps.new_message_index\n+            assert idx >= 0, (\n+                f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+            )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()",
          "path": "tests/test_history_processor.py",
          "commit_id": "611dba045c043d1762ee154f2b4501429335cff9",
          "original_commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure ",
          "created_at": "2026-01-27T18:50:23Z",
          "updated_at": "2026-01-27T18:50:24Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733382190",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733382190"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733382190"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733382190/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2729153180,
          "original_position": 35,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-27T18:50:23Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6103946473",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3712908583,
          "node_id": "PRR_kwDOMMa-Ps7dTn0n",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "submitted_at": "2026-01-27T18:50:18Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3712908583",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3712908583"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-01-27T18:50:18Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-27T18:50:19Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6103945908",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733381892",
          "pull_request_review_id": 3712908583,
          "id": 2733381892,
          "node_id": "PRRC_kwDOMMa-Ps6i7BkE",
          "diff_hunk": "@@ -879,3 +880,133 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    async with agent.iter('start') as run:\n+        async for node in run:\n+            idx = run.ctx.deps.new_message_index\n+            assert idx >= 0, (\n+                f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+            )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()\n+\n+    assert len(new_msgs) == len(all_msgs), (",
          "path": "tests/test_history_processor.py",
          "commit_id": "611dba045c043d1762ee154f2b4501429335cff9",
          "original_commit_id": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure will improve the test",
          "created_at": "2026-01-27T18:50:18Z",
          "updated_at": "2026-01-27T18:50:18Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733381892",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733381892"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2733381892"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2733381892/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2729150926,
          "original_position": 37,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-27T18:50:18Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7820197425",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1124192564,
        "name": "madanlalit/madanlalit",
        "url": "https://api.github.com/repos/madanlalit/madanlalit"
      },
      "payload": {
        "repository_id": 1124192564,
        "push_id": 30115137894,
        "ref": "refs/heads/main",
        "head": "f216cf7c85487d0c98dac8e9fc2a96f3bacffddb",
        "before": "be760a54bd78164018275421668ae9ffbbc0ebe8"
      },
      "public": true,
      "created_at": "2026-01-26T08:38:53Z"
    },
    {
      "id": "6057458815",
      "type": "ForkEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1137741043,
        "name": "anthropics/original_performance_takehome",
        "url": "https://api.github.com/repos/anthropics/original_performance_takehome"
      },
      "payload": {
        "action": "forked",
        "forkee": {
          "id": 1142271669,
          "node_id": "R_kgDORBWutQ",
          "name": "original_performance_takehome",
          "full_name": "madanlalit/original_performance_takehome",
          "private": false,
          "owner": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "html_url": "https://github.com/madanlalit/original_performance_takehome",
          "description": "Anthropic's original performance take-home, now open for you to try!",
          "fork": true,
          "url": "https://api.github.com/repos/madanlalit/original_performance_takehome",
          "forks_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/forks",
          "keys_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/keys{/key_id}",
          "collaborators_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/collaborators{/collaborator}",
          "teams_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/teams",
          "hooks_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/hooks",
          "issue_events_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/issues/events{/number}",
          "events_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/events",
          "assignees_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/assignees{/user}",
          "branches_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/branches{/branch}",
          "tags_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/tags",
          "blobs_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/git/blobs{/sha}",
          "git_tags_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/git/tags{/sha}",
          "git_refs_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/git/refs{/sha}",
          "trees_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/git/trees{/sha}",
          "statuses_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/statuses/{sha}",
          "languages_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/languages",
          "stargazers_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/stargazers",
          "contributors_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/contributors",
          "subscribers_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/subscribers",
          "subscription_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/subscription",
          "commits_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/commits{/sha}",
          "git_commits_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/git/commits{/sha}",
          "comments_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/comments{/number}",
          "issue_comment_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/issues/comments{/number}",
          "contents_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/contents/{+path}",
          "compare_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/compare/{base}...{head}",
          "merges_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/merges",
          "archive_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/{archive_format}{/ref}",
          "downloads_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/downloads",
          "issues_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/issues{/number}",
          "pulls_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/pulls{/number}",
          "milestones_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/milestones{/number}",
          "notifications_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/notifications{?since,all,participating}",
          "labels_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/labels{/name}",
          "releases_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/releases{/id}",
          "deployments_url": "https://api.github.com/repos/madanlalit/original_performance_takehome/deployments",
          "created_at": "2026-01-26T07:25:25Z",
          "updated_at": "2026-01-26T07:25:25Z",
          "pushed_at": "2026-01-22T01:11:08Z",
          "git_url": "git://github.com/madanlalit/original_performance_takehome.git",
          "ssh_url": "git@github.com:madanlalit/original_performance_takehome.git",
          "clone_url": "https://github.com/madanlalit/original_performance_takehome.git",
          "svn_url": "https://github.com/madanlalit/original_performance_takehome",
          "homepage": null,
          "size": 8,
          "stargazers_count": 0,
          "watchers_count": 0,
          "language": null,
          "has_issues": false,
          "has_projects": true,
          "has_downloads": true,
          "has_wiki": true,
          "has_pages": false,
          "has_discussions": false,
          "forks_count": 0,
          "mirror_url": null,
          "archived": false,
          "disabled": false,
          "open_issues_count": 0,
          "license": null,
          "allow_forking": true,
          "is_template": false,
          "web_commit_signoff_required": false,
          "topics": [],
          "visibility": "public",
          "forks": 0,
          "open_issues": 0,
          "watchers": 0,
          "default_branch": "main"
        }
      },
      "public": true,
      "created_at": "2026-01-26T07:25:25Z",
      "org": {
        "id": 76263028,
        "login": "anthropics",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/anthropics",
        "avatar_url": "https://avatars.githubusercontent.com/u/76263028?"
      }
    },
    {
      "id": "6050173521",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
          "id": 3853337578,
          "node_id": "PR_kwDOMMa-Ps6_PHbr",
          "number": 4086,
          "title": "fix: Identify new messages by `run_id` instead of index",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9947550467,
              "node_id": "LA_kwDOMMa-Ps8AAAACUOuTAw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/size:%20M",
              "name": "size: M",
              "color": "7cb342",
              "default": false,
              "description": "Medium PR (101-500 weighted lines)"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 11,
          "created_at": "2026-01-25T14:34:10Z",
          "updated_at": "2026-02-07T08:16:28Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/4086.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/4086.patch",
            "merged_at": null
          },
          "body": "- Closes #3983 \r\n\r\n### Pre-Review Checklist\r\n\r\n- [ ] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\r\n- [x] No **breaking changes** in accordance with the [version policy](https://github.com/pydantic/pydantic-ai/blob/main/docs/version-policy.md).\r\n- [x] **Linting and type checking** pass per `make format` and `make typecheck`.\r\n- [x] **PR title** is fit for the [release changelog](https://github.com/pydantic/pydantic-ai/releases).\r\n\r\n### Pre-Merge Checklist\r\n\r\n- [x] New **tests** for any fix or new behavior, maintaining 100% coverage.\r\n- [ ] Updated **documentation** for new features and behaviors, including docstrings for API docs.\r\n\r\n### Explanation behind the fix\r\n- `new_messages()` now finds the first message with `run_id == state.run_id` and uses that as the start index.\r\n- After history processing, if the last message (the current `ModelRequest`) has no `run_id`, its set to the current runs `run_id`.\r\n- If no message in the processed history has the current `run_id`, the index falls back to `len(messages)` (so only the new response is considered new).\r\n- When the request is reused from history, we explicitly set `new_message_index = len(message_history)` to avoid counting previous history as new.\r\n\r\n### Known pitfalls / Edge Cases\r\n- **Injected Messages**: Messages injected by the History Processor *before* the first message marked with `run_id` will be dropped.\r\n- **Reordering Messages**: Moving messages from history to a position *after* the first current run message will result in them being included in `new_messages()`.\r\n\r\n### Test updates\r\n- Updated the assertions for 2 tests: `test_history_processor_streaming_replaces_message_history` and `test_history_processor_run_replaces_message_history`. \r\n- Added `run_id` to remaining tests which were expecting run IDs.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3796977446",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#issuecomment-3796977446",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4086",
          "id": 3796977446,
          "node_id": "IC_kwDOMMa-Ps7iUUcm",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-25T17:17:05Z",
          "updated_at": "2026-01-25T17:17:05Z",
          "body": "@adtyavrdhn any other tests which i can add here ?",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3796977446/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-25T17:17:05Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7804162537",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30099262187,
        "ref": "refs/heads/fix/issue-3983-new-message-index",
        "head": "0c7387259a910f9f376e21e3d66ef96eb9448bdb",
        "before": "48e7262b014f8a04def11fd51d455ae229d37aea"
      },
      "public": true,
      "created_at": "2026-01-25T17:16:10Z"
    },
    {
      "id": "6050155322",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3704096236,
          "node_id": "PRR_kwDOMMa-Ps7cyAXs",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "48e7262b014f8a04def11fd51d455ae229d37aea",
          "submitted_at": "2026-01-25T17:14:28Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3704096236",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3704096236"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-01-25T17:14:28Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-25T17:14:30Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6050155073",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2725743677",
          "pull_request_review_id": 3704096236,
          "id": 2725743677,
          "node_id": "PRRC_kwDOMMa-Ps6id4w9",
          "diff_hunk": "@@ -879,3 +880,135 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_with_processor_pruning_current_run():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    result = await agent.run('New question')\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()\n+\n+    assert len(new_msgs) == len(all_msgs), (\n+        f'new_messages ({len(new_msgs)}) should equal all_messages ({len(all_msgs)}). '\n+        f'Bug: history processor pruned current-run messages, causing new_message_index miscalculation.'\n+    )\n+\n+\n+async def test_new_messages_index_during_iter_with_pruning():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    async with agent.iter('start') as run:\n+        async for node in run:\n+            idx = run.ctx.deps.new_message_index\n+            assert idx >= 0, (\n+                f'BUG: new_message_index became negative: {idx}. all_messages count: {len(run.all_messages())}'\n+            )\n+\n+    result = run.result\n+    assert result is not None\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()\n+\n+    assert len(new_msgs) == len(all_msgs), (\n+        f'Fresh run: new_messages ({len(new_msgs)}) should equal all_messages ({len(all_msgs)}). '\n+        f'This failure indicates the negative index bug is present.'\n+    )\n+\n+\n+async def test_new_messages_streaming_with_processor_pruning_current_run():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    async with agent.run_stream('New question') as result:\n+        async for _ in result.stream_text():\n+            pass\n+\n+    new_msgs = result.new_messages()\n+    all_msgs = result.all_messages()\n+\n+    assert len(new_msgs) == len(all_msgs), (\n+        f'Streaming: new_messages ({len(new_msgs)}) should equal all_messages ({len(all_msgs)}).'\n+    )\n+\n+\n+async def test_history_processor_reorder_old_new(function_model: FunctionModel, received_messages: list[ModelMessage]):\n+    def swap_last_two(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        if len(messages) >= 2:\n+            return messages[:-2] + [messages[-1], messages[-2]]\n+        return messages\n+\n+    agent = Agent(function_model, history_processors=[swap_last_two])\n+\n+    message_history = [\n+        ModelRequest(parts=[UserPromptPart(content='Old question')]),\n+    ]\n+\n+    result = await agent.run('New question', message_history=message_history)\n+    assert received_messages == snapshot(\n+        [\n+            ModelRequest(\n+                parts=[\n+                    UserPromptPart(content='New question', timestamp=IsDatetime()),\n+                    UserPromptPart(content='Old question', timestamp=IsDatetime()),\n+                ],\n+                timestamp=IsDatetime(),\n+            )\n+        ]\n+    )\n+    new_msgs = result.new_messages()\n+    assert len(new_msgs) == 1\n+    assert new_msgs[0].parts[0].content == 'New question', (",
          "path": "tests/test_history_processor.py",
          "commit_id": "48e7262b014f8a04def11fd51d455ae229d37aea",
          "original_commit_id": "48e7262b014f8a04def11fd51d455ae229d37aea",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "got it ",
          "created_at": "2026-01-25T17:14:28Z",
          "updated_at": "2026-01-25T17:16:52Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2725743677",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2725743677"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2725743677"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2725743677/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2725605957,
          "original_position": 112,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-25T17:14:28Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6050151654",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3704095377,
          "node_id": "PRR_kwDOMMa-Ps7cyAKR",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "48e7262b014f8a04def11fd51d455ae229d37aea",
          "submitted_at": "2026-01-25T17:14:04Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3704095377",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#pullrequestreview-3704095377"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "updated_at": "2026-01-25T17:14:04Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-25T17:14:06Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6050151365",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2725742884",
          "pull_request_review_id": 3704095377,
          "id": 2725742884,
          "node_id": "PRRC_kwDOMMa-Ps6id4kk",
          "diff_hunk": "@@ -879,3 +880,135 @@ def __call__(self, _: RunContext, messages: list[ModelMessage]) -> list[ModelMes\n         ]\n     )\n     assert result.new_messages() == result.all_messages()[-2:]\n+\n+\n+async def test_new_messages_with_processor_pruning_current_run():\n+    def keep_last_2(messages: list[ModelMessage]) -> list[ModelMessage]:\n+        return messages[-2:] if len(messages) > 2 else messages\n+\n+    agent = Agent(model=TestModel(custom_output_text='done'), history_processors=[keep_last_2])\n+\n+    @agent.tool\n+    async def my_tool(ctx: RunContext[None]) -> str:\n+        return 'tool executed'\n+\n+    result = await agent.run('New question')",
          "path": "tests/test_history_processor.py",
          "commit_id": "48e7262b014f8a04def11fd51d455ae229d37aea",
          "original_commit_id": "48e7262b014f8a04def11fd51d455ae229d37aea",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "missed this \r\nfixing now ",
          "created_at": "2026-01-25T17:14:03Z",
          "updated_at": "2026-01-25T17:14:04Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2725742884",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2725742884"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/4086#discussion_r2725742884"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2725742884/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2725600451,
          "original_position": 24,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-25T17:14:03Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6049792949",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1103012935,
        "name": "openclaw/openclaw",
        "url": "https://api.github.com/repos/openclaw/openclaw"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-25T16:27:34Z",
      "org": {
        "id": 252820863,
        "login": "openclaw",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/openclaw",
        "avatar_url": "https://avatars.githubusercontent.com/u/252820863?"
      }
    },
    {
      "id": "6048941017",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3796749190",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3796749190",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3796749190,
          "node_id": "IC_kwDOMMa-Ps7iTcuG",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-25T14:35:16Z",
          "updated_at": "2026-01-25T14:35:16Z",
          "body": "added tests @DouweM @adtyavrdhn @aletar89 ",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3796749190/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-25T14:35:16Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "6048931038",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "opened",
        "number": 4086,
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/4086",
          "id": 3208410859,
          "number": 4086,
          "head": {
            "ref": "fix/issue-3983-new-message-index",
            "sha": "733e2ef80b85e7ccd8945fe237c6524cb4bce177",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "dab3d727d5c56d362dac853357ff7c4ffd7c2481",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-25T14:34:10Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7801193144",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "ref": "fix/issue-3983-new-message-index",
        "ref_type": "branch",
        "full_ref": "refs/heads/fix/issue-3983-new-message-index",
        "master_branch": "main",
        "description": "GenAI Agent Framework, the Pydantic way",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-25T14:26:58Z"
    },
    {
      "id": "7796254708",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 30091468110,
        "ref": "refs/heads/main",
        "head": "9760d1346783410fbc9027867dad7538f444d42c",
        "before": "a018b567642bbac3f5437388dfa4f8d09dba6a35"
      },
      "public": true,
      "created_at": "2026-01-25T09:20:29Z"
    },
    {
      "id": "6046514366",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3796256253",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3796256253",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3796256253,
          "node_id": "IC_kwDOMMa-Ps7iRkX9",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-25T09:17:48Z",
          "updated_at": "2026-01-25T09:17:48Z",
          "body": "@adtyavrdhn I am interested.\nI was just going through the repo and trying to understand the nitty gritty details. I'll add few tests by today or tomorrow. ",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3796256253/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-25T09:17:48Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7772985313",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30068476305,
        "ref": "refs/heads/main",
        "head": "b0e33009a2f516ae36b7815028de3bc6f4bf2b3a",
        "before": "af53b78c4beb88502072711e47a82140c6a386c2"
      },
      "public": true,
      "created_at": "2026-01-24T06:26:28Z"
    },
    {
      "id": "6034944407",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "merged",
        "number": 25,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-24T06:26:27Z"
    },
    {
      "id": "6034882264",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "review": {
          "id": 3700826310,
          "node_id": "PRR_kwDOQuIaMM7cliDG",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "fixed the uv command \nand the github url is correct (no changes needed)",
          "commit_id": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
          "submitted_at": "2026-01-24T06:20:51Z",
          "state": "commented",
          "html_url": "https://github.com/madanlalit/heimdall/pull/25#pullrequestreview-3700826310",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "_links": {
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/25#pullrequestreview-3700826310"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/25"
            }
          },
          "updated_at": "2026-01-24T06:20:51Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-24T06:20:52Z"
    },
    {
      "id": "7772842749",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30068332954,
        "ref": "refs/heads/feature/add-ci-workflow",
        "head": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
        "before": "ad804a12a703b35ff10c72818d698e0626d037c4"
      },
      "public": true,
      "created_at": "2026-01-24T06:17:02Z"
    },
    {
      "id": "6034811428",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "assigned",
        "number": 25,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "assignee": {
          "login": "madanlalit",
          "id": 116655920,
          "node_id": "U_kgDOBvQHMA",
          "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/madanlalit",
          "html_url": "https://github.com/madanlalit",
          "followers_url": "https://api.github.com/users/madanlalit/followers",
          "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
          "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
          "organizations_url": "https://api.github.com/users/madanlalit/orgs",
          "repos_url": "https://api.github.com/users/madanlalit/repos",
          "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
          "received_events_url": "https://api.github.com/users/madanlalit/received_events",
          "type": "User",
          "user_view_type": "public",
          "site_admin": false
        },
        "assignees": [
          {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          }
        ]
      },
      "public": true,
      "created_at": "2026-01-24T06:07:17Z"
    },
    {
      "id": "7772804045",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30068294047,
        "ref": "refs/heads/feature/add-ci-workflow",
        "head": "ad804a12a703b35ff10c72818d698e0626d037c4",
        "before": "82d32cae100b0ec445ab76598bd762b0b33a296e"
      },
      "public": true,
      "created_at": "2026-01-24T06:14:43Z"
    },
    {
      "id": "6034756892",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "review": {
          "id": 3700790583,
          "node_id": "PRR_kwDOQuIaMM7clZU3",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "14be9c66ad14e0fc192367f93cce06e50491d53f",
          "submitted_at": "2026-01-24T06:10:52Z",
          "state": "commented",
          "html_url": "https://github.com/madanlalit/heimdall/pull/25#pullrequestreview-3700790583",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "_links": {
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/25#pullrequestreview-3700790583"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/25"
            }
          },
          "updated_at": "2026-01-24T06:10:52Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-24T06:10:53Z"
    },
    {
      "id": "6034756763",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2723752943",
          "pull_request_review_id": 3700790583,
          "id": 2723752943,
          "node_id": "PRRC_kwDOQuIaMM6iWSvv",
          "diff_hunk": "@@ -0,0 +1,58 @@\n+name: CI\n+\n+on:\n+    push:\n+        branches: [main]\n+    pull_request:\n+        branches: [main]\n+\n+jobs:\n+    lint:\n+        name: Lint & Type Check\n+        runs-on: ubuntu-latest\n+        steps:\n+            - uses: actions/checkout@v4\n+\n+            - name: Install uv\n+              uses: astral-sh/setup-uv@v5\n+              with:\n+                  enable-cache: true\n+\n+            - name: Set up Python\n+              run: uv python install 3.11\n+\n+            - name: Install dependencies\n+              run: uv sync --dev",
          "path": ".github/workflows/ci.yml",
          "commit_id": "14be9c66ad14e0fc192367f93cce06e50491d53f",
          "original_commit_id": "14be9c66ad14e0fc192367f93cce06e50491d53f",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "Fixed it ",
          "created_at": "2026-01-24T06:10:52Z",
          "updated_at": "2026-01-24T06:10:53Z",
          "html_url": "https://github.com/madanlalit/heimdall/pull/25#discussion_r2723752943",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2723752943"
            },
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/25#discussion_r2723752943"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/25"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2723752943/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2723748842,
          "original_position": 25,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-24T06:10:52Z"
    },
    {
      "id": "6034752041",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "review": {
          "id": 3700788721,
          "node_id": "PRR_kwDOQuIaMM7clY3x",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "14be9c66ad14e0fc192367f93cce06e50491d53f",
          "submitted_at": "2026-01-24T06:10:23Z",
          "state": "commented",
          "html_url": "https://github.com/madanlalit/heimdall/pull/25#pullrequestreview-3700788721",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "_links": {
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/25#pullrequestreview-3700788721"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/25"
            }
          },
          "updated_at": "2026-01-24T06:10:23Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-24T06:10:23Z"
    },
    {
      "id": "6034752000",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2723751273",
          "pull_request_review_id": 3700788721,
          "id": 2723751273,
          "node_id": "PRRC_kwDOQuIaMM6iWSVp",
          "diff_hunk": "@@ -52,10 +52,10 @@ dev = [\n heimdall = \"heimdall.cli:app\"\n \n [project.urls]\n-Homepage = \"https://github.com/heimdall-automation/heimdall\"\n-Documentation = \"https://github.com/heimdall-automation/heimdall#readme\"\n-Repository = \"https://github.com/heimdall-automation/heimdall\"\n-Issues = \"https://github.com/heimdall-automation/heimdall/issues\"\n+Homepage = \"https://github.com/madanlalit/heimdall\"",
          "path": "pyproject.toml",
          "commit_id": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
          "original_commit_id": "14be9c66ad14e0fc192367f93cce06e50491d53f",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "This is correct.",
          "created_at": "2026-01-24T06:10:23Z",
          "updated_at": "2026-01-24T06:10:23Z",
          "html_url": "https://github.com/madanlalit/heimdall/pull/25#discussion_r2723751273",
          "pull_request_url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2723751273"
            },
            "html": {
              "href": "https://github.com/madanlalit/heimdall/pull/25#discussion_r2723751273"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/madanlalit/heimdall/pulls/25"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/comments/2723751273/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2723748844,
          "original_position": 8,
          "position": 8,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-24T06:10:23Z"
    },
    {
      "id": "7772726439",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30068216035,
        "ref": "refs/heads/feature/add-ci-workflow",
        "head": "82d32cae100b0ec445ab76598bd762b0b33a296e",
        "before": "14be9c66ad14e0fc192367f93cce06e50491d53f"
      },
      "public": true,
      "created_at": "2026-01-24T06:09:26Z"
    },
    {
      "id": "6034715613",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "opened",
        "number": 25,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/25",
          "id": 3205862503,
          "number": 25,
          "head": {
            "ref": "feature/add-ci-workflow",
            "sha": "00ef1ce6466e8e7179b6e31250111cb284ff1116",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "af53b78c4beb88502072711e47a82140c6a386c2",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-24T06:07:17Z"
    },
    {
      "id": "7772667734",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "ref": "feature/add-ci-workflow",
        "ref_type": "branch",
        "full_ref": "refs/heads/feature/add-ci-workflow",
        "master_branch": "main",
        "description": "The all-seeing agent for web automation.",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-24T06:06:08Z"
    },
    {
      "id": "6034251179",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1140879861,
        "name": "simpsoka/jules-companion",
        "url": "https://api.github.com/repos/simpsoka/jules-companion"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-24T05:11:35Z"
    },
    {
      "id": "7760553508",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30055986510,
        "ref": "refs/heads/main",
        "head": "af53b78c4beb88502072711e47a82140c6a386c2",
        "before": "07de9819615141b4fc453e6264460e0fb2fdfb99"
      },
      "public": true,
      "created_at": "2026-01-23T18:31:06Z"
    },
    {
      "id": "7760435124",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30055867595,
        "ref": "refs/heads/main",
        "head": "07de9819615141b4fc453e6264460e0fb2fdfb99",
        "before": "8d96cb3d5bfa08ef2cce6608b48278e4250ff84a"
      },
      "public": true,
      "created_at": "2026-01-23T18:26:28Z"
    },
    {
      "id": "6008895667",
      "type": "IssuesEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "closed",
        "issue": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24",
          "repository_url": "https://api.github.com/repos/madanlalit/heimdall",
          "labels_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/labels{/name}",
          "comments_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/comments",
          "events_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/events",
          "html_url": "https://github.com/madanlalit/heimdall/issues/24",
          "id": 3832038877,
          "node_id": "I_kwDOQuIaMM7kaEXd",
          "number": 24,
          "title": "Bug: Agent Incorrectly Resumes Session for Fresh Executions",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 9881271147,
              "node_id": "LA_kwDOQuIaMM8AAAACTPg7aw",
              "url": "https://api.github.com/repos/madanlalit/heimdall/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Something isn't working"
            }
          ],
          "state": "closed",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 1,
          "created_at": "2026-01-20T04:51:10Z",
          "updated_at": "2026-01-23T06:30:27Z",
          "closed_at": "2026-01-23T06:30:27Z",
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "# Bug: Agent Incorrectly Resumes Session for Fresh Executions\n\n## Description\n\nWhen running Heimdall with a fresh session, the agent incorrectly reports \"Resumed session\" and loads state from a previous execution, even though the user did not request to resume.\n\n## Reproduction Steps\n\n1. Run Heimdall with persistence enabled (default when using `--output`):\n   ```bash\n   python -m heimdall.cli run instructions.txt --demo\n   ```\n\n2. Observe the log output shows:\n   ```\n   INFO     Resumed session 21fefa8e at step 71\n   ```\n\n3. This occurs even though:\n   - No explicit resume flag was provided\n   - This is a fresh execution (not a continuation)\n   - The previous session was from a different run\n\n## Expected Behavior\n\n- Fresh executions should start from step 0 with a new session ID\n- \"Resumed session\" should only appear when:\n  - The user explicitly chooses to resume after a `Ctrl+C` pause\n  - A clear resume flag/option is provided\n  - The saved state is from a very recent session (e.g., within the last hour)\n\n## Actual Behavior\n\n- Agent loads state from any previous execution with the same task string\n- Session continues from the saved step count\n- No way to start fresh without manually deleting `.heimdall_state.json`\n\n## Root Cause Analysis\n\nThe bug is in [`src/heimdall/agent/loop.py:203-233`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py#L203-L233):\n\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done:  #  ISSUE HERE\n            self._session_id = persisted.session_id\n            # ... restore state ...\n            restored = True\n            logger.info(\n                f\"Resumed session {self._session_id} at step {self._state.step_count}\"\n            )\n```\n\n### Problems\n\n1. **Overly permissive matching**: The condition `persisted.task == task and not persisted.done` will match ANY previous execution with the same task string, regardless of:\n   - When it was run (could be from days ago)\n   - Whether it was paused intentionally or crashed\n   - Whether the user intends to resume\n\n2. **No explicit resume intent**: There's no mechanism for the user to indicate they want to resume vs. start fresh\n\n3. **Missing staleness check**: Old saved states should be ignored or require explicit confirmation\n\n4. **Paused state ignored**: The saved state has `paused: true`, but this field is not checked. Only intentionally paused sessions should be auto-resumed.\n\n## Evidence\n\nSaved state file content (`output/.heimdall_state.json`):\n```json\n{\n  \"session_id\": \"21fefa8e\",\n  \"task\": \"Start replying until you reply to 10 different posts and only post replies nothing else\",\n  \"step_count\": 75,\n  \"done\": false,\n  \"success\": false,\n  \"paused\": true,\n  \"started_at\": \"2026-01-20T10:16:21.977943\",\n  \"paused_at\": \"2026-01-20T10:16:21.977833\"\n}\n```\n\nThis state from a previous run is being restored even though it's from a different execution.\n\n## Proposed Solutions\n\n### Option 1: Add Explicit Resume Flag (Recommended)\n\nAdd a `--resume` CLI flag that must be explicitly set to resume from saved state:\n\n**CLI changes** (`src/heimdall/cli.py`):\n```python\n@app.command()\ndef run(\n    # ... existing args ...\n    resume: bool = typer.Option(False, \"--resume\", help=\"Resume from saved state if available\"),\n)\n```\n\n**Agent config** (`src/heimdall/agent/loop.py:AgentConfig`):\n```python\nclass AgentConfig(BaseModel):\n    # ... existing fields ...\n    allow_resume: bool = False  # Only resume if explicitly allowed\n```\n\n**Resume logic** (`src/heimdall/agent/loop.py:203-233`):\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._config.allow_resume  #  NEW: Require explicit opt-in\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done and persisted.paused:\n            # ... restore state ...\n```\n\n### Option 2: Time-Based Auto-Resume\n\nOnly auto-resume if the saved state is very recent (e.g., within last hour):\n\n```python\nfrom datetime import datetime, timedelta\n\npersisted = await self._state_manager.load_state()\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Check if state is recent\n    paused_time = datetime.fromisoformat(persisted.paused_at)\n    time_since_pause = datetime.now() - paused_time\n    \n    if time_since_pause < timedelta(hours=1):\n        # Auto-resume recent paused sessions\n        restored = True\n    else:\n        # Ask user or start fresh\n        logger.info(f\"Found paused session from {time_since_pause.total_seconds()/3600:.1f} hours ago\")\n        logger.info(\"Use --resume flag to continue from saved state\")\n```\n\n### Option 3: Interactive Prompt\n\nPrompt the user when saved state is found:\n\n```python\nif persisted and persisted.task == task and not persisted.done:\n    from rich.console import Console\n    console = Console()\n    \n    resume = console.input(\n        f\"Found saved session at step {persisted.step_count}. Resume? [y/N]: \"\n    )\n    \n    if resume.lower() == 'y':\n        restored = True\n```\n\n## Recommended Fix\n\nImplement **Option 1** (explicit `--resume` flag) because:\n- Most predictable behavior for users\n- Allows both workflows (fresh start vs. resume) to coexist\n- No surprising auto-resume behavior\n- Still supports pause/resume within a single execution via `Ctrl+C`\n\nAdditionally, add a check for `persisted.paused` to ensure only intentionally paused sessions are eligible for resume:\n\n```python\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Only resume paused sessions, not crashed/failed ones\n```\n\n## Additional Context\n\n- Persistence is currently always enabled when using `--output` (line 228 in `cli.py`)\n- The pause/resume feature using `Ctrl+C` works correctly within a single execution\n- The issue only affects cross-execution state restoration\n\n## Related Files\n\n- [`src/heimdall/agent/loop.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py) - Agent execution loop with resume logic\n- [`src/heimdall/persistence/state.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/persistence/state.py) - State management\n- [`src/heimdall/cli.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/cli.py) - CLI interface\n\n## Environment\n\n- OS: macOS\n- Heimdall version: Latest (from repo)\n- Python version: 3.12\n",
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/timeline",
          "performed_via_github_app": null,
          "state_reason": "completed"
        }
      },
      "public": true,
      "created_at": "2026-01-23T06:30:28Z"
    },
    {
      "id": "6008895402",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24",
          "repository_url": "https://api.github.com/repos/madanlalit/heimdall",
          "labels_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/labels{/name}",
          "comments_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/comments",
          "events_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/events",
          "html_url": "https://github.com/madanlalit/heimdall/issues/24",
          "id": 3832038877,
          "node_id": "I_kwDOQuIaMM7kaEXd",
          "number": 24,
          "title": "Bug: Agent Incorrectly Resumes Session for Fresh Executions",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 9881271147,
              "node_id": "LA_kwDOQuIaMM8AAAACTPg7aw",
              "url": "https://api.github.com/repos/madanlalit/heimdall/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Something isn't working"
            }
          ],
          "state": "closed",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 1,
          "created_at": "2026-01-20T04:51:10Z",
          "updated_at": "2026-01-23T06:30:27Z",
          "closed_at": "2026-01-23T06:30:27Z",
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "# Bug: Agent Incorrectly Resumes Session for Fresh Executions\n\n## Description\n\nWhen running Heimdall with a fresh session, the agent incorrectly reports \"Resumed session\" and loads state from a previous execution, even though the user did not request to resume.\n\n## Reproduction Steps\n\n1. Run Heimdall with persistence enabled (default when using `--output`):\n   ```bash\n   python -m heimdall.cli run instructions.txt --demo\n   ```\n\n2. Observe the log output shows:\n   ```\n   INFO     Resumed session 21fefa8e at step 71\n   ```\n\n3. This occurs even though:\n   - No explicit resume flag was provided\n   - This is a fresh execution (not a continuation)\n   - The previous session was from a different run\n\n## Expected Behavior\n\n- Fresh executions should start from step 0 with a new session ID\n- \"Resumed session\" should only appear when:\n  - The user explicitly chooses to resume after a `Ctrl+C` pause\n  - A clear resume flag/option is provided\n  - The saved state is from a very recent session (e.g., within the last hour)\n\n## Actual Behavior\n\n- Agent loads state from any previous execution with the same task string\n- Session continues from the saved step count\n- No way to start fresh without manually deleting `.heimdall_state.json`\n\n## Root Cause Analysis\n\nThe bug is in [`src/heimdall/agent/loop.py:203-233`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py#L203-L233):\n\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done:  #  ISSUE HERE\n            self._session_id = persisted.session_id\n            # ... restore state ...\n            restored = True\n            logger.info(\n                f\"Resumed session {self._session_id} at step {self._state.step_count}\"\n            )\n```\n\n### Problems\n\n1. **Overly permissive matching**: The condition `persisted.task == task and not persisted.done` will match ANY previous execution with the same task string, regardless of:\n   - When it was run (could be from days ago)\n   - Whether it was paused intentionally or crashed\n   - Whether the user intends to resume\n\n2. **No explicit resume intent**: There's no mechanism for the user to indicate they want to resume vs. start fresh\n\n3. **Missing staleness check**: Old saved states should be ignored or require explicit confirmation\n\n4. **Paused state ignored**: The saved state has `paused: true`, but this field is not checked. Only intentionally paused sessions should be auto-resumed.\n\n## Evidence\n\nSaved state file content (`output/.heimdall_state.json`):\n```json\n{\n  \"session_id\": \"21fefa8e\",\n  \"task\": \"Start replying until you reply to 10 different posts and only post replies nothing else\",\n  \"step_count\": 75,\n  \"done\": false,\n  \"success\": false,\n  \"paused\": true,\n  \"started_at\": \"2026-01-20T10:16:21.977943\",\n  \"paused_at\": \"2026-01-20T10:16:21.977833\"\n}\n```\n\nThis state from a previous run is being restored even though it's from a different execution.\n\n## Proposed Solutions\n\n### Option 1: Add Explicit Resume Flag (Recommended)\n\nAdd a `--resume` CLI flag that must be explicitly set to resume from saved state:\n\n**CLI changes** (`src/heimdall/cli.py`):\n```python\n@app.command()\ndef run(\n    # ... existing args ...\n    resume: bool = typer.Option(False, \"--resume\", help=\"Resume from saved state if available\"),\n)\n```\n\n**Agent config** (`src/heimdall/agent/loop.py:AgentConfig`):\n```python\nclass AgentConfig(BaseModel):\n    # ... existing fields ...\n    allow_resume: bool = False  # Only resume if explicitly allowed\n```\n\n**Resume logic** (`src/heimdall/agent/loop.py:203-233`):\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._config.allow_resume  #  NEW: Require explicit opt-in\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done and persisted.paused:\n            # ... restore state ...\n```\n\n### Option 2: Time-Based Auto-Resume\n\nOnly auto-resume if the saved state is very recent (e.g., within last hour):\n\n```python\nfrom datetime import datetime, timedelta\n\npersisted = await self._state_manager.load_state()\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Check if state is recent\n    paused_time = datetime.fromisoformat(persisted.paused_at)\n    time_since_pause = datetime.now() - paused_time\n    \n    if time_since_pause < timedelta(hours=1):\n        # Auto-resume recent paused sessions\n        restored = True\n    else:\n        # Ask user or start fresh\n        logger.info(f\"Found paused session from {time_since_pause.total_seconds()/3600:.1f} hours ago\")\n        logger.info(\"Use --resume flag to continue from saved state\")\n```\n\n### Option 3: Interactive Prompt\n\nPrompt the user when saved state is found:\n\n```python\nif persisted and persisted.task == task and not persisted.done:\n    from rich.console import Console\n    console = Console()\n    \n    resume = console.input(\n        f\"Found saved session at step {persisted.step_count}. Resume? [y/N]: \"\n    )\n    \n    if resume.lower() == 'y':\n        restored = True\n```\n\n## Recommended Fix\n\nImplement **Option 1** (explicit `--resume` flag) because:\n- Most predictable behavior for users\n- Allows both workflows (fresh start vs. resume) to coexist\n- No surprising auto-resume behavior\n- Still supports pause/resume within a single execution via `Ctrl+C`\n\nAdditionally, add a check for `persisted.paused` to ensure only intentionally paused sessions are eligible for resume:\n\n```python\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Only resume paused sessions, not crashed/failed ones\n```\n\n## Additional Context\n\n- Persistence is currently always enabled when using `--output` (line 228 in `cli.py`)\n- The pause/resume feature using `Ctrl+C` works correctly within a single execution\n- The issue only affects cross-execution state restoration\n\n## Related Files\n\n- [`src/heimdall/agent/loop.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py) - Agent execution loop with resume logic\n- [`src/heimdall/persistence/state.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/persistence/state.py) - State management\n- [`src/heimdall/cli.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/cli.py) - CLI interface\n\n## Environment\n\n- OS: macOS\n- Heimdall version: Latest (from repo)\n- Python version: 3.12\n",
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/timeline",
          "performed_via_github_app": null,
          "state_reason": "completed"
        },
        "comment": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/comments/3788536514",
          "html_url": "https://github.com/madanlalit/heimdall/issues/24#issuecomment-3788536514",
          "issue_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24",
          "id": 3788536514,
          "node_id": "IC_kwDOQuIaMM7h0HrC",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-23T06:30:26Z",
          "updated_at": "2026-01-23T06:30:26Z",
          "body": "Fixed in commit 86aa906\n\nImplemented run_id-based session management with --run-id flag for explicit resume control.\n\nKey improvements:\n- Fresh executions default to starting from step 0 (no auto-resume)\n- Each run gets a unique 8-char UUID\n- State files organized in .heimdall/runs/{run_id}/\n- Multiple paused sessions can coexist\n- Specific error messages for resume failures",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/comments/3788536514/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-23T06:30:26Z"
    },
    {
      "id": "7740951695",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "repository_id": 1122114096,
        "push_id": 30036363685,
        "ref": "refs/heads/main",
        "head": "8d96cb3d5bfa08ef2cce6608b48278e4250ff84a",
        "before": "f63ffda749266a2654777937f17df5974020f0f6"
      },
      "public": true,
      "created_at": "2026-01-23T06:23:07Z"
    },
    {
      "id": "5999918800",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1139459824,
        "name": "junaid-mahmood/nlsh",
        "url": "https://api.github.com/repos/junaid-mahmood/nlsh"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-22T20:21:08Z"
    },
    {
      "id": "5968630103",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1137741043,
        "name": "anthropics/original_performance_takehome",
        "url": "https://api.github.com/repos/anthropics/original_performance_takehome"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-21T19:14:24Z",
      "org": {
        "id": 76263028,
        "login": "anthropics",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/anthropics",
        "avatar_url": "https://avatars.githubusercontent.com/u/76263028?"
      }
    },
    {
      "id": "7690435311",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1115612558,
        "name": "madanlalit/personal-blog",
        "url": "https://api.github.com/repos/madanlalit/personal-blog"
      },
      "payload": {
        "repository_id": 1115612558,
        "push_id": 29985420446,
        "ref": "refs/heads/main",
        "head": "402af8cfa0d023a05b16e294ab3611e2bc38b476",
        "before": "29b92d1a297ccbda257cbf85634ef59f4d88d500"
      },
      "public": true,
      "created_at": "2026-01-21T18:35:55Z"
    },
    {
      "id": "7689687010",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1115612558,
        "name": "madanlalit/personal-blog",
        "url": "https://api.github.com/repos/madanlalit/personal-blog"
      },
      "payload": {
        "repository_id": 1115612558,
        "push_id": 29985170896,
        "ref": "refs/heads/main",
        "head": "29b92d1a297ccbda257cbf85634ef59f4d88d500",
        "before": "e8efee518ccb3afd41d5a842fb2388f3830f1c9b"
      },
      "public": true,
      "created_at": "2026-01-21T18:26:51Z"
    },
    {
      "id": "5956336993",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1136590548,
        "name": "affaan-m/everything-claude-code",
        "url": "https://api.github.com/repos/affaan-m/everything-claude-code"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-21T11:48:39Z"
    },
    {
      "id": "5949847150",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/4052",
          "id": 3836082252,
          "node_id": "I_kwDOMMa-Ps7kpfhM",
          "number": 4052,
          "title": "Meta: Issue & PR Prioritization in the age of AI-assisted coding",
          "user": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7905065900,
              "node_id": "LA_kwDOMMa-Ps8AAAAB1y27rA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/meta",
              "name": "meta",
              "color": "8762F9",
              "default": false,
              "description": "high level, conceptual"
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 10,
          "created_at": "2026-01-21T00:58:06Z",
          "updated_at": "2026-01-27T20:46:04Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "Hey Pydantic AI community!\n\nAs you may have noticed, we/I haven't been as quick to respond to issues, review PRs, or release new versions since the holidays, compared to the same-day response/review and one-release-a-day cadence we got used to during 2025.\n\n## Prioritization\n\nPart of the story is that inevitably, as the popularity of an open source project grows, so do the number of notifications that land in its maintainers' GitHub inboxes every day, meaning that last year's \"treat every contributor like a colleague and every issue/PR notification like a top priority\" approach was never going to be sustainable forever.\n\nWe were able to mostly maintain that through the first year of Pydantic AI's existence, and I know that our \"extension of your team\"-level responsiveness has been much appreciated and (not unimportantly considering that we are a business) a significant factor in converting Pydantic AI users to [Pydantic Logfire](https://pydantic.dev/logfire) customers.\n\nBut already by the last few months of the year, it was becoming clear that this user-interrupt-driven approach to prioritization was starting to get in the way of working on more significant improvements and new capabilities that will benefit everyone building agents using Pydantic AI (like [Code Mode](https://github.com/pydantic/pydantic-ai/issues/4050) (aka Programmatic Tool Calling), [Progressive Tool Disclosure](https://github.com/pydantic/pydantic-ai/issues/3590) (aka Deferred Tool Loading), [Sub-Agents](https://github.com/pydantic/pydantic-ai/issues/1978), and [Guardrails](https://github.com/pydantic/pydantic-ai/issues/1197)), whereas users' issues and PRs typically focus on improving existing features around the edges: the faster horse as opposed to the car.\n\nThankfully, the community has done an awesome job stepping in to fill the gap with packages like [pydantic-deep](https://github.com/vstorm-co/pydantic-deepagents) and more listed on <https://github.com/vstorm-co/awesome-pydantic-ai> (in line with our preference for providing strong foundations and abstractions like `AbstractToolset` and `AbstractAgent` that people can build on, as opposed to coming with every battery included), but we agree that some of those features should just be in the core framework. (I'm happy to share that we expect to ship Code Mode and Progressive Tool Disclosure in the next week or two!)\n\nThis means that we're going to need to implement an (AI-assisted!) process for prioritizing issues and PRs for response and review, more explicitly taking into account factors like the number of users who would benefit, alignment with our vision for the project in project and AI engineering in general, the amount of effort that was put in by the contributor, and the time it will take us to aid them in getting it to the point where we'd be confident merging it and maintaining it indefinitely.\n\nThe bottom line is that we're dropping the expectation that every single issue/PR will get human attention, quickly or at all, while making it clear what motivated contributors can do to get their favorite items up the queue. \n\nI have some ideas on how we can do this that I will share later this week, and I'd love to hear your suggestions as well.\n\n## Impact of AI-assisted coding on open source contributions\n\n\"More usage means more issues and PRs\" is only half of the story, though, as eloquently pointed out by a user on [an issue](https://github.com/pydantic/pydantic-ai/issues/3885) created during the holidays that took me much longer to get to than I would've liked:\n\n> \"**Is AI actually making y'all slower rather than faster?**\"\n\nAs someone who's [been working full time on open source developer tools](https://douwe.me/) for the past 10 years, the answer has in recent months unfortunately become \"**yes**\".\n\nIt used to be that it took significantly more effort for a contributor to create a PR or address a round of feedback than it took for a maintainer to review a PR, creating some natural back-pressure on the number of PRs that are requesting a new round of review each day. Similarly, the ratio between new issues and PRs would typically favor the former, at least when it came to new features, as it's much easier to share an idea than to go through the effort of building it -- and most people wouldn't anyway until they'd validated that the maintainer would accept a particular solution.\n\nA single maintainer could arrive to 20 new issues and 10 new PRs on Monday morning, review them all over the course of a few hours, and then expect to have code trickle in throughout the week as contributors found time to incorporate the feedback or start on an issue, plus some amount of new items each day, at a similar rate to other issues/PRs being closed/merged. \n\nEspecially large PRs adding significant new functionality and public APIs, that consume the most time and mental energy to review, would typically be spread out over multiple weeks this way, ensuring both contributor and maintainer spent enough time with it in mind to be confident in the design and implications, and allowing maintainers to juggle them along with (much more numerous) smaller PRs (that would get more frequent updates and reviews) and work they want to prioritize themselves.\n\nMaintainers would also be able to assume that any big PR whose code looked good had significant mental effort put into it by another competent engineer who themselves needed the feature and thus had the necessary context to make design decisions about it, allowing the maintainer to offload some of the mental load on the contributor and juggle more PRs and context switches at the same time. \n\nObviously none of that is the case anymore today, meaning that on top of the community of users and contributors growing, the amount of work any given community member can create for the maintainer has been growing quickly as well. (To give you an idea, after the holidays I came back to about 150 new GitHub notifications, more than half of which were PRs in want of review, and most mornings I arrive to 40+ new notifications of which at least 2/3rds are PRs.)\n\nOf course, maintainers can and should also use AI to reduce their review workload by automating (parts of) the code review process and moving various types of project-specific rules and \"things only the maintainer knows\" from review time to development time through things like `AGENTS.md` and specialized sub-agents, and I'm excited to start implementing those for Pydantic AI as well. \n\nBut at the end of the day, the maintainer remains responsible for every line of code, behavior, and public API that makes it into the project (in a sense, a maintainer owes its users that in return for the trust that they have placed in them by choosing the project as part of their stack), and thus their eyes and brain will remain a bottleneck until that expectation changes (which it very well might in coming years, if all open source code converges to \"by AI, for AI\").\n\nSo in addition to changes we need to make around triage and prioritization in general, I think we need to look into ways to _increase_ the barrier for contribution, in order to:\n- ensure that the mental load and sense of responsibility for the changes (especially the behavior and public API) are appropriately shared between the contributor and maintainer,\n\t- meaning, among other things, that the maintainer can never be the first human to critically read a PR line-by-line -- the contributor has to be the \"first line of defense\" between the AI and the maintainer, and understand why every line is there in that particular way,\n- discourage going straight-to-code on big changes in a well-meaning attempt to be helpful, when:\n    - the feature really should've spent some more time in the planning stage (as in: hashing out the details in the issue, likely with help from e.g. Claude Code's plan mode), or when\n    - the user was not well suited to implement it as they did not themselves experience the problem or have a need for the solution -- they just wanted to be helpful and/or boost their GitHub numbers.\n\nI have some ideas on that front as well that I will share later this week -- and I'd love to hear your thoughts too.\n\nPS. If you're interested in reading what other open source maintainers have written on the subject, Claude found me these recent discussions on Hacker News:\n- [\"We need a clearer framework for AI-assisted contributions to open source\"](https://news.ycombinator.com/item?id=45731321)\n- [\"Are open source maintainers going to be the main sufferers from LLM\"](https://news.ycombinator.com/item?id=46637295 )\n- [\"AI and Open Source: A Maintainer's Take\"](https://news.ycombinator.com/item?id=46453713  )\n- [\"AI tooling must be disclosed for contributions\"](https://github.com/ghostty-org/ghostty/pull/8289)\n- [\"Agent Psychosis: Are We Going Insane?\"](https://news.ycombinator.com/item?id=46666777)\n- [\"Ghostty: AI Usage Policy\"](https://news.ycombinator.com/item?id=46730504)",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052/reactions",
            "total_count": 16,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 16,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3776506296",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/4052#issuecomment-3776506296",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/4052",
          "id": 3776506296,
          "node_id": "IC_kwDOMMa-Ps7hGOm4",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-21T07:04:55Z",
          "updated_at": "2026-01-21T07:04:55Z",
          "body": "@DouweM I hope this doesn't restrict people who genuinely want to make valuable contributions.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3776506296/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-21T07:04:55Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5938345776",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 28457823,
        "name": "freeCodeCamp/freeCodeCamp",
        "url": "https://api.github.com/repos/freeCodeCamp/freeCodeCamp"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-20T18:46:51Z",
      "org": {
        "id": 9892522,
        "login": "freeCodeCamp",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/freeCodeCamp",
        "avatar_url": "https://avatars.githubusercontent.com/u/9892522?"
      }
    },
    {
      "id": "7637628870",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1138098401,
        "name": "madanlalit/python-checklist",
        "url": "https://api.github.com/repos/madanlalit/python-checklist"
      },
      "payload": {
        "repository_id": 1138098401,
        "push_id": 29932938902,
        "ref": "refs/heads/main",
        "head": "8958f6f0c786e2024ae18c6db8378b932c6954ba",
        "before": "5b268d64b12fda1b5c792c796fc1ea1ed3efd412"
      },
      "public": true,
      "created_at": "2026-01-20T09:17:29Z"
    },
    {
      "id": "7636591513",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1138098401,
        "name": "madanlalit/python-checklist",
        "url": "https://api.github.com/repos/madanlalit/python-checklist"
      },
      "payload": {
        "ref": "main",
        "ref_type": "branch",
        "full_ref": "refs/heads/main",
        "master_branch": "main",
        "description": null,
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-20T08:41:00Z"
    },
    {
      "id": "5920357666",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1137846174,
        "name": "xai-org/x-algorithm",
        "url": "https://api.github.com/repos/xai-org/x-algorithm"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-20T06:01:26Z",
      "org": {
        "id": 130314967,
        "login": "xai-org",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/xai-org",
        "avatar_url": "https://avatars.githubusercontent.com/u/130314967?"
      }
    },
    {
      "id": "5919454163",
      "type": "IssuesEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "labeled",
        "issue": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24",
          "repository_url": "https://api.github.com/repos/madanlalit/heimdall",
          "labels_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/labels{/name}",
          "comments_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/comments",
          "events_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/events",
          "html_url": "https://github.com/madanlalit/heimdall/issues/24",
          "id": 3832038877,
          "node_id": "I_kwDOQuIaMM7kaEXd",
          "number": 24,
          "title": "Bug: Agent Incorrectly Resumes Session for Fresh Executions",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 9881271147,
              "node_id": "LA_kwDOQuIaMM8AAAACTPg7aw",
              "url": "https://api.github.com/repos/madanlalit/heimdall/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Something isn't working"
            }
          ],
          "state": "closed",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 1,
          "created_at": "2026-01-20T04:51:10Z",
          "updated_at": "2026-01-23T06:30:27Z",
          "closed_at": "2026-01-23T06:30:27Z",
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "# Bug: Agent Incorrectly Resumes Session for Fresh Executions\n\n## Description\n\nWhen running Heimdall with a fresh session, the agent incorrectly reports \"Resumed session\" and loads state from a previous execution, even though the user did not request to resume.\n\n## Reproduction Steps\n\n1. Run Heimdall with persistence enabled (default when using `--output`):\n   ```bash\n   python -m heimdall.cli run instructions.txt --demo\n   ```\n\n2. Observe the log output shows:\n   ```\n   INFO     Resumed session 21fefa8e at step 71\n   ```\n\n3. This occurs even though:\n   - No explicit resume flag was provided\n   - This is a fresh execution (not a continuation)\n   - The previous session was from a different run\n\n## Expected Behavior\n\n- Fresh executions should start from step 0 with a new session ID\n- \"Resumed session\" should only appear when:\n  - The user explicitly chooses to resume after a `Ctrl+C` pause\n  - A clear resume flag/option is provided\n  - The saved state is from a very recent session (e.g., within the last hour)\n\n## Actual Behavior\n\n- Agent loads state from any previous execution with the same task string\n- Session continues from the saved step count\n- No way to start fresh without manually deleting `.heimdall_state.json`\n\n## Root Cause Analysis\n\nThe bug is in [`src/heimdall/agent/loop.py:203-233`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py#L203-L233):\n\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done:  #  ISSUE HERE\n            self._session_id = persisted.session_id\n            # ... restore state ...\n            restored = True\n            logger.info(\n                f\"Resumed session {self._session_id} at step {self._state.step_count}\"\n            )\n```\n\n### Problems\n\n1. **Overly permissive matching**: The condition `persisted.task == task and not persisted.done` will match ANY previous execution with the same task string, regardless of:\n   - When it was run (could be from days ago)\n   - Whether it was paused intentionally or crashed\n   - Whether the user intends to resume\n\n2. **No explicit resume intent**: There's no mechanism for the user to indicate they want to resume vs. start fresh\n\n3. **Missing staleness check**: Old saved states should be ignored or require explicit confirmation\n\n4. **Paused state ignored**: The saved state has `paused: true`, but this field is not checked. Only intentionally paused sessions should be auto-resumed.\n\n## Evidence\n\nSaved state file content (`output/.heimdall_state.json`):\n```json\n{\n  \"session_id\": \"21fefa8e\",\n  \"task\": \"Start replying until you reply to 10 different posts and only post replies nothing else\",\n  \"step_count\": 75,\n  \"done\": false,\n  \"success\": false,\n  \"paused\": true,\n  \"started_at\": \"2026-01-20T10:16:21.977943\",\n  \"paused_at\": \"2026-01-20T10:16:21.977833\"\n}\n```\n\nThis state from a previous run is being restored even though it's from a different execution.\n\n## Proposed Solutions\n\n### Option 1: Add Explicit Resume Flag (Recommended)\n\nAdd a `--resume` CLI flag that must be explicitly set to resume from saved state:\n\n**CLI changes** (`src/heimdall/cli.py`):\n```python\n@app.command()\ndef run(\n    # ... existing args ...\n    resume: bool = typer.Option(False, \"--resume\", help=\"Resume from saved state if available\"),\n)\n```\n\n**Agent config** (`src/heimdall/agent/loop.py:AgentConfig`):\n```python\nclass AgentConfig(BaseModel):\n    # ... existing fields ...\n    allow_resume: bool = False  # Only resume if explicitly allowed\n```\n\n**Resume logic** (`src/heimdall/agent/loop.py:203-233`):\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._config.allow_resume  #  NEW: Require explicit opt-in\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done and persisted.paused:\n            # ... restore state ...\n```\n\n### Option 2: Time-Based Auto-Resume\n\nOnly auto-resume if the saved state is very recent (e.g., within last hour):\n\n```python\nfrom datetime import datetime, timedelta\n\npersisted = await self._state_manager.load_state()\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Check if state is recent\n    paused_time = datetime.fromisoformat(persisted.paused_at)\n    time_since_pause = datetime.now() - paused_time\n    \n    if time_since_pause < timedelta(hours=1):\n        # Auto-resume recent paused sessions\n        restored = True\n    else:\n        # Ask user or start fresh\n        logger.info(f\"Found paused session from {time_since_pause.total_seconds()/3600:.1f} hours ago\")\n        logger.info(\"Use --resume flag to continue from saved state\")\n```\n\n### Option 3: Interactive Prompt\n\nPrompt the user when saved state is found:\n\n```python\nif persisted and persisted.task == task and not persisted.done:\n    from rich.console import Console\n    console = Console()\n    \n    resume = console.input(\n        f\"Found saved session at step {persisted.step_count}. Resume? [y/N]: \"\n    )\n    \n    if resume.lower() == 'y':\n        restored = True\n```\n\n## Recommended Fix\n\nImplement **Option 1** (explicit `--resume` flag) because:\n- Most predictable behavior for users\n- Allows both workflows (fresh start vs. resume) to coexist\n- No surprising auto-resume behavior\n- Still supports pause/resume within a single execution via `Ctrl+C`\n\nAdditionally, add a check for `persisted.paused` to ensure only intentionally paused sessions are eligible for resume:\n\n```python\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Only resume paused sessions, not crashed/failed ones\n```\n\n## Additional Context\n\n- Persistence is currently always enabled when using `--output` (line 228 in `cli.py`)\n- The pause/resume feature using `Ctrl+C` works correctly within a single execution\n- The issue only affects cross-execution state restoration\n\n## Related Files\n\n- [`src/heimdall/agent/loop.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py) - Agent execution loop with resume logic\n- [`src/heimdall/persistence/state.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/persistence/state.py) - State management\n- [`src/heimdall/cli.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/cli.py) - CLI interface\n\n## Environment\n\n- OS: macOS\n- Heimdall version: Latest (from repo)\n- Python version: 3.12\n",
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/timeline",
          "performed_via_github_app": null,
          "state_reason": "completed"
        },
        "label": {
          "id": 9881271147,
          "node_id": "LA_kwDOQuIaMM8AAAACTPg7aw",
          "url": "https://api.github.com/repos/madanlalit/heimdall/labels/bug",
          "name": "bug",
          "color": "d73a4a",
          "default": true,
          "description": "Something isn't working"
        },
        "labels": [
          {
            "id": 9881271147,
            "node_id": "LA_kwDOQuIaMM8AAAACTPg7aw",
            "url": "https://api.github.com/repos/madanlalit/heimdall/labels/bug",
            "name": "bug",
            "color": "d73a4a",
            "default": true,
            "description": "Something isn't working"
          }
        ]
      },
      "public": true,
      "created_at": "2026-01-20T04:51:11Z"
    },
    {
      "id": "5919454109",
      "type": "IssuesEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "opened",
        "issue": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24",
          "repository_url": "https://api.github.com/repos/madanlalit/heimdall",
          "labels_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/labels{/name}",
          "comments_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/comments",
          "events_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/events",
          "html_url": "https://github.com/madanlalit/heimdall/issues/24",
          "id": 3832038877,
          "node_id": "I_kwDOQuIaMM7kaEXd",
          "number": 24,
          "title": "Bug: Agent Incorrectly Resumes Session for Fresh Executions",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 9881271147,
              "node_id": "LA_kwDOQuIaMM8AAAACTPg7aw",
              "url": "https://api.github.com/repos/madanlalit/heimdall/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Something isn't working"
            }
          ],
          "state": "closed",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 1,
          "created_at": "2026-01-20T04:51:10Z",
          "updated_at": "2026-01-23T06:30:27Z",
          "closed_at": "2026-01-23T06:30:27Z",
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "# Bug: Agent Incorrectly Resumes Session for Fresh Executions\n\n## Description\n\nWhen running Heimdall with a fresh session, the agent incorrectly reports \"Resumed session\" and loads state from a previous execution, even though the user did not request to resume.\n\n## Reproduction Steps\n\n1. Run Heimdall with persistence enabled (default when using `--output`):\n   ```bash\n   python -m heimdall.cli run instructions.txt --demo\n   ```\n\n2. Observe the log output shows:\n   ```\n   INFO     Resumed session 21fefa8e at step 71\n   ```\n\n3. This occurs even though:\n   - No explicit resume flag was provided\n   - This is a fresh execution (not a continuation)\n   - The previous session was from a different run\n\n## Expected Behavior\n\n- Fresh executions should start from step 0 with a new session ID\n- \"Resumed session\" should only appear when:\n  - The user explicitly chooses to resume after a `Ctrl+C` pause\n  - A clear resume flag/option is provided\n  - The saved state is from a very recent session (e.g., within the last hour)\n\n## Actual Behavior\n\n- Agent loads state from any previous execution with the same task string\n- Session continues from the saved step count\n- No way to start fresh without manually deleting `.heimdall_state.json`\n\n## Root Cause Analysis\n\nThe bug is in [`src/heimdall/agent/loop.py:203-233`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py#L203-L233):\n\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done:  #  ISSUE HERE\n            self._session_id = persisted.session_id\n            # ... restore state ...\n            restored = True\n            logger.info(\n                f\"Resumed session {self._session_id} at step {self._state.step_count}\"\n            )\n```\n\n### Problems\n\n1. **Overly permissive matching**: The condition `persisted.task == task and not persisted.done` will match ANY previous execution with the same task string, regardless of:\n   - When it was run (could be from days ago)\n   - Whether it was paused intentionally or crashed\n   - Whether the user intends to resume\n\n2. **No explicit resume intent**: There's no mechanism for the user to indicate they want to resume vs. start fresh\n\n3. **Missing staleness check**: Old saved states should be ignored or require explicit confirmation\n\n4. **Paused state ignored**: The saved state has `paused: true`, but this field is not checked. Only intentionally paused sessions should be auto-resumed.\n\n## Evidence\n\nSaved state file content (`output/.heimdall_state.json`):\n```json\n{\n  \"session_id\": \"21fefa8e\",\n  \"task\": \"Start replying until you reply to 10 different posts and only post replies nothing else\",\n  \"step_count\": 75,\n  \"done\": false,\n  \"success\": false,\n  \"paused\": true,\n  \"started_at\": \"2026-01-20T10:16:21.977943\",\n  \"paused_at\": \"2026-01-20T10:16:21.977833\"\n}\n```\n\nThis state from a previous run is being restored even though it's from a different execution.\n\n## Proposed Solutions\n\n### Option 1: Add Explicit Resume Flag (Recommended)\n\nAdd a `--resume` CLI flag that must be explicitly set to resume from saved state:\n\n**CLI changes** (`src/heimdall/cli.py`):\n```python\n@app.command()\ndef run(\n    # ... existing args ...\n    resume: bool = typer.Option(False, \"--resume\", help=\"Resume from saved state if available\"),\n)\n```\n\n**Agent config** (`src/heimdall/agent/loop.py:AgentConfig`):\n```python\nclass AgentConfig(BaseModel):\n    # ... existing fields ...\n    allow_resume: bool = False  # Only resume if explicitly allowed\n```\n\n**Resume logic** (`src/heimdall/agent/loop.py:203-233`):\n```python\n# Try to resume from state if available\nrestored = False\nif (\n    self._config.enable_persistence\n    and self._config.allow_resume  #  NEW: Require explicit opt-in\n    and self._state_manager\n    and self._state_manager.has_saved_state\n):\n    try:\n        persisted = await self._state_manager.load_state()\n        if persisted and persisted.task == task and not persisted.done and persisted.paused:\n            # ... restore state ...\n```\n\n### Option 2: Time-Based Auto-Resume\n\nOnly auto-resume if the saved state is very recent (e.g., within last hour):\n\n```python\nfrom datetime import datetime, timedelta\n\npersisted = await self._state_manager.load_state()\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Check if state is recent\n    paused_time = datetime.fromisoformat(persisted.paused_at)\n    time_since_pause = datetime.now() - paused_time\n    \n    if time_since_pause < timedelta(hours=1):\n        # Auto-resume recent paused sessions\n        restored = True\n    else:\n        # Ask user or start fresh\n        logger.info(f\"Found paused session from {time_since_pause.total_seconds()/3600:.1f} hours ago\")\n        logger.info(\"Use --resume flag to continue from saved state\")\n```\n\n### Option 3: Interactive Prompt\n\nPrompt the user when saved state is found:\n\n```python\nif persisted and persisted.task == task and not persisted.done:\n    from rich.console import Console\n    console = Console()\n    \n    resume = console.input(\n        f\"Found saved session at step {persisted.step_count}. Resume? [y/N]: \"\n    )\n    \n    if resume.lower() == 'y':\n        restored = True\n```\n\n## Recommended Fix\n\nImplement **Option 1** (explicit `--resume` flag) because:\n- Most predictable behavior for users\n- Allows both workflows (fresh start vs. resume) to coexist\n- No surprising auto-resume behavior\n- Still supports pause/resume within a single execution via `Ctrl+C`\n\nAdditionally, add a check for `persisted.paused` to ensure only intentionally paused sessions are eligible for resume:\n\n```python\nif persisted and persisted.task == task and not persisted.done and persisted.paused:\n    # Only resume paused sessions, not crashed/failed ones\n```\n\n## Additional Context\n\n- Persistence is currently always enabled when using `--output` (line 228 in `cli.py`)\n- The pause/resume feature using `Ctrl+C` works correctly within a single execution\n- The issue only affects cross-execution state restoration\n\n## Related Files\n\n- [`src/heimdall/agent/loop.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/agent/loop.py) - Agent execution loop with resume logic\n- [`src/heimdall/persistence/state.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/persistence/state.py) - State management\n- [`src/heimdall/cli.py`](file:///Users/black/Documents/repo/heimdall/src/heimdall/cli.py) - CLI interface\n\n## Environment\n\n- OS: macOS\n- Heimdall version: Latest (from repo)\n- Python version: 3.12\n",
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/madanlalit/heimdall/issues/24/timeline",
          "performed_via_github_app": null,
          "state_reason": "completed"
        }
      },
      "public": true,
      "created_at": "2026-01-20T04:51:11Z"
    },
    {
      "id": "5909553255",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1133911335,
        "name": "different-ai/openwork",
        "url": "https://api.github.com/repos/different-ai/openwork"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-19T16:24:19Z",
      "org": {
        "id": 118544361,
        "login": "different-ai",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/different-ai",
        "avatar_url": "https://avatars.githubusercontent.com/u/118544361?"
      }
    },
    {
      "id": "5909552343",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1133924528,
        "name": "21st-dev/1code",
        "url": "https://api.github.com/repos/21st-dev/1code"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-19T16:24:18Z",
      "org": {
        "id": 199367026,
        "login": "21st-dev",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/21st-dev",
        "avatar_url": "https://avatars.githubusercontent.com/u/199367026?"
      }
    },
    {
      "id": "5889136741",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 971447302,
        "name": "cactus-compute/cactus",
        "url": "https://api.github.com/repos/cactus-compute/cactus"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-18T18:40:19Z",
      "org": {
        "id": 196640840,
        "login": "cactus-compute",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/cactus-compute",
        "avatar_url": "https://avatars.githubusercontent.com/u/196640840?"
      }
    },
    {
      "id": "7584142912",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29879407361,
        "ref": "refs/heads/main",
        "head": "bae25eb55ea4c26b7c8b9e9ed0e5203c2f59a85b",
        "before": "df545314302a991754d995a1a53fab642de0d751"
      },
      "public": true,
      "created_at": "2026-01-18T13:16:34Z"
    },
    {
      "id": "5885975259",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 927848585,
        "name": "GGyll/fifty-advanced-python-concepts",
        "url": "https://api.github.com/repos/GGyll/fifty-advanced-python-concepts"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-18T10:09:42Z"
    },
    {
      "id": "5885774040",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1016323751,
        "name": "google/langextract",
        "url": "https://api.github.com/repos/google/langextract"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-18T09:32:59Z",
      "org": {
        "id": 1342004,
        "login": "google",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/google",
        "avatar_url": "https://avatars.githubusercontent.com/u/1342004?"
      }
    },
    {
      "id": "5885773260",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 648629873,
        "name": "puckeditor/puck",
        "url": "https://api.github.com/repos/puckeditor/puck"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-18T09:32:50Z",
      "org": {
        "id": 153829377,
        "login": "puckeditor",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/puckeditor",
        "avatar_url": "https://avatars.githubusercontent.com/u/153829377?"
      }
    },
    {
      "id": "5885773161",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1073224795,
        "name": "obra/superpowers",
        "url": "https://api.github.com/repos/obra/superpowers"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-18T09:32:49Z"
    },
    {
      "id": "7570787929",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29866035375,
        "ref": "refs/heads/main",
        "head": "da40ee31f27cfc534d986bdb27f7b1173b79fdd2",
        "before": "3a7a74b35dfa32db02a01fa9220d08621ad9d94a"
      },
      "public": true,
      "created_at": "2026-01-17T20:02:17Z"
    },
    {
      "id": "7570785981",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29866033422,
        "ref": "refs/heads/main",
        "head": "df545314302a991754d995a1a53fab642de0d751",
        "before": "b2d0e9806157491ce77e8df58f3dc27d3be55eeb"
      },
      "public": true,
      "created_at": "2026-01-17T20:02:09Z"
    },
    {
      "id": "5881282625",
      "type": "ReleaseEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "action": "published",
        "release": {
          "url": "https://api.github.com/repos/madanlalit/progress/releases/277647495",
          "assets_url": "https://api.github.com/repos/madanlalit/progress/releases/277647495/assets",
          "upload_url": "https://uploads.github.com/repos/madanlalit/progress/releases/277647495/assets{?name,label}",
          "html_url": "https://github.com/madanlalit/progress/releases/tag/v1.3.1",
          "id": 277647495,
          "author": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "node_id": "RE_kwDOQ6ilcc4QjJCH",
          "tag_name": "v1.3.1",
          "target_commitish": "main",
          "name": "v1.3.1 - Multiple Display Support",
          "draft": false,
          "immutable": false,
          "prerelease": false,
          "created_at": "2026-01-17T20:01:06Z",
          "updated_at": "2026-01-17T20:01:21Z",
          "published_at": "2026-01-17T20:01:21Z",
          "assets": [],
          "tarball_url": "https://api.github.com/repos/madanlalit/progress/tarball/v1.3.1",
          "zipball_url": "https://api.github.com/repos/madanlalit/progress/zipball/v1.3.1",
          "body": "## Changes\n\n- Added POSIX file support for proper wallpaper setting across multiple displays\n- Improved wallpaper update reliability\n\n## Upgrade\n\n```bash\nbrew update\nbrew upgrade madanlalit/tap/progress\nbrew services restart progress\n```",
          "short_description_html": "<h2>Changes</h2>\n<ul>\n<li>Added POSIX file support for proper wallpaper setting across multiple displays</li>\n<li>Improved wallpaper update reliability</li>\n</ul>\n<h2>Upgrade</h2>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"brew update\nbrew upgrade madanlalit/tap/progress\nbrew services restart progress\"><pre>brew update\nbrew upgrade madanlalit/tap/progress\nbrew services</pre></div>",
          "is_short_description_html_truncated": true
        }
      },
      "public": true,
      "created_at": "2026-01-17T20:01:21Z"
    },
    {
      "id": "7570770634",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29866018017,
        "ref": "refs/heads/main",
        "head": "b2d0e9806157491ce77e8df58f3dc27d3be55eeb",
        "before": "8c90b49556d50bbb61f133c746f56bab23046bbe"
      },
      "public": true,
      "created_at": "2026-01-17T20:01:08Z"
    },
    {
      "id": "7570764218",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29866011653,
        "ref": "refs/heads/main",
        "head": "8c90b49556d50bbb61f133c746f56bab23046bbe",
        "before": "e04aed5fae5a830fa7e597dca0257d20aebd0c7d"
      },
      "public": true,
      "created_at": "2026-01-17T20:00:47Z"
    },
    {
      "id": "7570654617",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29865901555,
        "ref": "refs/heads/main",
        "head": "3a7a74b35dfa32db02a01fa9220d08621ad9d94a",
        "before": "b4f3699771fec1af1d705a481e1243f86322798d"
      },
      "public": true,
      "created_at": "2026-01-17T19:52:43Z"
    },
    {
      "id": "7570653159",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29865900035,
        "ref": "refs/heads/main",
        "head": "e04aed5fae5a830fa7e597dca0257d20aebd0c7d",
        "before": "e48106ac24c42d89d470d5e2b7ac326800a34a3c"
      },
      "public": true,
      "created_at": "2026-01-17T19:52:36Z"
    },
    {
      "id": "5881212720",
      "type": "ReleaseEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "action": "published",
        "release": {
          "url": "https://api.github.com/repos/madanlalit/progress/releases/277646868",
          "assets_url": "https://api.github.com/repos/madanlalit/progress/releases/277646868/assets",
          "upload_url": "https://uploads.github.com/repos/madanlalit/progress/releases/277646868/assets{?name,label}",
          "html_url": "https://github.com/madanlalit/progress/releases/tag/v1.3.0",
          "id": 277646868,
          "author": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "node_id": "RE_kwDOQ6ilcc4QjI4U",
          "tag_name": "v1.3.0",
          "target_commitish": "main",
          "name": "v1.3.0 - Daily Cron Schedule",
          "draft": false,
          "immutable": false,
          "prerelease": false,
          "created_at": "2026-01-17T19:51:11Z",
          "updated_at": "2026-01-17T19:51:43Z",
          "published_at": "2026-01-17T19:51:43Z",
          "assets": [],
          "tarball_url": "https://api.github.com/repos/madanlalit/progress/tarball/v1.3.0",
          "zipball_url": "https://api.github.com/repos/madanlalit/progress/zipball/v1.3.0",
          "body": "## Changes\n\n- Changed service schedule from interval-based (every 12 hours) to cron-based (daily at 00:01)\n- More predictable wallpaper updates at midnight\n- Updated both main repo and homebrew-tap formulas\n\n## Installation\n\n```bash\nbrew install madanlalit/tap/progress\nbrew services start progress\n```\n\nThe wallpaper will now update daily at 00:01 AM.",
          "short_description_html": "<h2>Changes</h2>\n<ul>\n<li>Changed service schedule from interval-based (every 12 hours) to cron-based (daily at 00:01)</li>\n<li>More predictable wallpaper updates at midnight</li>\n<li>Updated both main repo and homebrew-tap formulas</li>\n</ul>\n<h2></h2>",
          "is_short_description_html_truncated": true
        }
      },
      "public": true,
      "created_at": "2026-01-17T19:51:43Z"
    },
    {
      "id": "7570636223",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29865883130,
        "ref": "refs/heads/main",
        "head": "e48106ac24c42d89d470d5e2b7ac326800a34a3c",
        "before": "3171c23962f2e5d1d9472604268034981b36f871"
      },
      "public": true,
      "created_at": "2026-01-17T19:51:18Z"
    },
    {
      "id": "7570627802",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29865874617,
        "ref": "refs/heads/main",
        "head": "b4f3699771fec1af1d705a481e1243f86322798d",
        "before": "97c48f69f69eee3fc5543bb99f2584708e8844d7"
      },
      "public": true,
      "created_at": "2026-01-17T19:50:39Z"
    },
    {
      "id": "7570590965",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29865837802,
        "ref": "refs/heads/main",
        "head": "3171c23962f2e5d1d9472604268034981b36f871",
        "before": "22056b28b494c3ad7a750789c00cf7894b767bca"
      },
      "public": true,
      "created_at": "2026-01-17T19:47:53Z"
    },
    {
      "id": "7561111679",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29856344679,
        "ref": "refs/heads/main",
        "head": "97c48f69f69eee3fc5543bb99f2584708e8844d7",
        "before": "081beeb6d79f55302b3c6a37cea7b2da8f79886c"
      },
      "public": true,
      "created_at": "2026-01-17T09:39:59Z"
    },
    {
      "id": "7561106361",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29856339403,
        "ref": "refs/heads/main",
        "head": "22056b28b494c3ad7a750789c00cf7894b767bca",
        "before": "0fb8ec2c829e9ce595b2ca2063866d087e38c7c3"
      },
      "public": true,
      "created_at": "2026-01-17T09:39:38Z"
    },
    {
      "id": "7561096026",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29856328967,
        "ref": "refs/heads/main",
        "head": "0fb8ec2c829e9ce595b2ca2063866d087e38c7c3",
        "before": "40bfa8a8a4eb3ae5db218030acc6d35c27e050f2"
      },
      "public": true,
      "created_at": "2026-01-17T09:38:58Z"
    },
    {
      "id": "7560878200",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29856110641,
        "ref": "refs/heads/main",
        "head": "081beeb6d79f55302b3c6a37cea7b2da8f79886c",
        "before": "87ff6c613d3ea947b41f0f10cf1928d0251854f9"
      },
      "public": true,
      "created_at": "2026-01-17T09:25:10Z"
    },
    {
      "id": "7560874636",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29856107092,
        "ref": "refs/heads/main",
        "head": "40bfa8a8a4eb3ae5db218030acc6d35c27e050f2",
        "before": "37b590e5d52405ba68156a65333059c65dd6fb98"
      },
      "public": true,
      "created_at": "2026-01-17T09:24:56Z"
    },
    {
      "id": "7560866391",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29856098859,
        "ref": "refs/heads/main",
        "head": "37b590e5d52405ba68156a65333059c65dd6fb98",
        "before": "eb028dd36a8cca2e11ce9146f0a0acdd32dae77c"
      },
      "public": true,
      "created_at": "2026-01-17T09:24:21Z"
    },
    {
      "id": "7560786839",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29856019185,
        "ref": "refs/heads/main",
        "head": "87ff6c613d3ea947b41f0f10cf1928d0251854f9",
        "before": "0156de3459725426d9b410058124fafe79afb71e"
      },
      "public": true,
      "created_at": "2026-01-17T09:19:53Z"
    },
    {
      "id": "7560783662",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29856016070,
        "ref": "refs/heads/main",
        "head": "eb028dd36a8cca2e11ce9146f0a0acdd32dae77c",
        "before": "4410a4ebed4fe78476599754486b7e9c8d489756"
      },
      "public": true,
      "created_at": "2026-01-17T09:19:40Z"
    },
    {
      "id": "7560733054",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29855965400,
        "ref": "refs/heads/main",
        "head": "4410a4ebed4fe78476599754486b7e9c8d489756",
        "before": "6ccb12df82b92ca9e24eab88a5b363c4d8c3d484"
      },
      "public": true,
      "created_at": "2026-01-17T09:16:30Z"
    },
    {
      "id": "7560728679",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29855961041,
        "ref": "refs/heads/main",
        "head": "0156de3459725426d9b410058124fafe79afb71e",
        "before": "5149ba043d6834ee304935987874d1dd8e85d8ef"
      },
      "public": true,
      "created_at": "2026-01-17T09:16:11Z"
    },
    {
      "id": "7550407841",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29845629964,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "7c37db13ae3ca80bd3011e68c26ea2eb0c455b56",
        "before": "a457e46147f52e972545d4db733a0ca7b0c1bc3c"
      },
      "public": true,
      "created_at": "2026-01-16T22:24:10Z"
    },
    {
      "id": "7550349336",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29845571434,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "a457e46147f52e972545d4db733a0ca7b0c1bc3c",
        "before": "cdaeff06ae5d4c7074855124ed07361a396892df"
      },
      "public": true,
      "created_at": "2026-01-16T22:21:17Z"
    },
    {
      "id": "5870672607",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672930714,
          "node_id": "PRR_kwDOMMa-Ps7a7Hma",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T22:11:24Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672930714",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672930714"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:11:24Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:11:25Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870672360",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700134133",
          "pull_request_review_id": 3672930714,
          "id": 2700134133,
          "node_id": "PRRC_kwDOMMa-Ps6g8Mb1",
          "diff_hunk": "@@ -114,12 +158,17 @@ async def index(request: Request) -> Response:\n         ui_version = version or DEFAULT_UI_VERSION",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "dropped the version query param and its related tests",
          "created_at": "2026-01-16T22:11:24Z",
          "updated_at": "2026-01-16T22:11:24Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700134133",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700134133"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700134133"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700134133/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699962953,
          "original_position": 99,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:11:24Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870665981",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672929230,
          "node_id": "PRR_kwDOMMa-Ps7a7HPO",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T22:10:59Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672929230",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672929230"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:10:59Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:11:00Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870665819",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700133035",
          "pull_request_review_id": 3672929230,
          "id": 2700133035,
          "node_id": "PRRC_kwDOMMa-Ps6g8MKr",
          "diff_hunk": "@@ -101,3 +101,47 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for offline usage (e.g., on a plane) or enterprise environments.\n+\n+### Offline Usage\n+\n+To use the web UI offline, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+```\n+\n+Then point your app to the downloaded file:\n+\n+```python\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use the downloaded local file (update the path to match where you saved it)\n+app = agent.to_web(ui_source='~/pydantic-ai-ui.html')\n+```\n+\n+### Other Use Cases\n+\n+You can also use `ui_source` with custom URLs or file paths:\n+\n+```python\n+from pathlib import Path\n+\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL (e.g., for enterprise environments)\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')",
          "path": "docs/web.md",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "consolidated all the examples",
          "created_at": "2026-01-16T22:10:59Z",
          "updated_at": "2026-01-16T22:10:59Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700133035",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700133035"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700133035"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700133035/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699959250,
          "original_position": 40,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:10:59Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870663154",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672928578,
          "node_id": "PRR_kwDOMMa-Ps7a7HFC",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T22:10:46Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672928578",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672928578"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:10:46Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:10:48Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870662496",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700132364",
          "pull_request_review_id": 3672928578,
          "id": 2700132364,
          "node_id": "PRRC_kwDOMMa-Ps6g8MAM",
          "diff_hunk": "@@ -101,3 +101,47 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for offline usage (e.g., on a plane) or enterprise environments.\n+\n+### Offline Usage\n+\n+To use the web UI offline, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+```\n+\n+Then point your app to the downloaded file:\n+\n+```python\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use the downloaded local file (update the path to match where you saved it)\n+app = agent.to_web(ui_source='~/pydantic-ai-ui.html')\n+```\n+\n+### Other Use Cases\n+\n+You can also use `ui_source` with custom URLs or file paths:\n+\n+```python\n+from pathlib import Path\n+\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL (e.g., for enterprise environments)\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')\n+\n+# Use a local file path as a string\n+app = agent.to_web(ui_source='/path/to/local/ui.html')",
          "path": "docs/web.md",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "removed it ",
          "created_at": "2026-01-16T22:10:46Z",
          "updated_at": "2026-01-16T22:10:46Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700132364",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700132364"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700132364"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700132364/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699958632,
          "original_position": 43,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:10:46Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870660505",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672928016,
          "node_id": "PRR_kwDOMMa-Ps7a7G8Q",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T22:10:36Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672928016",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672928016"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:10:36Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:10:39Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870659960",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700131804",
          "pull_request_review_id": 3672928016,
          "id": 2700131804,
          "node_id": "PRRC_kwDOMMa-Ps6g8L3c",
          "diff_hunk": "@@ -101,3 +101,47 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for offline usage (e.g., on a plane) or enterprise environments.\n+\n+### Offline Usage\n+\n+To use the web UI offline, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+```\n+\n+Then point your app to the downloaded file:\n+\n+```python\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use the downloaded local file (update the path to match where you saved it)\n+app = agent.to_web(ui_source='~/pydantic-ai-ui.html')\n+```\n+\n+### Other Use Cases\n+\n+You can also use `ui_source` with custom URLs or file paths:\n+\n+```python\n+from pathlib import Path\n+\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL (e.g., for enterprise environments)\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')\n+\n+# Use a local file path as a string\n+app = agent.to_web(ui_source='/path/to/local/ui.html')\n+\n+# Use a Path instance\n+app = agent.to_web(ui_source=Path('/path/to/local/ui.html'))",
          "path": "docs/web.md",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "removed it ",
          "created_at": "2026-01-16T22:10:36Z",
          "updated_at": "2026-01-16T22:10:36Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700131804",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700131804"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700131804"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700131804/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699958476,
          "original_position": 46,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:10:36Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870657487",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672927505,
          "node_id": "PRR_kwDOMMa-Ps7a7G0R",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T22:10:25Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672927505",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672927505"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:10:25Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:10:28Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870656912",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700131372",
          "pull_request_review_id": 3672927505,
          "id": 2700131372,
          "node_id": "PRRC_kwDOMMa-Ps6g8Lws",
          "diff_hunk": "@@ -178,6 +178,10 @@ def _cli_web(args_list: list[str], prog_name: str, default_model: str, qualified\n         help=\"System instructions. When `--agent` is specified, these are additional to the agent's existing instructions \"\n         'and will be passed as extra instructions to each run.',\n     )\n+    parser.add_argument(\n+        '--ui-source',\n+        help='URL or file path for the chat UI HTML.',",
          "path": "pydantic_ai_slim/pydantic_ai/_cli/__init__.py",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "corrected the text to include the default behavior ",
          "created_at": "2026-01-16T22:10:25Z",
          "updated_at": "2026-01-16T22:10:26Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700131372",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700131372"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700131372"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700131372/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699956654,
          "original_position": 6,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:10:25Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870647426",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672925724,
          "node_id": "PRR_kwDOMMa-Ps7a7GYc",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-16T22:09:45Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672925724",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672925724"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:09:45Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:09:47Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870647114",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700129674",
          "pull_request_review_id": 3672925724,
          "id": 2700129674,
          "node_id": "PRRC_kwDOMMa-Ps6g8LWK",
          "diff_hunk": "@@ -509,3 +509,133 @@ async def test_instructions_passed_to_dispatch(monkeypatch: pytest.MonkeyPatch):\n     mock_dispatch.assert_called_once()\n     call_kwargs = mock_dispatch.call_args.kwargs\n     assert call_kwargs['instructions'] == 'Always respond in Spanish'\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_custom_cdn_url_parameter(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html uses custom cdn_url_template when provided.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    monkeypatch.setattr(app_module, '_get_cache_dir', lambda: tmp_path)\n+\n+    test_content = b'<html>Custom CDN UI</html>'\n+    captured_url: list[str] = []\n+\n+    class MockResponse:\n+        content = test_content\n+\n+        def raise_for_status(self) -> None:\n+            pass\n+\n+    class MockAsyncClient:\n+        async def __aenter__(self) -> MockAsyncClient:\n+            return self\n+\n+        async def __aexit__(self, *args: Any) -> None:\n+            pass\n+\n+        async def get(self, url: str) -> MockResponse:\n+            captured_url.append(url)\n+            return MockResponse()\n+\n+    monkeypatch.setattr(app_module.httpx, 'AsyncClient', MockAsyncClient)\n+\n+    from pydantic_ai.ui._web.app import _get_ui_html  # pyright: ignore[reportPrivateUsage]\n+\n+    custom_cdn = 'https://my-internal-cdn.example.com/ui@{version}/index.html'\n+    result = await _get_ui_html('1.0.0', cdn_url_template=custom_cdn)\n+\n+    assert result == test_content\n+    assert len(captured_url) == 1\n+    assert captured_url[0] == 'https://my-internal-cdn.example.com/ui@1.0.0/index.html'\n+\n+\n+def test_create_web_app_with_custom_cdn_url():\n+    \"\"\"Test that create_web_app accepts custom_cdn_url parameter.\"\"\"\n+    agent = Agent('test')\n+    app = create_web_app(agent, custom_cdn_url='https://custom-cdn.example.com/{version}/index.html')\n+\n+    assert isinstance(app, Starlette)",
          "path": "tests/test_ui_web.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "removed these kind of tests ",
          "created_at": "2026-01-16T22:09:45Z",
          "updated_at": "2026-01-16T22:09:45Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700129674",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700129674"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700129674"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700129674/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688347876,
          "original_position": 50,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:09:45Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870638310",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672924452,
          "node_id": "PRR_kwDOMMa-Ps7a7GEk",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-16T22:09:01Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672924452",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672924452"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:09:01Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:09:04Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870637814",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700128596",
          "pull_request_review_id": 3672924452,
          "id": 2700128596,
          "node_id": "PRRC_kwDOMMa-Ps6g8LFU",
          "diff_hunk": "@@ -52,15 +52,31 @@ def _sanitize_version(version: str) -> str:\n     return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n \n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n+async def _get_ui_html(version: str, cdn_url_template: str | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\n+\n+    Args:\n+        version: The UI version to fetch.\n+        cdn_url_template: Optional custom URL or file path for the chat UI.\n+            Falls back to the default CDN if not provided.\n+    \"\"\"\n+    cdn_url_template = cdn_url_template or CDN_URL_TEMPLATE\n+\n     cache_dir = _get_cache_dir()\n     cache_file = cache_dir / f'{_sanitize_version(version)}.html'\n \n     if cache_file.exists():\n         return cache_file.read_bytes()\n \n-    cdn_url = CDN_URL_TEMPLATE.format(version=version)\n+    cdn_url = cdn_url_template.format(version=version)\n+\n+    # Support local file paths\n+    if cdn_url.startswith(('/', '.', '~')) or (len(cdn_url) > 1 and cdn_url[1] == ':'):",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "added support for Path Instances",
          "created_at": "2026-01-16T22:09:01Z",
          "updated_at": "2026-01-16T22:09:02Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700128596",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700128596"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700128596"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700128596/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688346560,
          "original_position": 26,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:09:01Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870634157",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672923881,
          "node_id": "PRR_kwDOMMa-Ps7a7F7p",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-16T22:08:43Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672923881",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672923881"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T22:08:43Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T22:08:45Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5870633767",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700128069",
          "pull_request_review_id": 3672923881,
          "id": 2700128069,
          "node_id": "PRRC_kwDOMMa-Ps6g8K9F",
          "diff_hunk": "@@ -52,15 +52,31 @@ def _sanitize_version(version: str) -> str:\n     return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n \n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n+async def _get_ui_html(version: str, cdn_url_template: str | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\n+\n+    Args:\n+        version: The UI version to fetch.\n+        cdn_url_template: Optional custom URL or file path for the chat UI.",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "removed version url arg",
          "created_at": "2026-01-16T22:08:43Z",
          "updated_at": "2026-01-16T22:08:43Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700128069",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700128069"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2700128069"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2700128069/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688345485,
          "original_position": 11,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T22:08:43Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7549902995",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29845124646,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "cdaeff06ae5d4c7074855124ed07361a396892df",
        "before": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba"
      },
      "public": true,
      "created_at": "2026-01-16T22:00:23Z"
    },
    {
      "id": "7548773176",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29843993683,
        "ref": "refs/heads/main",
        "head": "a018b567642bbac3f5437388dfa4f8d09dba6a35",
        "before": "a401b6787159df6cdfa966f544a892e5f9040123"
      },
      "public": true,
      "created_at": "2026-01-16T21:09:48Z"
    },
    {
      "id": "5869662213",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672733405,
          "node_id": "PRR_kwDOMMa-Ps7a6Xbd",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T21:08:21Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672733405",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672733405"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T21:08:21Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T21:08:23Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869661670",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699972781",
          "pull_request_review_id": 3672733405,
          "id": 2699972781,
          "node_id": "PRRC_kwDOMMa-Ps6g7lCt",
          "diff_hunk": "@@ -101,3 +101,47 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for offline usage (e.g., on a plane) or enterprise environments.\n+\n+### Offline Usage\n+\n+To use the web UI offline, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+```\n+\n+Then point your app to the downloaded file:\n+\n+```python\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use the downloaded local file (update the path to match where you saved it)\n+app = agent.to_web(ui_source='~/pydantic-ai-ui.html')\n+```\n+\n+### Other Use Cases\n+\n+You can also use `ui_source` with custom URLs or file paths:\n+\n+```python\n+from pathlib import Path\n+\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL (e.g., for enterprise environments)\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')",
          "path": "docs/web.md",
          "commit_id": "8ac84ac781fe19db71ac18612e3afea6db843e0a",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure",
          "created_at": "2026-01-16T21:08:21Z",
          "updated_at": "2026-01-16T21:08:21Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699972781",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699972781"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699972781"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699972781/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699959250,
          "original_position": 40,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T21:08:21Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869659375",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672732991,
          "node_id": "PRR_kwDOMMa-Ps7a6XU_",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T21:08:10Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672732991",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672732991"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T21:08:10Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T21:08:11Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869659009",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699972465",
          "pull_request_review_id": 3672732991,
          "id": 2699972465,
          "node_id": "PRRC_kwDOMMa-Ps6g7k9x",
          "diff_hunk": "@@ -114,12 +158,17 @@ async def index(request: Request) -> Response:\n         ui_version = version or DEFAULT_UI_VERSION",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "okay will do that",
          "created_at": "2026-01-16T21:08:10Z",
          "updated_at": "2026-01-16T21:08:10Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699972465",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699972465"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699972465"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699972465/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699962953,
          "original_position": 99,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T21:08:10Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869645879",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672730962,
          "node_id": "PRR_kwDOMMa-Ps7a6W1S",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T21:07:16Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672730962",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672730962"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T21:07:16Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T21:07:18Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869645286",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699970608",
          "pull_request_review_id": 3672730962,
          "id": 2699970608,
          "node_id": "PRRC_kwDOMMa-Ps6g7kgw",
          "diff_hunk": "@@ -101,3 +101,47 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for offline usage (e.g., on a plane) or enterprise environments.\n+\n+### Offline Usage\n+\n+To use the web UI offline, download the UI HTML file once while you have internet access:\n+\n+```bash\n+curl -o ~/pydantic-ai-ui.html https://cdn.jsdelivr.net/npm/@pydantic/ai-chat-ui@1.0.0/dist/index.html\n+```\n+\n+Then point your app to the downloaded file:\n+\n+```python\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use the downloaded local file (update the path to match where you saved it)\n+app = agent.to_web(ui_source='~/pydantic-ai-ui.html')\n+```\n+\n+### Other Use Cases\n+\n+You can also use `ui_source` with custom URLs or file paths:\n+\n+```python\n+from pathlib import Path\n+\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL (e.g., for enterprise environments)\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')\n+\n+# Use a local file path as a string\n+app = agent.to_web(ui_source='/path/to/local/ui.html')\n+\n+# Use a Path instance\n+app = agent.to_web(ui_source=Path('/path/to/local/ui.html'))",
          "path": "docs/web.md",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "got it",
          "created_at": "2026-01-16T21:07:15Z",
          "updated_at": "2026-01-16T21:07:16Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699970608",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699970608"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699970608"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699970608/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699958476,
          "original_position": 46,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T21:07:15Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869642414",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3672730515,
          "node_id": "PRR_kwDOMMa-Ps7a6WuT",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "submitted_at": "2026-01-16T21:07:04Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672730515",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3672730515"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-16T21:07:04Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-16T21:07:05Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5869642151",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699970223",
          "pull_request_review_id": 3672730515,
          "id": 2699970223,
          "node_id": "PRRC_kwDOMMa-Ps6g7kav",
          "diff_hunk": "@@ -178,6 +178,10 @@ def _cli_web(args_list: list[str], prog_name: str, default_model: str, qualified\n         help=\"System instructions. When `--agent` is specified, these are additional to the agent's existing instructions \"\n         'and will be passed as extra instructions to each run.',\n     )\n+    parser.add_argument(\n+        '--ui-source',\n+        help='URL or file path for the chat UI HTML.',",
          "path": "pydantic_ai_slim/pydantic_ai/_cli/__init__.py",
          "commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "original_commit_id": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure",
          "created_at": "2026-01-16T21:07:04Z",
          "updated_at": "2026-01-16T21:07:04Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699970223",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699970223"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2699970223"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2699970223/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2699956654,
          "original_position": 6,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-16T21:07:04Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7540105192",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29835318050,
        "ref": "refs/heads/main",
        "head": "a401b6787159df6cdfa966f544a892e5f9040123",
        "before": "6dfd3a59058161703c5a1e65b110f7445bf334cc"
      },
      "public": true,
      "created_at": "2026-01-16T15:43:00Z"
    },
    {
      "id": "5859485673",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1134640384,
        "name": "openresponses/openresponses",
        "url": "https://api.github.com/repos/openresponses/openresponses"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-16T13:00:35Z",
      "org": {
        "id": 240075138,
        "login": "openresponses",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/openresponses",
        "avatar_url": "https://avatars.githubusercontent.com/u/240075138?"
      }
    },
    {
      "id": "5859320732",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 713419018,
        "name": "microsoft/sarathi-serve",
        "url": "https://api.github.com/repos/microsoft/sarathi-serve"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-16T12:52:45Z",
      "org": {
        "id": 6154722,
        "login": "microsoft",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/microsoft",
        "avatar_url": "https://avatars.githubusercontent.com/u/6154722?"
      }
    },
    {
      "id": "7532795410",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29828003863,
        "ref": "refs/heads/main",
        "head": "6ccb12df82b92ca9e24eab88a5b363c4d8c3d484",
        "before": "749ab30843ebf10ebf418a816b55cd3e1a93d11e"
      },
      "public": true,
      "created_at": "2026-01-16T11:39:14Z"
    },
    {
      "id": "7532787379",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120037664,
        "name": "madanlalit/homebrew-tap",
        "url": "https://api.github.com/repos/madanlalit/homebrew-tap"
      },
      "payload": {
        "repository_id": 1120037664,
        "push_id": 29827995969,
        "ref": "refs/heads/main",
        "head": "5149ba043d6834ee304935987874d1dd8e85d8ef",
        "before": "8759c004142db6f0f247aa69b59ab728821cb181"
      },
      "public": true,
      "created_at": "2026-01-16T11:38:54Z"
    },
    {
      "id": "5857849849",
      "type": "ReleaseEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "action": "published",
        "release": {
          "url": "https://api.github.com/repos/madanlalit/progress/releases/277369727",
          "assets_url": "https://api.github.com/repos/madanlalit/progress/releases/277369727/assets",
          "upload_url": "https://uploads.github.com/repos/madanlalit/progress/releases/277369727/assets{?name,label}",
          "html_url": "https://github.com/madanlalit/progress/releases/tag/v1.0.0",
          "id": 277369727,
          "author": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "node_id": "RE_kwDOQ6ilcc4QiFN_",
          "tag_name": "v1.0.0",
          "target_commitish": "main",
          "name": "v1.0.0",
          "draft": false,
          "immutable": false,
          "prerelease": false,
          "created_at": "2026-01-16T06:33:18Z",
          "updated_at": "2026-01-16T11:37:02Z",
          "published_at": "2026-01-16T11:37:02Z",
          "assets": [],
          "tarball_url": "https://api.github.com/repos/madanlalit/progress/tarball/v1.0.0",
          "zipball_url": "https://api.github.com/repos/madanlalit/progress/zipball/v1.0.0",
          "body": "Initial release of Progress - Beautiful year calendar wallpapers showing your yearly progress.\n\n## Features\n- Generate beautiful year calendar wallpapers\n- Day, week, and month tracking modes  \n- Automatic wallpaper setting on macOS\n- Customizable colors and themes",
          "short_description_html": "<p>Initial release of Progress - Beautiful year calendar wallpapers showing your yearly progress.</p>\n<h2>Features</h2>\n<ul>\n<li>Generate beautiful year calendar wallpapers</li>\n<li>Day, week, and month tracking modes</li>\n<li>Automatic wa</li>\n</ul>",
          "is_short_description_html_truncated": true
        }
      },
      "public": true,
      "created_at": "2026-01-16T11:37:02Z"
    },
    {
      "id": "7527272230",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29822475287,
        "ref": "refs/heads/main",
        "head": "749ab30843ebf10ebf418a816b55cd3e1a93d11e",
        "before": "2ab38e6e4515a7957e5fe8adb410082ecceba2e2"
      },
      "public": true,
      "created_at": "2026-01-16T08:02:08Z"
    },
    {
      "id": "5850277437",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1112540808,
        "name": "vercel-labs/agent-skills",
        "url": "https://api.github.com/repos/vercel-labs/agent-skills"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-16T05:10:43Z",
      "org": {
        "id": 108547162,
        "login": "vercel-labs",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/vercel-labs",
        "avatar_url": "https://avatars.githubusercontent.com/u/108547162?"
      }
    },
    {
      "id": "7509895160",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29805084047,
        "ref": "refs/heads/main",
        "head": "2ab38e6e4515a7957e5fe8adb410082ecceba2e2",
        "before": "b089c8a2e2614f6f50c22dcd19e2627dcd4d3e7c"
      },
      "public": true,
      "created_at": "2026-01-15T18:34:00Z"
    },
    {
      "id": "7507845662",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "repository_id": 1135125873,
        "push_id": 29803033379,
        "ref": "refs/heads/main",
        "head": "b089c8a2e2614f6f50c22dcd19e2627dcd4d3e7c",
        "before": "3b3d6bb3fac06fb1ed1bb10726de0d081bcbabd2"
      },
      "public": true,
      "created_at": "2026-01-15T17:15:50Z"
    },
    {
      "id": "7507796480",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1135125873,
        "name": "madanlalit/progress",
        "url": "https://api.github.com/repos/madanlalit/progress"
      },
      "payload": {
        "ref": "main",
        "ref_type": "branch",
        "full_ref": "refs/heads/main",
        "master_branch": "main",
        "description": "Python CLI for generating wallpapers that visualize yearly progress with custom themes and automatic daily updates.",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-15T17:13:57Z"
    },
    {
      "id": "7496228168",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29791412256,
        "ref": "refs/heads/main",
        "head": "6dfd3a59058161703c5a1e65b110f7445bf334cc",
        "before": "318d1d78b39a2a1bd6b868f375194cedb089310b"
      },
      "public": true,
      "created_at": "2026-01-15T10:41:27Z"
    },
    {
      "id": "7496082775",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132942317,
        "name": "madanlalit/agentskills",
        "url": "https://api.github.com/repos/madanlalit/agentskills"
      },
      "payload": {
        "repository_id": 1132942317,
        "push_id": 29791266907,
        "ref": "refs/heads/main",
        "head": "174a31a3e09adaaa9384539918693330a250985d",
        "before": "f31376815b3155d13d44c624a1b9693be80cfd40"
      },
      "public": true,
      "created_at": "2026-01-15T10:36:29Z"
    },
    {
      "id": "5829249234",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3754035373",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3754035373",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3754035373,
          "node_id": "IC_kwDOMMa-Ps7fwgit",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-15T10:22:44Z",
          "updated_at": "2026-01-15T10:22:44Z",
          "body": "Let me start by adding some tests to test_history_processor.py then.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3754035373/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-15T10:22:44Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7492819649",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132942317,
        "name": "madanlalit/agentskills",
        "url": "https://api.github.com/repos/madanlalit/agentskills"
      },
      "payload": {
        "repository_id": 1132942317,
        "push_id": 29787998247,
        "ref": "refs/heads/main",
        "head": "f31376815b3155d13d44c624a1b9693be80cfd40",
        "before": "81d04973c7520147ee3121374825b085deae30e3"
      },
      "public": true,
      "created_at": "2026-01-15T08:42:51Z"
    },
    {
      "id": "7488673042",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132942317,
        "name": "madanlalit/agentskills",
        "url": "https://api.github.com/repos/madanlalit/agentskills"
      },
      "payload": {
        "repository_id": 1132942317,
        "push_id": 29783843876,
        "ref": "refs/heads/main",
        "head": "81d04973c7520147ee3121374825b085deae30e3",
        "before": "ef3a907d3758aac1e3a4275530ed8208df6bfc0c"
      },
      "public": true,
      "created_at": "2026-01-15T05:38:31Z"
    },
    {
      "id": "7470546272",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1115612558,
        "name": "madanlalit/personal-blog",
        "url": "https://api.github.com/repos/madanlalit/personal-blog"
      },
      "payload": {
        "repository_id": 1115612558,
        "push_id": 29765674003,
        "ref": "refs/heads/main",
        "head": "197c13139f0f43efa324de72e9be042975b86193",
        "before": "89801a081bc51112a514f2b46d4cf9e0d1dc5c9a"
      },
      "public": true,
      "created_at": "2026-01-14T16:24:33Z"
    },
    {
      "id": "5809139012",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3986",
          "id": 3805686003,
          "node_id": "I_kwDOMMa-Ps7i1ijz",
          "number": 3986,
          "title": "Add You.com as a web search tool",
          "user": {
            "login": "itsakhilyou",
            "id": 215518986,
            "node_id": "U_kgDODNiPCg",
            "avatar_url": "https://avatars.githubusercontent.com/u/215518986?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/itsakhilyou",
            "html_url": "https://github.com/itsakhilyou",
            "followers_url": "https://api.github.com/users/itsakhilyou/followers",
            "following_url": "https://api.github.com/users/itsakhilyou/following{/other_user}",
            "gists_url": "https://api.github.com/users/itsakhilyou/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/itsakhilyou/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/itsakhilyou/subscriptions",
            "organizations_url": "https://api.github.com/users/itsakhilyou/orgs",
            "repos_url": "https://api.github.com/users/itsakhilyou/repos",
            "events_url": "https://api.github.com/users/itsakhilyou/events{/privacy}",
            "received_events_url": "https://api.github.com/users/itsakhilyou/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547185,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/feature",
              "name": "feature",
              "color": "a2eeef",
              "default": false,
              "description": "New feature request, or PR implementing a feature (enhancement)"
            },
            {
              "id": 8096520310,
              "node_id": "LA_kwDOMMa-Ps8AAAAB4pcYdg",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/tools",
              "name": "tools",
              "color": "aaaaaa",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 8,
          "created_at": "2026-01-12T19:28:40Z",
          "updated_at": "2026-01-14T15:16:35Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Description\n\nThe You.com Search API delivers highly recent and relevant, structured **web** and **news** results optimized for programmatic access. Designed for developers building AI applications like RAG systems, AI agents, knowledge bases, and data-driven applications. Our Search API returns clean, structured data with rich metadata, relevant snippets, and optional full-page content. Learn more here: https://docs.you.com/search/overview\n\nSimilar to DuckDuckGo and Tavily, we'd love to make [You.com's](https://you.com/apis) search technology available to developers via Pydantic AI.\n\nSimilar to perplexity or chatgpt + web search, we have a consumer product that grounds LLM responses in our search results. Try it out for free at [you.com](https://you.com/)!\n \nrelated PR, adding Tavily: https://github.com/pydantic/pydantic-ai/pull/1001\nrelated issue: https://github.com/pydantic/pydantic-ai/issues/911\n\nIn a world where it is increasingly important to build applications that are highly aware of the world around us, we think that developers on your platform will find a lot of utility in our Search + other APIs. This is a priority for us - please let me know what I can do to help build this. I'm also happy to use the other PRs as references and open one myself! Thanks for reading  \n\n### References\n\n_No response_",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3750045436",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3986#issuecomment-3750045436",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986",
          "id": 3750045436,
          "node_id": "IC_kwDOMMa-Ps7fhSb8",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-14T15:16:35Z",
          "updated_at": "2026-01-14T15:16:35Z",
          "body": "will do thanks @itsakhilyou ",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3750045436/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-14T15:16:35Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5809089138",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3661264429,
          "node_id": "PRR_kwDOMMa-Ps7aOnYt",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "submitted_at": "2026-01-14T15:14:41Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3661264429",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3661264429"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T15:14:41Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T15:14:43Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5809088419",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690872034",
          "pull_request_review_id": 3661264429,
          "id": 2690872034,
          "node_id": "PRRC_kwDOMMa-Ps6gY3Li",
          "diff_hunk": "@@ -1644,6 +1646,12 @@ def to_web(\n             deps: Optional dependencies to use for all requests.\n             model_settings: Optional settings to use for all model requests.\n             instructions: Optional extra instructions to pass to each agent run.\n+            ui_source: Source for the chat UI HTML. Can be:\n+                - None (default): Fetches from CDN and caches locally\n+                - A Path instance: Reads from the local file\n+                - A string starting with '<': Treated as raw HTML content",
          "path": "pydantic_ai_slim/pydantic_ai/agent/__init__.py",
          "commit_id": "38688c367dbaa373ffe27165cadf0868d1fc100c",
          "original_commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "removed it",
          "created_at": "2026-01-14T15:14:41Z",
          "updated_at": "2026-01-14T15:14:41Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690872034",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690872034"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690872034"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690872034/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2690087725,
          "original_position": 31,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T15:14:41Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5809081601",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3661263204,
          "node_id": "PRR_kwDOMMa-Ps7aOnFk",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "submitted_at": "2026-01-14T15:14:24Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3661263204",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3661263204"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T15:14:24Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T15:14:25Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5809081306",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690870932",
          "pull_request_review_id": 3661263204,
          "id": 2690870932,
          "node_id": "PRRC_kwDOMMa-Ps6gY26U",
          "diff_hunk": "@@ -101,3 +101,27 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for enterprise environments, offline usage, or custom UI builds.\n+\n+```python\n+from pathlib import Path\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')\n+\n+# Use a local file path (string)\n+app = agent.to_web(ui_source='/path/to/local/ui.html')\n+\n+# Use a Path instance\n+app = agent.to_web(ui_source=Path('/path/to/local/ui.html'))\n+\n+# Use raw HTML directly\n+app = agent.to_web(ui_source='<html><body>My custom UI</body></html>')\n+```\n+",
          "path": "docs/web.md",
          "commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "original_commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "I have updated the docs @Kludex ",
          "created_at": "2026-01-14T15:14:24Z",
          "updated_at": "2026-01-14T15:14:24Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690870932",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690870932"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690870932"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690870932/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2690086090,
          "original_position": 27,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T15:14:24Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5809067017",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3661260743,
          "node_id": "PRR_kwDOMMa-Ps7aOmfH",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T15:13:49Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3661260743",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3661260743"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T15:13:49Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T15:13:50Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5809066589",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690868753",
          "pull_request_review_id": 3661260743,
          "id": 2690868753,
          "node_id": "PRRC_kwDOMMa-Ps6gY2YR",
          "diff_hunk": "@@ -52,15 +52,31 @@ def _sanitize_version(version: str) -> str:\n     return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n \n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n+async def _get_ui_html(version: str, cdn_url_template: str | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\n+\n+    Args:\n+        version: The UI version to fetch.\n+        cdn_url_template: Optional custom URL or file path for the chat UI.",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "Plus there are some tests which depend on this",
          "created_at": "2026-01-14T15:13:49Z",
          "updated_at": "2026-01-14T15:13:49Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690868753",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690868753"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690868753"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690868753/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688345485,
          "original_position": 11,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T15:13:49Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7467669886",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29762792690,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "be36839e6c1f150e4fa211f7d3bda9ee2670a3ba",
        "before": "02ec7573dbd469a7a0cb10565bd24e5cd9f3eaf8"
      },
      "public": true,
      "created_at": "2026-01-14T14:56:23Z"
    },
    {
      "id": "7466098272",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29761219289,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "02ec7573dbd469a7a0cb10565bd24e5cd9f3eaf8",
        "before": "e9d4a2f1644eccae1909d8e7b8f982575c75927d"
      },
      "public": true,
      "created_at": "2026-01-14T14:09:26Z"
    },
    {
      "id": "7465585236",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29760705759,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "e9d4a2f1644eccae1909d8e7b8f982575c75927d",
        "before": "47b437a15641cf9a0947087fc7203480d0e5a875"
      },
      "public": true,
      "created_at": "2026-01-14T13:53:41Z"
    },
    {
      "id": "5806179980",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3660714989,
          "node_id": "PRR_kwDOMMa-Ps7aMhPt",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "submitted_at": "2026-01-14T13:20:33Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3660714989",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3660714989"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T13:20:33Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T13:20:35Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5806179553",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690409031",
          "pull_request_review_id": 3660714989,
          "id": 2690409031,
          "node_id": "PRRC_kwDOMMa-Ps6gXGJH",
          "diff_hunk": "@@ -1644,6 +1646,12 @@ def to_web(\n             deps: Optional dependencies to use for all requests.\n             model_settings: Optional settings to use for all model requests.\n             instructions: Optional extra instructions to pass to each agent run.\n+            ui_source: Source for the chat UI HTML. Can be:\n+                - None (default): Fetches from CDN and caches locally\n+                - A Path instance: Reads from the local file\n+                - A string starting with '<': Treated as raw HTML content",
          "path": "pydantic_ai_slim/pydantic_ai/agent/__init__.py",
          "commit_id": "38688c367dbaa373ffe27165cadf0868d1fc100c",
          "original_commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "okay will remove it",
          "created_at": "2026-01-14T13:20:33Z",
          "updated_at": "2026-01-14T13:20:33Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690409031",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690409031"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690409031"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690409031/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2690087725,
          "original_position": 31,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T13:20:33Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5806173572",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3660713781,
          "node_id": "PRR_kwDOMMa-Ps7aMg81",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "submitted_at": "2026-01-14T13:20:17Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3660713781",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3660713781"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T13:20:17Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T13:20:19Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5806172675",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690408111",
          "pull_request_review_id": 3660713781,
          "id": 2690408111,
          "node_id": "PRRC_kwDOMMa-Ps6gXF6v",
          "diff_hunk": "@@ -101,3 +101,27 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom UI Source\n+\n+By default, the web UI is fetched from a CDN and cached locally. You can provide a `ui_source` to override this behavior for enterprise environments, offline usage, or custom UI builds.\n+\n+```python\n+from pathlib import Path\n+from pydantic_ai import Agent\n+\n+agent = Agent('openai:gpt-5')\n+\n+# Use a custom URL\n+app = agent.to_web(ui_source='https://cdn.example.com/ui/index.html')\n+\n+# Use a local file path (string)\n+app = agent.to_web(ui_source='/path/to/local/ui.html')\n+\n+# Use a Path instance\n+app = agent.to_web(ui_source=Path('/path/to/local/ui.html'))\n+\n+# Use raw HTML directly\n+app = agent.to_web(ui_source='<html><body>My custom UI</body></html>')\n+```\n+",
          "path": "docs/web.md",
          "commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "original_commit_id": "47b437a15641cf9a0947087fc7203480d0e5a875",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure",
          "created_at": "2026-01-14T13:20:17Z",
          "updated_at": "2026-01-14T13:20:17Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690408111",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690408111"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2690408111"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2690408111/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2690086090,
          "original_position": 27,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T13:20:17Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801914020",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3659881109,
          "node_id": "PRR_kwDOMMa-Ps7aJVqV",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T10:05:49Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659881109",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659881109"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T10:05:49Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T10:05:50Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801913780",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689781989",
          "pull_request_review_id": 3659881109,
          "id": 2689781989,
          "node_id": "PRRC_kwDOMMa-Ps6gUtDl",
          "diff_hunk": "@@ -509,3 +509,133 @@ async def test_instructions_passed_to_dispatch(monkeypatch: pytest.MonkeyPatch):\n     mock_dispatch.assert_called_once()\n     call_kwargs = mock_dispatch.call_args.kwargs\n     assert call_kwargs['instructions'] == 'Always respond in Spanish'\n+\n+\n+@pytest.mark.anyio\n+async def test_get_ui_html_custom_cdn_url_parameter(monkeypatch: pytest.MonkeyPatch, tmp_path: Path):\n+    \"\"\"Test that _get_ui_html uses custom cdn_url_template when provided.\"\"\"\n+    import pydantic_ai.ui._web.app as app_module\n+\n+    monkeypatch.setattr(app_module, '_get_cache_dir', lambda: tmp_path)\n+\n+    test_content = b'<html>Custom CDN UI</html>'\n+    captured_url: list[str] = []\n+\n+    class MockResponse:\n+        content = test_content\n+\n+        def raise_for_status(self) -> None:\n+            pass\n+\n+    class MockAsyncClient:\n+        async def __aenter__(self) -> MockAsyncClient:\n+            return self\n+\n+        async def __aexit__(self, *args: Any) -> None:\n+            pass\n+\n+        async def get(self, url: str) -> MockResponse:\n+            captured_url.append(url)\n+            return MockResponse()\n+\n+    monkeypatch.setattr(app_module.httpx, 'AsyncClient', MockAsyncClient)\n+\n+    from pydantic_ai.ui._web.app import _get_ui_html  # pyright: ignore[reportPrivateUsage]\n+\n+    custom_cdn = 'https://my-internal-cdn.example.com/ui@{version}/index.html'\n+    result = await _get_ui_html('1.0.0', cdn_url_template=custom_cdn)\n+\n+    assert result == test_content\n+    assert len(captured_url) == 1\n+    assert captured_url[0] == 'https://my-internal-cdn.example.com/ui@1.0.0/index.html'\n+\n+\n+def test_create_web_app_with_custom_cdn_url():\n+    \"\"\"Test that create_web_app accepts custom_cdn_url parameter.\"\"\"\n+    agent = Agent('test')\n+    app = create_web_app(agent, custom_cdn_url='https://custom-cdn.example.com/{version}/index.html')\n+\n+    assert isinstance(app, Starlette)",
          "path": "tests/test_ui_web.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "This checks whether create_web_app supports ui_source and asserts that the instance is created successfully. I noticed several similar tests, so I added one specifically for the ui_source parameter as well.",
          "created_at": "2026-01-14T10:05:49Z",
          "updated_at": "2026-01-14T10:05:49Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689781989",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689781989"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689781989"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689781989/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688347876,
          "original_position": 50,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T10:05:49Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801860773",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3659871521,
          "node_id": "PRR_kwDOMMa-Ps7aJTUh",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T10:03:20Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659871521",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659871521"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T10:03:20Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T10:03:22Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801860110",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689774146",
          "pull_request_review_id": 3659871521,
          "id": 2689774146,
          "node_id": "PRRC_kwDOMMa-Ps6gUrJC",
          "diff_hunk": "@@ -52,15 +52,31 @@ def _sanitize_version(version: str) -> str:\n     return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n \n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n+async def _get_ui_html(version: str, cdn_url_template: str | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\n+\n+    Args:\n+        version: The UI version to fetch.\n+        cdn_url_template: Optional custom URL or file path for the chat UI.\n+            Falls back to the default CDN if not provided.\n+    \"\"\"\n+    cdn_url_template = cdn_url_template or CDN_URL_TEMPLATE\n+\n     cache_dir = _get_cache_dir()\n     cache_file = cache_dir / f'{_sanitize_version(version)}.html'\n \n     if cache_file.exists():\n         return cache_file.read_bytes()\n \n-    cdn_url = CDN_URL_TEMPLATE.format(version=version)\n+    cdn_url = cdn_url_template.format(version=version)\n+\n+    # Support local file paths\n+    if cdn_url.startswith(('/', '.', '~')) or (len(cdn_url) > 1 and cdn_url[1] == ':'):",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "Added support for Path instances and HTML String",
          "created_at": "2026-01-14T10:03:20Z",
          "updated_at": "2026-01-14T10:03:20Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689774146",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689774146"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689774146"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689774146/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688346560,
          "original_position": 26,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T10:03:20Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801849216",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3659869500,
          "node_id": "PRR_kwDOMMa-Ps7aJS08",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T10:02:50Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659869500",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659869500"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T10:02:50Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T10:02:51Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801848756",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689772569",
          "pull_request_review_id": 3659869500,
          "id": 2689772569,
          "node_id": "PRRC_kwDOMMa-Ps6gUqwZ",
          "diff_hunk": "@@ -52,15 +52,31 @@ def _sanitize_version(version: str) -> str:\n     return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n \n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n+async def _get_ui_html(version: str, cdn_url_template: str | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\n+\n+    Args:\n+        version: The UI version to fetch.\n+        cdn_url_template: Optional custom URL or file path for the chat UI.",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "We cant drop versioning entirely because the default CDN URL currently uses it.",
          "created_at": "2026-01-14T10:02:49Z",
          "updated_at": "2026-01-14T10:02:50Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689772569",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689772569"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689772569"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689772569/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688345485,
          "original_position": 11,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T10:02:49Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801788234",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3659858735,
          "node_id": "PRR_kwDOMMa-Ps7aJQMv",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T10:00:07Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659858735",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3659858735"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T10:00:07Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T10:00:08Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5801787974",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689763792",
          "pull_request_review_id": 3659858735,
          "id": 2689763792,
          "node_id": "PRRC_kwDOMMa-Ps6gUonQ",
          "diff_hunk": "@@ -101,3 +101,19 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom CDN or Local File Path",
          "path": "docs/web.md",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "changed it to ui_source",
          "created_at": "2026-01-14T10:00:07Z",
          "updated_at": "2026-01-14T10:00:07Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689763792",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689763792"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2689763792"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2689763792/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688342837,
          "original_position": 5,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T10:00:07Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7458655939",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29753762316,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "47b437a15641cf9a0947087fc7203480d0e5a875",
        "before": "70b21438240318d606fcc8493d9b9c657d7070ec"
      },
      "public": true,
      "created_at": "2026-01-14T09:59:12Z"
    },
    {
      "id": "5795275404",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2688795910",
          "pull_request_review_id": 3658680156,
          "id": 2688795910,
          "node_id": "PRRC_kwDOMMa-Ps6gQ8UG",
          "diff_hunk": "@@ -52,15 +52,31 @@ def _sanitize_version(version: str) -> str:\n     return re.sub(r'[^a-zA-Z0-9._-]', '_', version)\n \n \n-async def _get_ui_html(version: str) -> bytes:\n-    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\"\"\"\n+async def _get_ui_html(version: str, cdn_url_template: str | None = None) -> bytes:\n+    \"\"\"Get UI HTML content from filesystem cache or fetch from CDN.\n+\n+    Args:\n+        version: The UI version to fetch.\n+        cdn_url_template: Optional custom URL or file path for the chat UI.",
          "path": "pydantic_ai_slim/pydantic_ai/ui/_web/app.py",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "sure will drop the version entirely",
          "created_at": "2026-01-14T03:26:15Z",
          "updated_at": "2026-01-14T03:26:15Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2688795910",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2688795910"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2688795910"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2688795910/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688345485,
          "original_position": 11,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T03:26:15Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5795275403",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3658680156,
          "node_id": "PRR_kwDOMMa-Ps7aEwdc",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T03:26:15Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3658680156",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3658680156"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T03:26:15Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T03:26:16Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5795257315",
      "type": "PullRequestReviewCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2688793484",
          "pull_request_review_id": 3658677814,
          "id": 2688793484,
          "node_id": "PRRC_kwDOMMa-Ps6gQ7uM",
          "diff_hunk": "@@ -101,3 +101,19 @@ The web UI app uses the following routes which should not be overwritten:\n - `/api/health` - Health check (GET)\n \n The app cannot currently be mounted at a subpath (e.g., `/chat`) because the UI expects these routes at the root. You can add additional routes to the app, but avoid conflicts with these reserved paths.\n+\n+## Custom CDN or Local File Path",
          "path": "docs/web.md",
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "original_commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": "got it thanks!",
          "created_at": "2026-01-14T03:24:36Z",
          "updated_at": "2026-01-14T03:24:36Z",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2688793484",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "self": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2688793484"
            },
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#discussion_r2688793484"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/comments/2688793484/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "in_reply_to_id": 2688342837,
          "original_position": 5,
          "position": 1,
          "subject_type": "line"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-14T03:24:36Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5795257312",
      "type": "PullRequestReviewEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "review": {
          "id": 3658677814,
          "node_id": "PRR_kwDOMMa-Ps7aEv42",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "body": null,
          "commit_id": "70b21438240318d606fcc8493d9b9c657d7070ec",
          "submitted_at": "2026-01-14T03:24:36Z",
          "state": "commented",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3658677814",
          "pull_request_url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "_links": {
            "html": {
              "href": "https://github.com/pydantic/pydantic-ai/pull/3974#pullrequestreview-3658677814"
            },
            "pull_request": {
              "href": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974"
            }
          },
          "updated_at": "2026-01-14T03:24:36Z"
        },
        "pull_request": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
          "id": 3160864140,
          "number": 3974,
          "head": {
            "ref": "feat/custom-cdn-url",
            "sha": "2ef712f3a9d585597af3480182a36febee968b08",
            "repo": {
              "id": 1131286423,
              "url": "https://api.github.com/repos/madanlalit/pydantic-ai",
              "name": "pydantic-ai"
            }
          },
          "base": {
            "ref": "main",
            "sha": "94a47b111e1e694dae90f429b1cd5443cccf646a",
            "repo": {
              "id": 818331198,
              "url": "https://api.github.com/repos/pydantic/pydantic-ai",
              "name": "pydantic-ai"
            }
          }
        },
        "action": "created"
      },
      "public": true,
      "created_at": "2026-01-14T03:24:37Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5788343328",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3986",
          "id": 3805686003,
          "node_id": "I_kwDOMMa-Ps7i1ijz",
          "number": 3986,
          "title": "Add You.com as a web search tool",
          "user": {
            "login": "itsakhilyou",
            "id": 215518986,
            "node_id": "U_kgDODNiPCg",
            "avatar_url": "https://avatars.githubusercontent.com/u/215518986?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/itsakhilyou",
            "html_url": "https://github.com/itsakhilyou",
            "followers_url": "https://api.github.com/users/itsakhilyou/followers",
            "following_url": "https://api.github.com/users/itsakhilyou/following{/other_user}",
            "gists_url": "https://api.github.com/users/itsakhilyou/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/itsakhilyou/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/itsakhilyou/subscriptions",
            "organizations_url": "https://api.github.com/users/itsakhilyou/orgs",
            "repos_url": "https://api.github.com/users/itsakhilyou/repos",
            "events_url": "https://api.github.com/users/itsakhilyou/events{/privacy}",
            "received_events_url": "https://api.github.com/users/itsakhilyou/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547185,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/feature",
              "name": "feature",
              "color": "a2eeef",
              "default": false,
              "description": "New feature request, or PR implementing a feature (enhancement)"
            },
            {
              "id": 8096520310,
              "node_id": "LA_kwDOMMa-Ps8AAAAB4pcYdg",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/tools",
              "name": "tools",
              "color": "aaaaaa",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 8,
          "created_at": "2026-01-12T19:28:40Z",
          "updated_at": "2026-01-14T15:16:35Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Description\n\nThe You.com Search API delivers highly recent and relevant, structured **web** and **news** results optimized for programmatic access. Designed for developers building AI applications like RAG systems, AI agents, knowledge bases, and data-driven applications. Our Search API returns clean, structured data with rich metadata, relevant snippets, and optional full-page content. Learn more here: https://docs.you.com/search/overview\n\nSimilar to DuckDuckGo and Tavily, we'd love to make [You.com's](https://you.com/apis) search technology available to developers via Pydantic AI.\n\nSimilar to perplexity or chatgpt + web search, we have a consumer product that grounds LLM responses in our search results. Try it out for free at [you.com](https://you.com/)!\n \nrelated PR, adding Tavily: https://github.com/pydantic/pydantic-ai/pull/1001\nrelated issue: https://github.com/pydantic/pydantic-ai/issues/911\n\nIn a world where it is increasingly important to build applications that are highly aware of the world around us, we think that developers on your platform will find a lot of utility in our Search + other APIs. This is a priority for us - please let me know what I can do to help build this. I'm also happy to use the other PRs as references and open one myself! Thanks for reading  \n\n### References\n\n_No response_",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3746153924",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3986#issuecomment-3746153924",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986",
          "id": 3746153924,
          "node_id": "IC_kwDOMMa-Ps7fScXE",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-13T19:38:47Z",
          "updated_at": "2026-01-13T19:38:47Z",
          "body": "@itsakhilyou can I implement this is that's okay?",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3746153924/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-13T19:38:47Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5788054388",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3746076690",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3746076690",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3746076690,
          "node_id": "IC_kwDOMMa-Ps7fSJgS",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-13T19:27:10Z",
          "updated_at": "2026-01-13T19:27:10Z",
          "body": "@DouweM \n\nSo basically assign the current run_id to the messages returned by the history processor this way they'll be treated as new messages. \n \nLet me know I'll start working on the fix then.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3746076690/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-13T19:27:10Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5783631893",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 834595923,
        "name": "av/harbor",
        "url": "https://api.github.com/repos/av/harbor"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-13T16:15:00Z"
    },
    {
      "id": "5782997871",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 784425174,
        "name": "adam-maj/tiny-gpu",
        "url": "https://api.github.com/repos/adam-maj/tiny-gpu"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-13T15:50:32Z"
    },
    {
      "id": "5780721047",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1125591841,
        "name": "Universal-Commerce-Protocol/ucp",
        "url": "https://api.github.com/repos/Universal-Commerce-Protocol/ucp"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-13T14:28:10Z",
      "org": {
        "id": 243674901,
        "login": "Universal-Commerce-Protocol",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/Universal-Commerce-Protocol",
        "avatar_url": "https://avatars.githubusercontent.com/u/243674901?"
      }
    },
    {
      "id": "7429957644",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1115612558,
        "name": "madanlalit/personal-blog",
        "url": "https://api.github.com/repos/madanlalit/personal-blog"
      },
      "payload": {
        "repository_id": 1115612558,
        "push_id": 29725082020,
        "ref": "refs/heads/main",
        "head": "75f407ebca36ddac8daa0285eca390f009cdb64b",
        "before": "12c4846adcf7d028282c8c4228f409fa0a8926e5"
      },
      "public": true,
      "created_at": "2026-01-13T14:15:47Z"
    },
    {
      "id": "7427568539",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29722689367,
        "ref": "refs/heads/main",
        "head": "318d1d78b39a2a1bd6b868f375194cedb089310b",
        "before": "9543e74cf1f90d97c1631fb064969c51da303148"
      },
      "public": true,
      "created_at": "2026-01-13T13:00:29Z"
    },
    {
      "id": "5770475326",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1028492186,
        "name": "eigent-ai/eigent",
        "url": "https://api.github.com/repos/eigent-ai/eigent"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-13T07:34:30Z",
      "org": {
        "id": 163795819,
        "login": "eigent-ai",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/eigent-ai",
        "avatar_url": "https://avatars.githubusercontent.com/u/163795819?"
      }
    },
    {
      "id": "5767862717",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3986",
          "id": 3805686003,
          "node_id": "I_kwDOMMa-Ps7i1ijz",
          "number": 3986,
          "title": "Add You.com as a web search tool",
          "user": {
            "login": "itsakhilyou",
            "id": 215518986,
            "node_id": "U_kgDODNiPCg",
            "avatar_url": "https://avatars.githubusercontent.com/u/215518986?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/itsakhilyou",
            "html_url": "https://github.com/itsakhilyou",
            "followers_url": "https://api.github.com/users/itsakhilyou/followers",
            "following_url": "https://api.github.com/users/itsakhilyou/following{/other_user}",
            "gists_url": "https://api.github.com/users/itsakhilyou/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/itsakhilyou/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/itsakhilyou/subscriptions",
            "organizations_url": "https://api.github.com/users/itsakhilyou/orgs",
            "repos_url": "https://api.github.com/users/itsakhilyou/repos",
            "events_url": "https://api.github.com/users/itsakhilyou/events{/privacy}",
            "received_events_url": "https://api.github.com/users/itsakhilyou/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547185,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/feature",
              "name": "feature",
              "color": "a2eeef",
              "default": false,
              "description": "New feature request, or PR implementing a feature (enhancement)"
            },
            {
              "id": 8096520310,
              "node_id": "LA_kwDOMMa-Ps8AAAAB4pcYdg",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/tools",
              "name": "tools",
              "color": "aaaaaa",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": null,
          "assignees": [],
          "milestone": null,
          "comments": 8,
          "created_at": "2026-01-12T19:28:40Z",
          "updated_at": "2026-01-14T15:16:35Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Description\n\nThe You.com Search API delivers highly recent and relevant, structured **web** and **news** results optimized for programmatic access. Designed for developers building AI applications like RAG systems, AI agents, knowledge bases, and data-driven applications. Our Search API returns clean, structured data with rich metadata, relevant snippets, and optional full-page content. Learn more here: https://docs.you.com/search/overview\n\nSimilar to DuckDuckGo and Tavily, we'd love to make [You.com's](https://you.com/apis) search technology available to developers via Pydantic AI.\n\nSimilar to perplexity or chatgpt + web search, we have a consumer product that grounds LLM responses in our search results. Try it out for free at [you.com](https://you.com/)!\n \nrelated PR, adding Tavily: https://github.com/pydantic/pydantic-ai/pull/1001\nrelated issue: https://github.com/pydantic/pydantic-ai/issues/911\n\nIn a world where it is increasingly important to build applications that are highly aware of the world around us, we think that developers on your platform will find a lot of utility in our Search + other APIs. This is a priority for us - please let me know what I can do to help build this. I'm also happy to use the other PRs as references and open one myself! Thanks for reading  \n\n### References\n\n_No response_",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3741955597",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3986#issuecomment-3741955597",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3986",
          "id": 3741955597,
          "node_id": "IC_kwDOMMa-Ps7fCbYN",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-13T05:01:55Z",
          "updated_at": "2026-01-13T05:01:55Z",
          "body": "Hope this helps - https://www.humai.blog/tavily-vs-exa-vs-perplexity-vs-you-com-the-complete-ai-search-api-comparison-2025/",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3741955597/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-13T05:01:55Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5761452785",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3740546696",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3740546696",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3740546696,
          "node_id": "IC_kwDOMMa-Ps7e9DaI",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-12T21:24:11Z",
          "updated_at": "2026-01-12T21:24:11Z",
          "body": "Let me know if this makes sense. The run_id is definitely an improvement over the previous approach.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3740546696/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-12T21:24:11Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5761431982",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3740543077",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3740543077",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3740543077,
          "node_id": "IC_kwDOMMa-Ps7e9Chl",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-12T21:23:02Z",
          "updated_at": "2026-01-12T21:23:02Z",
          "body": "@DouweM  \n\nSince a run_id is automatically attached to every ModelMessage (requests, responses, and tool calls) generated by the agent, the standard execution flow is already covered.\n\nThe critical edge case arises when a history_processor creates and returns entirely new ModelMessage objects that do not have a run_id.\n\nOur options are:\n\n- Enforce run_id as a required field (a breaking change).\n- Automatically map the current run_id to orphaned messages (non-breaking solution).",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3740543077/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-12T21:23:02Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5761263072",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3740512491",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3740512491",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3740512491,
          "node_id": "IC_kwDOMMa-Ps7e87Dr",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-12T21:13:48Z",
          "updated_at": "2026-01-12T21:13:48Z",
          "body": "@DouweM What happens to the messages returned by the history processor without a run_id? When we append the next message, new_message_index is applied to it, and the previous messages will be treated as belonging to a previous run and is therefore not included.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3740512491/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-12T21:13:48Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7403634494",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29698718866,
        "ref": "refs/heads/main",
        "head": "9543e74cf1f90d97c1631fb064969c51da303148",
        "before": "73d3929b7307e8a5ffde9ccbf1eb442b13df584c"
      },
      "public": true,
      "created_at": "2026-01-12T19:33:14Z"
    },
    {
      "id": "7401025895",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132942317,
        "name": "madanlalit/agentskills",
        "url": "https://api.github.com/repos/madanlalit/agentskills"
      },
      "payload": {
        "repository_id": 1132942317,
        "push_id": 29696108693,
        "ref": "refs/heads/main",
        "head": "ef3a907d3758aac1e3a4275530ed8208df6bfc0c",
        "before": "0aca97fca81e12d365662e56e6484f1bfc6df9de"
      },
      "public": true,
      "created_at": "2026-01-12T17:49:24Z"
    },
    {
      "id": "5757032428",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3739727612",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3739727612",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3739727612,
          "node_id": "IC_kwDOMMa-Ps7e57b8",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-12T17:43:00Z",
          "updated_at": "2026-01-12T17:43:17Z",
          "body": "@DouweM Let me check this using the run_id and add bounds checking to ensure it doesnt go below zero. I can create a minimal reproducible example to test the behavior, then report back here. After your review, Ill implement whichever approach turns out to be correct.",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3739727612/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-12T17:43:00Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "7399644789",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132942317,
        "name": "madanlalit/agentskills",
        "url": "https://api.github.com/repos/madanlalit/agentskills"
      },
      "payload": {
        "ref": "main",
        "ref_type": "branch",
        "full_ref": "refs/heads/main",
        "master_branch": "main",
        "description": "A simple, focused repository of reusable skills for AI agents.",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-12T16:59:52Z"
    },
    {
      "id": "5755873483",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983",
          "id": 3804956826,
          "node_id": "I_kwDOMMa-Ps7iywia",
          "number": 3983,
          "title": "`new_messages()` returns wrong results when history processors prune messages from current run",
          "user": {
            "login": "aletar89",
            "id": 26358226,
            "node_id": "MDQ6VXNlcjI2MzU4MjI2",
            "avatar_url": "https://avatars.githubusercontent.com/u/26358226?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aletar89",
            "html_url": "https://github.com/aletar89",
            "followers_url": "https://api.github.com/users/aletar89/followers",
            "following_url": "https://api.github.com/users/aletar89/following{/other_user}",
            "gists_url": "https://api.github.com/users/aletar89/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aletar89/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aletar89/subscriptions",
            "organizations_url": "https://api.github.com/users/aletar89/orgs",
            "repos_url": "https://api.github.com/users/aletar89/repos",
            "events_url": "https://api.github.com/users/aletar89/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aletar89/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547176,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW6A",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/bug",
              "name": "bug",
              "color": "d73a4a",
              "default": true,
              "description": "Report that something isn't working, or PR implementing a fix"
            },
            {
              "id": 9959584364,
              "node_id": "LA_kwDOMMa-Ps8AAAACUaMybA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/message%20history",
              "name": "message history",
              "color": "aaaaaa",
              "default": false,
              "description": null
            },
            {
              "id": 10119759180,
              "node_id": "LA_kwDOMMa-Ps8AAAACWy9FTA",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/community%20contribution",
              "name": "community contribution",
              "color": "fbca04",
              "default": false,
              "description": ""
            }
          ],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7",
            "html_url": "https://github.com/pydantic/pydantic-ai/milestone/7",
            "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/milestones/7/labels",
            "id": 14257601,
            "node_id": "MI_kwDOMMa-Ps4A2Y3B",
            "number": 7,
            "title": "2026-02",
            "description": "",
            "creator": {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            },
            "open_issues": 24,
            "closed_issues": 1,
            "state": "open",
            "created_at": "2025-12-01T15:51:30Z",
            "updated_at": "2026-02-02T17:32:39Z",
            "due_on": "2026-02-28T00:00:00Z",
            "closed_at": null
          },
          "comments": 22,
          "created_at": "2026-01-12T15:59:44Z",
          "updated_at": "2026-02-02T17:30:51Z",
          "closed_at": null,
          "type": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "### Initial Checks\n\n- [x] I'm using the [latest version](https://github.com/pydantic/pydantic-ai/releases/latest) of Pydantic AI\n- [x] I've searched for my issue in [the issue tracker](https://github.com/pydantic/pydantic-ai/issues) before opening this issue\n\n### Description\n\n## Bug\n\nWhen a history processor removes messages created during the current run, `new_messages()` returns incorrect results. The internal `new_message_index` becomes negative, causing Python's negative indexing to silently return a subset of messages instead of all new messages.\n\n**Expected:** `new_messages()` returns all messages created during this run.\n**Actual:** Returns only the last N messages (where N depends on how many were pruned).\n\n## Example\n\nStarting fresh with `new_message_index = 0` and a history processor that keeps only the last 4 messages.\n\n**After 6 messages (pruning kicks in):**\n```python\nmessage_history = [new1, new2, new3, new4, new5, new6]\nnew_message_index = 0\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new3, new4, new5, new6]\nlen(after_processing) = 4\nnew_message_index = 0 - (6-4) = -2\n\nnew_messages() = message_history[-2:] = [new5, new6]   (should be all 6)\n```\n\n**After 8 messages:**\n```python\nmessage_history = [new3, new4, new5, new6, new7, new8]\nnew_message_index = -2\nlen(before_processing) = 6\nmessage_history = processor(message_history) = [new5, new6, new7, new8]\nlen(after_processing) = 4\nnew_message_index = -2 - (6-4) = -4\n\nnew_messages() = message_history[-4:] = [new5, new6, new7, new8]  \n```\n\nThe index keeps decreasing: `0  -2  -4  -6  ...`\n\n## Impact\n\nThe documented pattern is to use `new_messages()` to get messages from the current run and append them to your own copy of the history. When `new_messages()` returns incorrect results, there's no reliable way to know which messages are new - they don't have unique IDs and the length of `new_messages()` is non-monotonic.\n\n## Root cause\n\nThe adjustment at `_agent_graph.py:495` assumes history processors only remove \"old\" messages from previous runs:\n\n```python\nnew_message_index -= len(history_before_processing) - len(history_after_processing)\n```\n\nWhen processors remove messages from the current run, this overshoots and makes the index negative. There's no bounds checking here or in `run.py:160` where `new_messages()` uses the index.\n\n## Reproduction\n\nSee attached script that demonstrates the issue with a `keep_last_4` history processor and a `FunctionModel`.\n\n\n### Minimal, Reproducible Example\n\n```Python\n\"\"\"\nMinimal reproduction: new_message_index goes negative with history processors.\n\nWhen a history_processor removes messages added during the CURRENT run,\nnew_message_index goes negative. This causes new_messages() to use\nPython negative indexing, returning wrong results.\n\nRun with: uv run python pydantic-ai-new-message-index-bug.py\n\"\"\"\n\nimport asyncio\n\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.messages import ModelMessage, ModelResponse, ToolCallPart, TextPart\nfrom pydantic_ai.models.function import AgentInfo, FunctionModel\n\n\ndef keep_last_4(messages: list[ModelMessage]) -> list[ModelMessage]:\n    \"\"\"Keep only last 4 messages.\"\"\"\n    return messages[-4:] if len(messages) > 4 else messages\n\n\ncall_count = 0\n\n\nasync def mock_model(messages: list[ModelMessage], info: AgentInfo) -> ModelResponse:\n    global call_count\n    call_count += 1\n    if call_count < 5:\n        return ModelResponse(parts=[ToolCallPart(tool_name=\"my_tool\", args={\"i\": call_count})])\n    return ModelResponse(parts=[TextPart(content=\"done\")])\n\n\nagent = Agent(\n    model=FunctionModel(mock_model),\n    history_processors=[keep_last_4],\n)\n\n\n@agent.tool\nasync def my_tool(ctx: RunContext[None], i: int) -> str:\n    return f\"ok-{i}\"\n\n\ndef summarize_message(msg: ModelMessage) -> str:\n    \"\"\"One-line summary of a message.\"\"\"\n    from pydantic_ai.messages import ModelRequest\n    parts = []\n    for p in msg.parts:\n        name = type(p).__name__\n        if hasattr(p, \"args\"):\n            parts.append(f\"{name}({p.args})\")\n        elif hasattr(p, \"content\"):\n            content = p.content[:20] if isinstance(p.content, str) else p.content\n            parts.append(f\"{name}({content!r})\")\n        else:\n            parts.append(name)\n    kind = \"Req\" if isinstance(msg, ModelRequest) else \"Resp\"\n    return f\"{kind}[{', '.join(parts)}]\"\n\n\nasync def main():\n    async with agent.iter(user_prompt=\"go\") as run:\n        async for node in run:\n            idx = run.ctx.deps.new_message_index\n            all_msgs = run.all_messages()\n            new_msgs = run.new_messages()\n            all_summary = \", \".join(summarize_message(m) for m in all_msgs)\n            new_summary = \", \".join(summarize_message(m) for m in new_msgs)\n            print(f\"\\n{type(node).__name__:20} new_message_index={idx}\")\n            print(f\"  all_messages ({len(all_msgs)}): [{all_summary}]\")\n            print(f\"  new_messages ({len(new_msgs)}): [{new_summary}]\")\n\n\nasyncio.run(main())\n```\n\n### Logfire Trace\n\n_No response_\n\n### Python, Pydantic AI & LLM client version\n\n- Python: 3.12\n- Pydantic AI: 1.41.0\n- LLM provider SDK: Anthropic (not relevant)\n",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3739517237",
          "html_url": "https://github.com/pydantic/pydantic-ai/issues/3983#issuecomment-3739517237",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3983",
          "id": 3739517237,
          "node_id": "IC_kwDOMMa-Ps7e5IE1",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-12T16:51:37Z",
          "updated_at": "2026-01-12T16:51:37Z",
          "body": "@DouweM can i work on this?",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3739517237/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-12T16:51:37Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5742776812",
      "type": "IssuesEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "assigned",
        "issue": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/issues/5",
          "repository_url": "https://api.github.com/repos/madanlalit/heimdall",
          "labels_url": "https://api.github.com/repos/madanlalit/heimdall/issues/5/labels{/name}",
          "comments_url": "https://api.github.com/repos/madanlalit/heimdall/issues/5/comments",
          "events_url": "https://api.github.com/repos/madanlalit/heimdall/issues/5/events",
          "html_url": "https://github.com/madanlalit/heimdall/issues/5",
          "id": 3764452282,
          "node_id": "I_kwDOQuIaMM7gYPu6",
          "number": 5,
          "title": "Add Google Gemini LLM Provider Support",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [],
          "state": "open",
          "locked": false,
          "assignee": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "madanlalit",
              "id": 116655920,
              "node_id": "U_kgDOBvQHMA",
              "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/madanlalit",
              "html_url": "https://github.com/madanlalit",
              "followers_url": "https://api.github.com/users/madanlalit/followers",
              "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
              "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
              "organizations_url": "https://api.github.com/users/madanlalit/orgs",
              "repos_url": "https://api.github.com/users/madanlalit/repos",
              "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
              "received_events_url": "https://api.github.com/users/madanlalit/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 0,
          "created_at": "2025-12-27T06:13:37Z",
          "updated_at": "2026-01-12T07:35:05Z",
          "closed_at": null,
          "active_lock_reason": null,
          "sub_issues_summary": {
            "total": 0,
            "completed": 0,
            "percent_completed": 0
          },
          "issue_dependencies_summary": {
            "blocked_by": 0,
            "total_blocked_by": 0,
            "blocking": 0,
            "total_blocking": 0
          },
          "body": "Add support for Google Gemini as an LLM provider.\n\n**Location:** `src/heimdall/agent/llm/`\n\n**Tasks:**\n- Create `google.py` with `GoogleClient`\n- Register in provider registry\n",
          "reactions": {
            "url": "https://api.github.com/repos/madanlalit/heimdall/issues/5/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/madanlalit/heimdall/issues/5/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "assignee": {
          "login": "madanlalit",
          "id": 116655920,
          "node_id": "U_kgDOBvQHMA",
          "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/madanlalit",
          "html_url": "https://github.com/madanlalit",
          "followers_url": "https://api.github.com/users/madanlalit/followers",
          "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
          "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
          "organizations_url": "https://api.github.com/users/madanlalit/orgs",
          "repos_url": "https://api.github.com/users/madanlalit/repos",
          "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
          "received_events_url": "https://api.github.com/users/madanlalit/received_events",
          "type": "User",
          "user_view_type": "public",
          "site_admin": false
        },
        "assignees": [
          {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          }
        ]
      },
      "public": true,
      "created_at": "2026-01-12T07:35:06Z"
    },
    {
      "id": "5742772547",
      "type": "PullRequestEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "action": "opened",
        "number": 23,
        "pull_request": {
          "url": "https://api.github.com/repos/madanlalit/heimdall/pulls/23",
          "id": 3164799604,
          "number": 23,
          "head": {
            "ref": "feature/google-gemini-provider",
            "sha": "5e08e0a6d3b0c7cb642866b19a97b6619ceb8193",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          },
          "base": {
            "ref": "main",
            "sha": "07de9819615141b4fc453e6264460e0fb2fdfb99",
            "repo": {
              "id": 1122114096,
              "url": "https://api.github.com/repos/madanlalit/heimdall",
              "name": "heimdall"
            }
          }
        }
      },
      "public": true,
      "created_at": "2026-01-12T07:34:51Z"
    },
    {
      "id": "7383798201",
      "type": "CreateEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1122114096,
        "name": "madanlalit/heimdall",
        "url": "https://api.github.com/repos/madanlalit/heimdall"
      },
      "payload": {
        "ref": "feature/google-gemini-provider",
        "ref_type": "branch",
        "full_ref": "refs/heads/feature/google-gemini-provider",
        "master_branch": "main",
        "description": "The all-seeing agent for web automation.",
        "pusher_type": "user"
      },
      "public": true,
      "created_at": "2026-01-12T07:34:28Z"
    },
    {
      "id": "5742686522",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1132046564,
        "name": "Dimillian/CodexMonitor",
        "url": "https://api.github.com/repos/Dimillian/CodexMonitor"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-12T07:30:05Z"
    },
    {
      "id": "7383367629",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1121495867,
        "name": "madanlalit/exo",
        "url": "https://api.github.com/repos/madanlalit/exo"
      },
      "payload": {
        "repository_id": 1121495867,
        "push_id": 29678438489,
        "ref": "refs/heads/main",
        "head": "b74a61053711db043e0ce32aee0ab977c2b45bc2",
        "before": "1c1792f5e85eaeebe6d9eb8bde654474b5d27271"
      },
      "public": true,
      "created_at": "2026-01-12T07:13:39Z"
    },
    {
      "id": "7383357804",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1120983781,
        "name": "madanlalit/langchain",
        "url": "https://api.github.com/repos/madanlalit/langchain"
      },
      "payload": {
        "repository_id": 1120983781,
        "push_id": 29678428607,
        "ref": "refs/heads/master",
        "head": "2ef23882d236a4b03d5d14c57b07dce4ca90640f",
        "before": "6a416c618655102847a59cae280348c0712cf45c"
      },
      "public": true,
      "created_at": "2026-01-12T07:13:08Z"
    },
    {
      "id": "5732821328",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 942114501,
        "name": "camel-ai/owl",
        "url": "https://api.github.com/repos/camel-ai/owl"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:45:49Z",
      "org": {
        "id": 134388954,
        "login": "camel-ai",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/camel-ai",
        "avatar_url": "https://avatars.githubusercontent.com/u/134388954?"
      }
    },
    {
      "id": "5732815535",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 614765452,
        "name": "Significant-Gravitas/AutoGPT",
        "url": "https://api.github.com/repos/Significant-Gravitas/AutoGPT"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:45:04Z",
      "org": {
        "id": 130738209,
        "login": "Significant-Gravitas",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/Significant-Gravitas",
        "avatar_url": "https://avatars.githubusercontent.com/u/130738209?"
      }
    },
    {
      "id": "5732799644",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 599547518,
        "name": "vllm-project/vllm",
        "url": "https://api.github.com/repos/vllm-project/vllm"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:43:07Z",
      "org": {
        "id": 136984999,
        "login": "vllm-project",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/vllm-project",
        "avatar_url": "https://avatars.githubusercontent.com/u/136984999?"
      }
    },
    {
      "id": "5732788982",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 136202695,
        "name": "mlflow/mlflow",
        "url": "https://api.github.com/repos/mlflow/mlflow"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:41:57Z",
      "org": {
        "id": 39938107,
        "login": "mlflow",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/mlflow",
        "avatar_url": "https://avatars.githubusercontent.com/u/39938107?"
      }
    },
    {
      "id": "5732749815",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 790713784,
        "name": "pydantic/logfire",
        "url": "https://api.github.com/repos/pydantic/logfire"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:37:59Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5732725980",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1021621499,
        "name": "batrachianai/toad",
        "url": "https://api.github.com/repos/batrachianai/toad"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:35:33Z",
      "org": {
        "id": 248717333,
        "login": "batrachianai",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/batrachianai",
        "avatar_url": "https://avatars.githubusercontent.com/u/248717333?"
      }
    },
    {
      "id": "5732716305",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 355959597,
        "name": "Textualize/textual",
        "url": "https://api.github.com/repos/Textualize/textual"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T14:34:23Z",
      "org": {
        "id": 93378883,
        "login": "Textualize",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/Textualize",
        "avatar_url": "https://avatars.githubusercontent.com/u/93378883?"
      }
    },
    {
      "id": "5730099377",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1129759677,
        "name": "snarktank/ralph",
        "url": "https://api.github.com/repos/snarktank/ralph"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T07:12:26Z"
    },
    {
      "id": "5730097446",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 931888694,
        "name": "cjpais/Handy",
        "url": "https://api.github.com/repos/cjpais/Handy"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T07:12:00Z"
    },
    {
      "id": "5729595223",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T05:34:08Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    },
    {
      "id": "5729267050",
      "type": "WatchEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 819554665,
        "name": "exo-explore/exo",
        "url": "https://api.github.com/repos/exo-explore/exo"
      },
      "payload": {
        "action": "started"
      },
      "public": true,
      "created_at": "2026-01-11T04:18:02Z",
      "org": {
        "id": 162823259,
        "login": "exo-explore",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/exo-explore",
        "avatar_url": "https://avatars.githubusercontent.com/u/162823259?"
      }
    },
    {
      "id": "7336975115",
      "type": "PushEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 1131286423,
        "name": "madanlalit/pydantic-ai",
        "url": "https://api.github.com/repos/madanlalit/pydantic-ai"
      },
      "payload": {
        "repository_id": 1131286423,
        "push_id": 29631976288,
        "ref": "refs/heads/feat/custom-cdn-url",
        "head": "70b21438240318d606fcc8493d9b9c657d7070ec",
        "before": "d24478a576ed7fb9ac7fc401ec9a208af7c5c365"
      },
      "public": true,
      "created_at": "2026-01-09T21:45:45Z"
    },
    {
      "id": "5716093424",
      "type": "IssueCommentEvent",
      "actor": {
        "id": 116655920,
        "login": "madanlalit",
        "display_login": "madanlalit",
        "gravatar_id": "",
        "url": "https://api.github.com/users/madanlalit",
        "avatar_url": "https://avatars.githubusercontent.com/u/116655920?"
      },
      "repo": {
        "id": 818331198,
        "name": "pydantic/pydantic-ai",
        "url": "https://api.github.com/repos/pydantic/pydantic-ai"
      },
      "payload": {
        "action": "created",
        "issue": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974",
          "repository_url": "https://api.github.com/repos/pydantic/pydantic-ai",
          "labels_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/labels{/name}",
          "comments_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/comments",
          "events_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/events",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974",
          "id": 3798319157,
          "node_id": "PR_kwDOMMa-Ps68ZvWM",
          "number": 3974,
          "title": "feat(ui): Add `html_source` parameter to customize Chat UI source",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "labels": [
            {
              "id": 7110547185,
              "node_id": "LA_kwDOMMa-Ps8AAAABp9JW8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/feature",
              "name": "feature",
              "color": "a2eeef",
              "default": false,
              "description": "New feature request, or PR implementing a feature (enhancement)"
            },
            {
              "id": 8039999985,
              "node_id": "LA_kwDOMMa-Ps8AAAAB3zip8Q",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/awaiting%20author%20revision",
              "name": "awaiting author revision",
              "color": "295DD7",
              "default": false,
              "description": ""
            },
            {
              "id": 9953318447,
              "node_id": "LA_kwDOMMa-Ps8AAAACUUOWLw",
              "url": "https://api.github.com/repos/pydantic/pydantic-ai/labels/uiadapter",
              "name": "uiadapter",
              "color": "aaaaaa",
              "default": false,
              "description": null
            }
          ],
          "state": "closed",
          "locked": false,
          "assignee": {
            "login": "DouweM",
            "id": 159434,
            "node_id": "MDQ6VXNlcjE1OTQzNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/DouweM",
            "html_url": "https://github.com/DouweM",
            "followers_url": "https://api.github.com/users/DouweM/followers",
            "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
            "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
            "organizations_url": "https://api.github.com/users/DouweM/orgs",
            "repos_url": "https://api.github.com/users/DouweM/repos",
            "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
            "received_events_url": "https://api.github.com/users/DouweM/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "assignees": [
            {
              "login": "DouweM",
              "id": 159434,
              "node_id": "MDQ6VXNlcjE1OTQzNA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/159434?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/DouweM",
              "html_url": "https://github.com/DouweM",
              "followers_url": "https://api.github.com/users/DouweM/followers",
              "following_url": "https://api.github.com/users/DouweM/following{/other_user}",
              "gists_url": "https://api.github.com/users/DouweM/gists{/gist_id}",
              "starred_url": "https://api.github.com/users/DouweM/starred{/owner}{/repo}",
              "subscriptions_url": "https://api.github.com/users/DouweM/subscriptions",
              "organizations_url": "https://api.github.com/users/DouweM/orgs",
              "repos_url": "https://api.github.com/users/DouweM/repos",
              "events_url": "https://api.github.com/users/DouweM/events{/privacy}",
              "received_events_url": "https://api.github.com/users/DouweM/received_events",
              "type": "User",
              "user_view_type": "public",
              "site_admin": false
            }
          ],
          "milestone": null,
          "comments": 5,
          "created_at": "2026-01-09T20:51:39Z",
          "updated_at": "2026-01-31T00:22:26Z",
          "closed_at": "2026-01-31T00:20:30Z",
          "type": null,
          "active_lock_reason": null,
          "draft": false,
          "pull_request": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/pulls/3974",
            "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974",
            "diff_url": "https://github.com/pydantic/pydantic-ai/pull/3974.diff",
            "patch_url": "https://github.com/pydantic/pydantic-ai/pull/3974.patch",
            "merged_at": "2026-01-31T00:20:30Z"
          },
          "body": "## Description\n\nAdds a `custom_cdn_url` parameter to the Web Chat UI to allow users to override the default CDN URL. This supports:\n1.  **Custom CDNs**: For enterprise environments where the default CDN is blocked.\n2.  **Static URLs**: For pre-deployed versions of the UI.\n3.  **Local File Paths**: For working offline or with local development builds of the UI.\n\nFixes #3953\n\n## Changes\n\n- Modified `pydantic_ai/ui/_web/app.py` to accept `custom_cdn_url` and handle local file paths.\n- Updated `pydantic_ai/agent/__init__.py` to expose the parameter in `Agent.to_web()`.\n- Updated `pydantic_ai/_cli/web.py` and `pydantic_ai/_cli/__init__.py` to add the `--custom-cdn-url` CLI argument.\n- Added comprehensive tests in `tests/test_ui_web.py` covering all new scenarios.\n- Updated documentation in `docs/web.md` and `docs/cli.md`.\n\n## Checklist\n\n- [x] Any **AI generated code** has been reviewed line-by-line by the human PR author, who stands by it.\n- [x] No **breaking changes** (parameter is optional and defaults to `None`).\n- [x] **Linting and type checking** pass.\n- [x] **PR title** is fit for the release changelog.\n- [x] New **tests** added, maintaining 100% coverage.\n- [x] Updated **documentation** for new features.",
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "timeline_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974/timeline",
          "performed_via_github_app": null,
          "state_reason": null
        },
        "comment": {
          "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3730535886",
          "html_url": "https://github.com/pydantic/pydantic-ai/pull/3974#issuecomment-3730535886",
          "issue_url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/3974",
          "id": 3730535886,
          "node_id": "IC_kwDOMMa-Ps7eW3XO",
          "user": {
            "login": "madanlalit",
            "id": 116655920,
            "node_id": "U_kgDOBvQHMA",
            "avatar_url": "https://avatars.githubusercontent.com/u/116655920?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/madanlalit",
            "html_url": "https://github.com/madanlalit",
            "followers_url": "https://api.github.com/users/madanlalit/followers",
            "following_url": "https://api.github.com/users/madanlalit/following{/other_user}",
            "gists_url": "https://api.github.com/users/madanlalit/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/madanlalit/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/madanlalit/subscriptions",
            "organizations_url": "https://api.github.com/users/madanlalit/orgs",
            "repos_url": "https://api.github.com/users/madanlalit/repos",
            "events_url": "https://api.github.com/users/madanlalit/events{/privacy}",
            "received_events_url": "https://api.github.com/users/madanlalit/received_events",
            "type": "User",
            "user_view_type": "public",
            "site_admin": false
          },
          "created_at": "2026-01-09T20:53:30Z",
          "updated_at": "2026-01-09T20:53:30Z",
          "body": "Hi @DouweM,\r\ncould you please review this PR?",
          "pin": null,
          "reactions": {
            "url": "https://api.github.com/repos/pydantic/pydantic-ai/issues/comments/3730535886/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
          },
          "performed_via_github_app": null
        }
      },
      "public": true,
      "created_at": "2026-01-09T20:53:30Z",
      "org": {
        "id": 110818415,
        "login": "pydantic",
        "gravatar_id": "",
        "url": "https://api.github.com/orgs/pydantic",
        "avatar_url": "https://avatars.githubusercontent.com/u/110818415?"
      }
    }
  ]
}